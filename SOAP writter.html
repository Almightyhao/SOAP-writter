<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧藥師 SOAP 筆記產生器 (v10 - 本地版)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* 載入狀態的 spinner 動畫 */
        .spinner {
            border-top-color: transparent;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 增加 prose 中 pre 的可讀性 */
        .prose pre {
            background-color: #f9fafb; /* bg-gray-50 */
            color: #1f2937; /* text-gray-800 */
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        /* 查詢列表的樣式 */
        #guidelineList li {
            padding: 4px 0;
            border-bottom: 1px solid #f3f4f6; /* border-gray-100 */
        }
        #guidelineList li:last-child {
            border-bottom: none;
        }
        /* (v10 新增) 說明區塊的樣式 */
        details summary {
            cursor: pointer;
            font-weight: 600;
            color: #1d4ed8; /* text-blue-700 */
        }
        details summary:hover {
            text-decoration: underline;
        }
        .instruction-step {
            margin-top: 1rem;
        }
        .instruction-step h4 {
            font-weight: 600;
            color: #1f2937; /* text-gray-800 */
        }
        .instruction-step p {
            font-size: 0.95rem;
            color: #374151; /* text-gray-700 */
        }
        .instruction-step code {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #c026d3; /* text-fuchsia-700 */
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 py-8">
        <!-- 標題 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">智慧藥師 SOAP 筆記產生器 (v10)</h1>
            <p class="mt-2 text-lg text-gray-600">自動查核、引用並在最下方「總結」所用的指引年份。</p>
        </header>

        <!-- (v10 新增：API 金鑰設定區塊) -->
        <section class="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-blue-600">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">連線設定 (僅需設定一次)</h2>
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="flex-grow">
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-600 mb-2">Google Gemini API 金鑰</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請貼上您的 Google Gemini API 金鑰">
                </div>
                <button id="saveApiKeyButton" class="bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out mt-1 md:mt-0">
                    儲存金鑰
                </button>
            </div>
            <p id="apiKeyStatus" class="text-sm mt-3 text-gray-500">狀態：尚未設定。金鑰將儲存在您的瀏覽器 (localStorage) 中。</p>
        </section>


        <!-- (v7 功能：即時指引查詢區塊) -->
        <section class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">AI 知識庫即時狀態</h2>
            <p class="text-sm text-gray-600 mb-4">
                本工具的 AI 會在「每次」產生筆記時，針對病症即時搜尋最新的指引。您也可以點擊下方按鈕，主動查詢目前常見指引的最新版本。
            </p>
            <button id="queryGuidelinesButton" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center justify-center">
                <div id="guidelineSpinner" class="spinner border-4 border-white rounded-full mr-3 hidden"></div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                </svg>
                即時查詢主要指引版本
            </button>

            <!-- 查詢結果顯示區 -->
            <div id="guidelineListContainer" class="mt-4 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">即時查詢結果：</h3>
                <ul id="guidelineList" class="text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <!-- 查詢結果將動態插入這裡 -->
                </ul>
            </div>
        </section>


        <!-- 主內容區塊：分為輸入和輸出 -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- 左側：輸入區塊 -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. 輸入病患資料</h2>

                <!-- 病患資訊輸入 -->
                <div>
                    <label for="patientInfo" class="block text-sm font-medium text-gray-600 mb-2">
                        病患資訊
                        <span class="text-xs text-gray-500">(例如：主訴、病史、診斷、實驗室數據、目前用藥...)</span>
                    </label>
                    <textarea id="patientInfo" rows="25" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請貼入病患的相關資訊..."></textarea>
                </div>

                <!-- 產生按鈕 -->
                <button id="generateButton" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center justify-center">
                    <!-- 載入狀態的 spinner (預設隱藏) -->
                    <div id="loadingSpinner" class="spinner border-4 border-white rounded-full mr-3 hidden"></div>
                    產生 SOAP 筆記
                </button>
            </div>

            <!-- 右側：輸出區塊 -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. 產生的筆記草稿</h2>
                
                <!-- 提示訊息 -->
                <div id="placeholder" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-lg">
                    <p>AI 將自動**搜尋並查核**該病症的**「最新實際年份」**指引（例如 GINA 2024, GOLD 2025, AHA 2017...）。</p>
                    <p class="mt-2">DDI 分析將使用 Gemini 深度研究功能。</p>
                    <p class="text-sm mt-4">所有內容均需由專業藥師最終審核。</p>
                </div>

                <!-- 輸出結果顯示區 -->
                <div id="output" class="hidden prose max-w-none whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 200px;"></div>

                <!-- 功能說明區塊 -->
                <div id="infoBox" class="hidden mt-4 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg">
                    <h4 class="font-bold text-sm">AI 輔助說明：</h4>
                    <ul class="list-disc list-inside text-sm mt-1">
                        <li>**最新指引：** AI 已被指示在「Assessment」中**必須註明**所參考指引的**「實際年份」**。</li>
                        <li>**DDI 分析：** 藥物交互作用 (DDI) 評估已使用 Gemini 深度研究功能完成。</li>
                        <li>**專業審核：** 內容僅供參考，請務必由您進行最終的專業審核與修改。</li>
                    </ul>
                </div>

                <!-- 參考指引 (動態顯示) -->
                <div id="sourcesContainer" class="hidden mt-6">
                    <h3 id="sourcesTitle" class="text-lg font-semibold text-gray-600 mb-2">引用的指引與參考來源：</h3>
                    <ul id="sourcesList" class="list-none list-inside text-sm space-y-1">
                        <!-- 
                          這裡將顯示 AI 總結的清單 (粗體)，
                          以及 Google 搜尋到的連結 (藍色) 
                        -->
                    </ul>
                </div>
            </div>
        </main>

        <!-- (v10 新增：詳細使用說明) -->
        <section class="bg-white p-6 rounded-xl shadow-lg mt-6">
            <details>
                <summary class="text-xl">如何取得與使用 API 金鑰？</summary>
                <div class="mt-4 prose max-w-none">
                    <p>
                        這個工具需要「Google Gemini API 金鑰」才能啟動 AI 大腦並連線到 Google 搜尋。這是一把專屬於您的鑰匙。
                        <br>
                        這個金鑰**只會**儲存在您當前的瀏覽器 (<code>localStorage</code>) 中，不會上傳到任何伺服器，因此非常安全。
                    </p>
                    
                    <div class="instruction-step">
                        <h4>步驟 1：前往 Google AI Studio</h4>
                        <p>
                            點擊此連結 <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">https://aistudio.google.com/</a>，並使用您的 Google 帳號登入。
                        </p>
                    </div>
                    
                    <div class="instruction-step">
                        <h4>步驟 2：建立 API 金鑰</h4>
                        <p>
                            登入後，點擊頁面左側的「Get API key」(取得 API 金鑰)。
                            <br>
                            在下一個畫面中，點擊「Create API key in new project」(在新專案中建立 API 金鑰)。
                        </p>
                    </div>

                    <div class="instruction-step">
                        <h4>步驟 3：複製金鑰</h4>
                        <p>
                            畫面上會彈出一個視窗，顯示您新產生的金鑰（它是一長串隨機字母和數字，例如 <code>AIzaSy...</code>）。
                            <br>
                            請點擊它旁邊的「複製」按鈕。
                        </p>
                    </div>

                    <div class="instruction-step">
                        <h4>步驟 4：貼上並儲存</h4>
                        <p>
                            回到這個頁面，將您剛剛複製的金鑰，貼到最上方的「Google Gemini API 金鑰」輸入框中。
                            <br>
                            點擊「儲存金鑰」。
                        </p>
                    </div>
                    
                    <div class="instruction-step">
                        <h4>步驟 5：完成！</h4>
                        <p>
                            您現在可以開始使用這個工具了。金鑰已儲存，您下次重新整理或打開這個 HTML 檔案時，都不需要再重新輸入。
                        </p>
                    </div>
                </div>
            </details>
        </section>
    </div>

    <!-- 錯誤訊息 Modal (預設隱藏) -->
    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">發生錯誤</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="errorMessage" class="text-sm text-gray-500">無法產生筆記，請稍後再試。</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">關閉</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM 元素
        const generateButton = document.getElementById('generateButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const patientInfoInput = document.getElementById('patientInfo');
        const outputDiv = document.getElementById('output');
        const placeholderDiv = document.getElementById('placeholder');
        const infoBox = document.getElementById('infoBox');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');
        const sourcesTitle = document.getElementById('sourcesTitle');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeModalButton = document.getElementById('closeModalButton');
        const queryGuidelinesButton = document.getElementById('queryGuidelinesButton');
        const guidelineSpinner = document.getElementById('guidelineSpinner');
        const guidelineListContainer = document.getElementById('guidelineListContainer');
        const guidelineList = document.getElementById('guidelineList');

        // (v10 新增：API 金鑰 DOM)
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const apiKeyStatus = document.getElementById('apiKeyStatus');

        // (v10 修改) API 金鑰改為動態載入
        let apiKey = "";
        const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

        // (v10 新增：儲存 API 金鑰)
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                try {
                    localStorage.setItem('geminiApiKey', key);
                    apiKey = key;
                    apiKeyStatus.textContent = "狀態：金鑰已儲存並載入。";
                    apiKeyStatus.className = "text-sm mt-3 text-green-600";
                    apiKeyInput.value = ""; // 基於安全，清除輸入框
                } catch (e) {
                    apiKeyStatus.textContent = "狀態：無法儲存金鑰 (瀏覽器可能不支援 localStorage)。";
                    apiKeyStatus.className = "text-sm mt-3 text-red-600";
                    console.error("儲存 API 金鑰時發生錯誤:", e);
                }
            } else {
                apiKeyStatus.textContent = "狀態：請先輸入金鑰。";
                apiKeyStatus.className = "text-sm mt-3 text-red-600";
            }
        }

        // (v10 新增：載入 API 金鑰)
        function loadApiKey() {
            try {
                const storedKey = localStorage.getItem('geminiApiKey');
                if (storedKey) {
                    apiKey = storedKey;
                    apiKeyStatus.textContent = "狀態：已從瀏覽器載入金鑰。";
                    apiKeyStatus.className = "text-sm mt-3 text-green-600";
                } else {
                    apiKeyStatus.textContent = "狀態：尚未設定金鑰。請貼上金鑰並儲存。";
                    apiKeyStatus.className = "text-sm mt-3 text-red-600";
                }
            } catch (e) {
                apiKeyStatus.textContent = "狀態：無法載入金鑰 (瀏覽器可能不支援 localStorage)。";
                apiKeyStatus.className = "text-sm mt-3 text-red-600";
                console.error("載入 API 金鑰時發生錯誤:", e);
            }
        }

        // 頁面載入時自動執行
        document.addEventListener('DOMContentLoaded', loadApiKey);
        // 綁定儲存按鈕事件
        saveApiKeyButton.addEventListener('click', saveApiKey);


        // 顯示錯誤 Modal
        function showError(message) {
            // (v10 修改) 檢查 API 金鑰是否為空
            if (apiKey === "") {
                errorMessage.textContent = "API 金鑰尚未設定。請在最上方的「連線設定」區塊輸入並儲存您的金鑰。";
            } else {
                errorMessage.textContent = message || "發生未知的錯誤。";
            }
            errorModal.classList.remove('hidden');
        }

        // 隱藏錯誤 Modal
        closeModalButton.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });

        // 呼叫 Gemini API 的函數 (包含指數退避重試與 Google 搜尋)
        async function callGeminiAPI(systemPrompt, userPrompt) {
            // (v10 修改) 檢查 API 金鑰
            if (apiKey === "") {
                throw new Error("API 金鑰尚未設定。");
            }
            
            let retries = 3;
            let delay = 1000; // 1 秒

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                tools: [{ "google_search": {} }] 
            };
            
            // (v10 修改) 動態組合 API URL
            const apiUrl = apiUrlBase + apiKey;

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorBody = "無法讀取錯誤詳情";
                        try {
                            const errJson = await response.json();
                            errorBody = errJson.error?.message || JSON.stringify(errJson);
                            // (v10 修改) 增加對無效金鑰的特定錯誤處理
                            if (errorBody.includes("API key not valid")) {
                                errorBody = "API 金鑰無效。請檢查您的金鑰是否正確，或重新產生一把。";
                            }
                        } catch (e) { /* 忽略解析錯誤 */ }
                        throw new Error(`HTTP 錯誤! 狀態: ${response.status}. 詳情: ${errorBody}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        
                        const groundingMetadata = candidate.groundingMetadata; 
                        if (groundingMetadata && groundingMetadata.groundingAttributions) { 
                            sources = groundingMetadata.groundingAttributions
                                .map(attr => ({
                                    uri: attr.web?.uri,
                                    title: attr.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        return { text, sources };
                    } else {
                        console.error("API 回應格式錯誤或無內容:", result);
                        let errorMsg = "API 回應格式不正確。";
                        if (candidate?.finishReason === "SAFETY") {
                            errorMsg = "內容可能違反安全政策而被阻擋。";
                        } else if (result.promptFeedback?.blockReason) {
                            errorMsg = `請求被阻擋：${result.promptFeedback.blockReason}`;
                        } else if (!candidate) {
                             errorMsg = "API 未返回有效的候選答案。";
                        }
                        throw new Error(errorMsg);
                    }

                } catch (error) {
                    console.error(`API 呼叫失敗 (剩下 ${retries - 1} 次重試):`, error);
                    retries--;
                    if (retries === 0) {
                        throw new Error(error.message === "Failed to fetch" ? "Load failed (網路連線失敗)" : error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // (v7 功能：查詢指引按鈕)
        queryGuidelinesButton.addEventListener('click', async () => {
            // (v10 修改) 檢查 API 金鑰
            if (apiKey === "") {
                showError("請先設定 API 金鑰。");
                return;
            }

            // 設置 UI 為載入狀態
            guidelineSpinner.classList.remove('hidden');
            queryGuidelinesButton.disabled = true;
            queryGuidelinesButton.classList.add('opacity-70', 'cursor-not-allowed');
            guidelineList.innerHTML = ''; // 清空舊列表
            guidelineListContainer.classList.add('hidden');

            const guidelineQueryPrompt = `您是一位 AI 助手，任務是使用 Google 搜尋來**即時查核**以下常見臨床指引的「最新發布年份」。

您的回覆必須嚴格遵守以下格式，僅回傳列表，不要有任何前言或結語：
* [指引名稱] (例如：GINA - Asthma) - [最新年份]
* [指引名稱] (例如：GOLD - COPD) - [最新年份]
* [指引名稱] (例如：AHA/ACC - Hypertension) - [最新年份]
* [指引名稱] (例如：Surviving Sepsis Campaign) - [最新年份]
* [指引名稱] (例如：IDSA - Skin and Soft Tissue Infections) - [最新年份]
* [指引名稱] (例如：KDIGO - CKD) - [最新年份]
`;

            const userPrompt = "請立即使用 Google 搜尋，幫我查詢 GINA (Asthma), GOLD (COPD), AHA/ACC (Hypertension), Surviving Sepsis Campaign, IDSA (Skin and Soft Tissue Infections), 以及 KDIGO (CKD) 的最新指引發布年份。";

            try {
                const { text } = await callGeminiAPI(guidelineQueryPrompt, userPrompt);
                
                const lines = text.split('\n').filter(line => line.trim().length > 0);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        guidelineList.appendChild(li);
                    });
                    guidelineListContainer.classList.remove('hidden');
                } else {
                    throw new Error("AI 未返回有效的列表。");
                }

            } catch (error) {
                console.error("查詢指引時發生錯誤:", error);
                guidelineList.innerHTML = `<li class="text-red-600">查詢失敗：${error.message}</li>`;
                guidelineListContainer.classList.remove('hidden');
            } finally {
                guidelineSpinner.classList.add('hidden');
                queryGuidelinesButton.disabled = false;
                queryGuidelinesButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });


        // (v6 功能：產生 SOAP 筆記按鈕)
        generateButton.addEventListener('click', async () => {
            // (v10 修改) 檢查 API 金鑰
            if (apiKey === "") {
                showError("請先設定 API 金鑰。");
                return;
            }
            
            const patientInfo = patientInfoInput.value;

            if (!patientInfo.trim()) {
                showError("請輸入病患資訊。");
                return;
            }

            loadingSpinner.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            outputDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            infoBox.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';
            sourcesTitle.textContent = '引用的指引與參考來源：';

            const systemPrompt = `您是一位頂尖的臨床藥師，擁有豐富的經驗，並且隨時掌握最新的國際醫療指引。

您的任務是：
1.  仔細分析使用者提供的 [病患資訊]。
2.  自動識別出最相關的主要病症。
3.  (最重要) **使用 Google 搜尋來查找並確認**該病症**「實際的最新指引版本和年份」**。
    * 例如：搜尋 "latest GINA guideline update", "current GOLD report version", "AHA hypertension guideline latest year"。
    * 您必須理解，指引**並非每年更新**（例如 AHA 可能是 2017，GINA 可能是 2024，GOLD 可能是 2025）。您的目標是找到那個「實際的」年份。
4.  (重要) **請分析**病患目前用藥清單中的**潛在藥物交互作用 (DDI)** 或**重複用藥 (Duplicate Therapy)**。您可以使用 Google 搜尋來輔助驗證。
5.  根據「SOAP」格式，撰寫一份專業、精確的藥師筆記草稿。
6.  在您的「Assessment (A)」部分：
    * **必須明確提及您參考的指引名稱與「實際年份」** (例如："根據 GINA 2024 指引..." 或 "依據 Surviving Sepsis Campaign 2021 指引...")。
    * **必須包含**您對 DDI 或重複用藥的評估。
    * **必須包含**對腎功能 (eGFR) 的考量與劑量評估。
7.  在您的「Plan (P)」部分：
    * 您的所有建議都必須**符合**您在 (A) 中提到的最新指引。

8.  (*** v6 格式要求 ***)
    您的回覆**必須**嚴格遵守此格式：
    [完整的 SOAP 筆記 (S, O, A, P)]
    ---GUIDELINES_USED---
    * [指引 1 名稱] - [年份]
    * [指引 2 名稱] - [年份]
    * [其他參考的 DDI 資料庫或文獻]

    (請**不要**在分隔符之後包含 Google 搜尋的原始 URI，那些會由系統自動處理)。`;

            const userPrompt = `
--- 病患資訊 START ---
${patientInfo}
--- 病患資訊 END ---

請根據上述資訊，使用最新的國際指引產生一份藥師 SOAP 筆記。
`;

            try {
                const { text, sources } = await callGeminiAPI(systemPrompt, userPrompt); 
                
                const delimiter = '---GUIDELINES_USED---';
                let soapNote = text;
                let guidelinesText = '';
                let hasContent = false; 

                if (text.includes(delimiter)) {
                    const parts = text.split(delimiter);
                    soapNote = parts[0].trim();
                    guidelinesText = parts[1].trim();
                }
                
                outputDiv.textContent = soapNote;
                outputDiv.classList.remove('hidden');
                placeholderDiv.classList.add('hidden');
                infoBox.classList.remove('hidden');

                if (guidelinesText) {
                    const lines = guidelinesText.split('\n').filter(line => line.trim().length > 0);
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        li.className = 'text-gray-800 font-semibold'; 
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }

                if (sources && sources.length > 0) {
                    if (hasContent) {
                        const separator = document.createElement('li');
                        separator.innerHTML = '<hr class="my-2 border-gray-300">';
                        separator.setAttribute("aria-hidden", "true");
                        sourcesList.appendChild(separator);
                    }
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = source.uri;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.className = 'text-blue-600 hover:underline';
                        a.textContent = source.title || '相關參考文件';
                        li.appendChild(a);
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }
                
                if (hasContent) {
                    sourcesContainer.classList.remove('hidden');
                }

            } catch (error) {
                console.error("產生 SOAP 筆記時發生錯誤:", error);
                showError(`無法產生筆記：${error.message}`);
            } finally {
                loadingSpinner.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

    </script>
</body>
</html>

