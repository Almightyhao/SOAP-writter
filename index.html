<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v17.4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .spinner { border-top-color: transparent; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .prose pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; }
        #guidelineList li { padding: 4px 0; border-bottom: 1px solid #f3f4f6; }
        #guidelineList li:last-child { border-bottom: none; }
        details summary { cursor: pointer; font-weight: 600; color: #1f2937; background-color: #f9fafb; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; transition: background-color 0.2s; }
        details summary:hover { background-color: #f3f4f6; }
        details[open] summary { background-color: #f3f4f6; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .calculator-content { padding: 1rem; border: 1px solid #e5e7eb; border-top: 0; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: #ffffff; }
        .instruction-step { margin-top: 1rem; }
        .instruction-step h4 { font-weight: 600; color: #1f2937; }
        .instruction-step p { font-size: 0.95rem; color: #374151; }
        .instruction-step code { background-color: #f3f4f6; color: #c026d3; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        #progressBarContainer { display: none; width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 0.75rem; background-color: #3b82f6; border-radius: 9999px; animation: indeterminate-progress 2s linear infinite; }
        @keyframes indeterminate-progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .terms-section {
            background-color: #fffbeb; /* bg-yellow-50 */
            border: 1px solid #fcd34d; /* border-yellow-300 */
            color: #92400e; /* text-yellow-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .terms-section h3 {
            font-weight: 700; /* font-bold */
            color: #b45309; /* text-yellow-700 */
            display: flex;
            align-items: center;
        }
        .terms-section ul {
            list-style-type: decimal; /* æ•¸å­—åˆ—è¡¨ */
            margin-left: 1.5rem; /* ml-6 */
            font-size: 0.9rem; /* text-sm */
            margin-top: 0.5rem; /* mt-2 */
            line-height: 1.6; /* leading-relaxed */
        }
        .calc-button {
            background-color: #10b981; /* bg-emerald-500 */
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
        }
        .calc-button:hover {
            background-color: #059669; /* hover:bg-emerald-600 */
        }
        .calc-result {
            font-weight: 700;
            color: #1d4ed8; /* text-blue-700 */
            font-size: 1.125rem; /* text-lg */
            text-align: right;
            min-height: 28px; /* ç¢ºä¿æœ‰é«˜åº¦ */
        }
        /* v16.2: "ç„¡è³‡æ–™è¨ˆç®—" çš„æ¨£å¼ */
        .calc-result-nodata {
            font-weight: 500;
            color: #9ca3af; /* text-gray-400 */
            font-size: 0.9rem; /* text-sm */
            text-align: right;
            min-height: 28px;
        }
        .calc-label {
            display: block;
            text-sm;
            font-medium;
            color: #374151; /* text-gray-700 */
            margin-bottom: 0.5rem;
        }
        .calc-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            outline: none;
        }
        .calc-input:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px #bfdbfe; /* focus:ring-blue-200 */
        }
        .calc-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-color: white;
            outline: none;
        }
        .calc-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .calc-radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .calc-radio-label {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calc-radio-label input {
            margin-right: 0.5rem;
            color: #3b82f6;
        }
        .calc-radio-label:has(input:checked) {
            background-color: #eff6ff; /* bg-blue-50 */
            border-color: #3b82f6; /* border-blue-500 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v17.4)</h1>
            <p class="mt-2 text-lg text-gray-600">AI é©…å‹•çš„æŒ‡å¼•æŸ¥æ ¸ã€DDI åˆ†æèˆ‡ç­†è¨˜è‰ç¨¿</p>
        </header>

        <section class="bg-white p-6 rounded-xl shadow-xl mb-6 border-l-4 border-blue-500">
             <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                 é€£ç·šè¨­å®š (åƒ…éœ€è¨­å®šä¸€æ¬¡)
             </h2>
             <div class="flex flex-col md:flex-row md:items-center gap-4">
                 <div class="flex-grow">
                     <label for="apiKeyInput" class="block text-sm font-medium text-gray-600 mb-2">Google Gemini API é‡‘é‘°</label>
                     <input type="password" id="apiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Google Gemini API é‡‘é‘°">
                 </div>
                 <button id="saveApiKeyButton" class="bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 mt-1 md:mt-0">
                     å„²å­˜é‡‘é‘°
                 </button>
             </div>
             <p id="apiKeyStatus" class="text-sm mt-3 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚é‡‘é‘°å°‡å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ (localStorage) ä¸­ã€‚</p>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
             <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>
                 AI çŸ¥è­˜åº«å³æ™‚ç‹€æ…‹
             </h2>
             <p class="text-sm text-gray-600 mb-4">
                 AI æœƒåœ¨ã€Œæ¯æ¬¡ã€ç”¢ç”Ÿç­†è¨˜æ™‚å³æ™‚æœå°‹ã€‚æ‚¨ä¹Ÿå¯ä»¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œä¸»å‹•æŸ¥è©¢å¸¸è¦‹æŒ‡å¼•çš„æœ€æ–°ç‰ˆæœ¬ã€‚
             </p>
             <button id="queryGuidelinesButton" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 flex items-center justify-center">
                 <div id="guidelineSpinner" class="spinner border-4 border-white rounded-full mr-3 hidden"></div>
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                 </svg>
                 å³æ™‚æŸ¥è©¢ä¸»è¦æŒ‡å¼•ç‰ˆæœ¬
             </button>
             <div id="guidelineListContainer" class="mt-4 hidden">
                 <h3 class="text-lg font-semibold text-gray-800 mb-2">å³æ™‚æŸ¥è©¢çµæœï¼š</h3>
                 <ul id="guidelineList" class="text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200"></ul>
             </div>
        </section>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                        1. è¼¸å…¥ç—…æ‚£è³‡æ–™
                    </h2>
                    <button id="clearInputsButton" class="text-sm text-slate-500 hover:text-red-600 font-medium py-1 px-2 rounded-lg hover:bg-red-50 transition-all duration-200 hover:scale-105 hover:shadow-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        ä¸€éµæ¸…é™¤
                    </button>
                </div>

                <div class="mb-4">
                    <label for="specialtyFocus" class="block text-sm font-medium text-gray-600 mb-2">
                        å°ˆç§‘ç„¦é» (é¸å¡«)
                    </label>
                    <select id="specialtyFocus" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="" selected>ç„¡ç‰¹å®šç§‘åˆ¥ (ç¶œåˆè©•ä¼°)</option>
                        <option value="å¿ƒè‡Ÿå…§ç§‘">å¿ƒè‡Ÿå…§ç§‘ (Cardiology)</option>
                        <option value="èƒ¸è…”å…§ç§‘">èƒ¸è…”å…§ç§‘ (Pulmonology)</option>
                        <option value="è…è‡Ÿå…§ç§‘">è…è‡Ÿå…§ç§‘ (Nephrology)</option>
                        <option value="æ„ŸæŸ“ç§‘">æ„ŸæŸ“ç§‘ (Infectious Disease)</option>
                        <option value="æ–°é™³ä»£è¬ç§‘">æ–°é™³ä»£è¬ç§‘ (Metabolism)</option>
                        <option value="é¢¨æ¿•å…ç–«ç§‘">é¢¨æ¿•å…ç–«ç§‘ (Rheumatology)</option>
                        <option value="è¡€æ¶²è…«ç˜¤ç§‘">è¡€æ¶²è…«ç˜¤ç§‘ (Hemato-Oncology)</option>
                        <option value="è…¸èƒƒè‚è†½ç§‘">è…¸èƒƒè‚è†½ç§‘ (Gastroenterology)</option>
                        <option value="ç¥ç¶“å…§ç§‘">ç¥ç¶“å…§ç§‘ (Neurology)</option>
                        <option value="åŠ è­·ç—…æˆ¿">åŠ è­·ç—…æˆ¿ (ICU)</option>
                    </select>
                </div>

                <div class="space-y-4 mb-4">
                    
                    <details>
                        <summary class="flex justify-between items-center">
                            <span>1. CrCl (C-G) & IBW/ABW è¨ˆç®— (é¸å¡«)</span>
                            <span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span>
                        </summary>
                        <div class="calculator-content space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="calcSex" class="calc-label">æ€§åˆ¥</label>
                                    <select id="calcSex" class="calc-select">
                                        <option value="Male">ç”·æ€§</option>
                                        <option value="Female">å¥³æ€§</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="calcAge" class="calc-label">å¹´é½¡ (years)</label>
                                    <input type="number" id="calcAge" class="calc-input" placeholder="ä¾‹å¦‚: 70">
                                </div>
                                <div>
                                    <label for="calcWeight" class="calc-label">é«”é‡ (kg)</label>
                                    <input type="number" id="calcWeight" class="calc-input" placeholder="ä¾‹å¦‚: 65">
                                </div>
                                <div>
                                    <label for="calcHeight" class="calc-label">èº«é«˜ (cm)</label>
                                    <input type="number" id="calcHeight" class="calc-input" placeholder="ä¾‹å¦‚: 170">
                                </div>
                                <div>
                                    <label for="calcScr" class="calc-label">è¡€æ¸…è‚Œé…¸é… (SCr, mg/dL)</label>
                                    <input type="number" id="calcScr" class="calc-input" placeholder="ä¾‹å¦‚: 1.2">
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="calculateCrClBwButton" class="calc-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h3m6 9a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    è¨ˆç®— CrCl & IBW/ABW
                                </button>
                                <div class="text-right">
                                    <span id="crclResult" class="calc-result block" data-value=""></span>
                                    <span id="bwResult" class="calc-result block" data-value=""></span>
                                </div>
                            </div>
                        </div>
                    </details>

                    <details>
                        <summary class="flex justify-between items-center">
                            <span>2. CHAâ‚‚DSâ‚‚-VASc é¢¨éšªè¨ˆç®— (é¸å¡«)</span>
                            <span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span>
                        </summary>
                        <div class="calculator-content space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <fieldset>
                                    <legend class="calc-label">å¹´é½¡ (Age)</legend>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input id="c2vAge<65" name="c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="0" checked>
                                            <label for="c2vAge<65" class="ml-2 block text-sm text-gray-900">&lt; 65 æ­² (0 åˆ†)</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="c2vAge65-74" name="c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="1">
                                            <label for="c2vAge65-74" class="ml-2 block text-sm text-gray-900">65-74 æ­² (+1 åˆ†)</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="c2vAge>=75" name="c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="2">
                                            <label for="c2vAge>=75" class="ml-2 block text-sm text-gray-900">â‰¥ 75 æ­² (+2 åˆ†)</label>
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset>
                                    <legend class="calc-label">æ€§åˆ¥ (Sex)</legend>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input id="c2vSexMale" name="c2vSex" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="0" checked>
                                            <label for="c2vSexMale" class="ml-2 block text-sm text-gray-900">ç”·æ€§ (0 åˆ†)</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input id="c2vSexFemale" name="c2vSex" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="1">
                                            <label for="c2vSexFemale" class="ml-2 block text-sm text-gray-900">å¥³æ€§ (+1 åˆ†)</label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                                <div class="flex items-center">
                                    <input id="c2vChf" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="c2vChf" class="ml-2 block text-sm text-gray-900">å¿ƒè‡Ÿè¡°ç«­ (CHF) (+1)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="c2vHt" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="c2vHt" class="ml-2 block text-sm text-gray-900">é«˜è¡€å£“ (Hypertension) (+1)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="c2vDm" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="c2vDm" class="ml-2 block text-sm text-gray-900">ç³–å°¿ç—… (Diabetes) (+1)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="c2vStroke" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="c2vStroke" class="ml-2 block text-sm text-gray-900">ä¸­é¢¨/TIA/TE (+2)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="c2vVd" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="c2vVd" class="ml-2 block text-sm text-gray-900">è¡€ç®¡ç–¾ç—… (Vascular) (+1)</label>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="calculateCha2ds2vascButton" class="calc-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h3m6 9a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    è¨ˆç®—åˆ†æ•¸
                                </button>
                                <span id="cha2ds2vascResult" class="calc-result" data-value=""></span>
                            </div>
                        </div>
                    </details>
                    
                    <details>
                        <summary class="flex justify-between items-center">
                            <span>3. BSA (Mosteller) è¨ˆç®— (é¸å¡«)</span>
                            <span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span>
                        </summary>
                        <div class="calculator-content space-y-4">
                            <p class="text-sm text-gray-500">å°‡è‡ªå‹•å¸¶å…¥æ‚¨åœ¨ (1) ä¸­è¼¸å…¥çš„èº«é«˜èˆ‡é«”é‡ã€‚</p>
                            <div class="flex justify-between items-center mt-4">
                                <button id="calculateBsaButton" class="calc-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h3m6 9a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    è¨ˆç®— BSA
                                </button>
                                <span id="calcBsaResult" class="calc-result" data-value=""></span>
                            </div>
                        </div>
                    </details>
                    
                    <details>
                        <summary class="flex justify-between items-center">
                            <span>4. eGFR (CKD-EPI 2021) è¨ˆç®— (é¸å¡«)</span>
                            <span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span>
                        </summary>
                        <div class="calculator-content space-y-4">
                            <p class="text-sm text-gray-500">å°‡è‡ªå‹•å¸¶å…¥æ‚¨åœ¨ (1) ä¸­è¼¸å…¥çš„æ€§åˆ¥ã€å¹´é½¡ã€SCrã€‚</p>
                            <div class="flex justify-between items-center mt-4">
                                <button id="calculateCkdEpiButton" class="calc-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h3m6 9a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    è¨ˆç®— eGFR (CKD-EPI)
                                </button>
                                <span id="calcCkdEpiResult" class="calc-result" data-value=""></span>
                            </div>
                        </div>
                    </details>
                    
                    <details>
                        <summary class="flex justify-between items-center">
                            <span>5. Child-Pugh Score (è‚åŠŸèƒ½) è¨ˆç®— (é¸å¡«)</span>
                            <span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span>
                        </summary>
                        <div class="calculator-content space-y-4">
                            <fieldset>
                                <legend class="calc-label">è…¹æ°´ (Ascites)</legend>
                                <div class="calc-radio-group">
                                    <label class="calc-radio-label"><input type="radio" name="cpAscites" value="1" checked> ç„¡ (1 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpAscites" value="2"> è¼•å¾® (2 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpAscites" value="3"> ä¸­/é‡åº¦ (3 åˆ†)</label>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend class="calc-label">è‚è…¦ç—…è®Š (Encephalopathy)</legend>
                                <div class="calc-radio-group">
                                    <label class="calc-radio-label"><input type="radio" name="cpEnceph" value="1" checked> ç„¡ (1 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpEnceph" value="2"> ç¬¬ 1-2 ç´š (2 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpEnceph" value="3"> ç¬¬ 3-4 ç´š (3 åˆ†)</label>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend class="calc-label">é»ƒç–¸æŒ‡æ•¸ (Bilirubin, mg/dL)</legend>
                                <div class="calc-radio-group">
                                    <label class="calc-radio-label"><input type="radio" name="cpBili" value="1" checked> &lt; 2 (1 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpBili" value="2"> 2 - 3 (2 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpBili" value="3"> &gt; 3 (3 åˆ†)</label>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend class="calc-label">ç™½è›‹ç™½ (Albumin, g/dL)</legend>
                                <div class="calc-radio-group">
                                    <label class="calc-radio-label"><input type="radio" name="cpAlb" value="1" checked> &gt; 3.5 (1 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpAlb" value="2"> 2.8 - 3.5 (2 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpAlb" value="3"> &lt; 2.8 (3 åˆ†)</label>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend class="calc-label">å‡è¡€æ™‚é–“ (INR)</legend>
                                <div class="calc-radio-group">
                                    <label class="calc-radio-label"><input type="radio" name="cpInr" value="1" checked> &lt; 1.7 (1 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpInr" value="2"> 1.7 - 2.3 (2 åˆ†)</label>
                                    <label class="calc-radio-label"><input type="radio" name="cpInr" value="3"> &gt; 2.3 (3 åˆ†)</label>
                                </div>
                            </fieldset>
                            <div class="flex justify-between items-center mt-4">
                                <button id="calculateChildPughButton" class="calc-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h3m6 9a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    è¨ˆç®— Child-Pugh Score
                                </button>
                                <span id="calcChildPughResult" class="calc-result" data-value=""></span>
                            </div>
                        </div>
                    </details>

                </div>
                <div class="terms-section">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-yellow-600"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        ä½¿ç”¨æ¢æ¬¾èˆ‡éš±ç§è²æ˜ (å¿…è®€)
                    </h3>
                    <ul>
                        <li>ä½¿ç”¨è€…ï¼ˆè—¥å¸«ï¼‰æ‰¿è«¾ä¸¦ä¿è­‰ï¼Œæ‰€æœ‰è¼¸å…¥æœ¬å·¥å…·çš„ç—…æ‚£è³‡æ–™ï¼Œ<strong>å‡å·²å®Œæˆã€Œå»è­˜åˆ¥åŒ–ã€</strong>ï¼Œå·²ç§»é™¤æ‰€æœ‰å¯ç›´æ¥æˆ–é–“æ¥è­˜åˆ¥ç‰¹å®šå€‹äººçš„è³‡è¨Š (ä¾‹å¦‚ï¼šå§“åã€ç—…æ­·è™Ÿã€èº«åˆ†è­‰å­—è™Ÿã€è¯çµ¡æ–¹å¼ã€å®Œæ•´ç”Ÿæ—¥ç­‰)ã€‚</li>
                        <li>ä½¿ç”¨è€…ç†è§£ä¸¦åŒæ„ï¼Œæäº¤çš„ã€Œå»è­˜åˆ¥åŒ–ã€åŒ¿åè³‡æ–™å°‡è¢«å‚³é€çµ¦ç¬¬ä¸‰æ–¹ AI æœå‹™ï¼ˆä¾‹å¦‚ Google Gemini APIï¼‰é€²è¡Œåˆ†æè™•ç†ï¼Œä»¥ç”¢ç”Ÿ SOAP ç­†è¨˜è‰ç¨¿ã€‚</li>
                        <li>è‹¥ä½¿ç”¨è€…é•åä¸Šè¿°æ‰¿è«¾ï¼Œè¼¸å…¥äº†ã€Œå¯è­˜åˆ¥ã€çš„å€‹äººè³‡æ–™ï¼Œå°è‡´ä»»ä½•æ³•å¾‹è²¬ä»»ã€è³‡æ–™å¤–æ´©ã€æˆ–ä¾µå®³ç¬¬ä¸‰æ–¹æ¬Šç›Šä¹‹æƒ…äº‹ï¼Œ<strong>æ‰€æœ‰ç›¸é—œæ³•å¾‹è²¬ä»»èˆ‡æå®³è³ å„Ÿæ‡‰ç”±è©²ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ“”</strong>ï¼Œèˆ‡æœ¬å·¥å…·é–‹ç™¼è€…ç„¡æ¶‰ã€‚</li>
                        <li><strong>è«‹å†æ¬¡ç¢ºèªæ‚¨è¼¸å…¥çš„è³‡æ–™ä¸å«ä»»ä½•å¯è­˜åˆ¥å€‹äººçš„è³‡è¨Šå¾Œï¼Œå†æŒ‰ä¸‹ã€Œå•Ÿå‹• AI åˆ†æã€æŒ‰éˆ•ã€‚</strong></li>
                    </ul>
                </div>

                <div class="flex items-center mb-4">
                    <input id="termsCheckbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="termsCheckbox" class="ml-2 block text-sm text-gray-900">
                        æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°ã€Œä½¿ç”¨æ¢æ¬¾èˆ‡éš±ç§è²æ˜ã€ã€‚
                    </label>
                </div>

                <div class="mb-4">
                    <label for="patientInfo" class="block text-sm font-medium text-gray-600 mb-2">
                        ç—…æ‚£æ ¸å¿ƒè³‡æ–™ (å¿…å¡«)
                        <span class="text-xs text-gray-500">(ä¾‹å¦‚ï¼šAge: 70, Sex: M, BW: 60kg, SCr: 1.2...)</span>
                    </label>
                    <textarea id="patientInfo" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è²¼å…¥ã€Œå»è­˜åˆ¥åŒ–ã€å¾Œçš„ç—…æ‚£è³‡è¨Š..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="uptodateInfo" class="block text-sm font-medium text-gray-600 mb-2">
                        æ•´åˆ UpToDate (é¸å¡«)
                    </label>
                    <textarea id="uptodateInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Š UpToDate çš„é‡é»..."></textarea>
                </div>
                <div class="mb-4">
                    <label for="micromedexInfo" class="block text-sm font-medium text-gray-600 mb-2">
                        æ•´åˆ Micromedex (é¸å¡«)
                    </label>
                    <textarea id="micromedexInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Š Micromedex çš„é‡é»..."></textarea>
                </div>
                <div class="mb-4">
                    <label for="openevidenceInfo" class="block text-sm font-medium text-gray-600 mb-2">
                        æ•´åˆ OpenEvidence (é¸å¡«)
                    </label>
                    <textarea id="openevidenceInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Š OpenEvidence çš„é‡é»..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="nhiGuidelinesInfo" class="block text-sm font-medium text-gray-600 mb-2">
                        æ•´åˆå¥ä¿çµ¦ä»˜è¦ç¯„ (é¸å¡«)
                    </label>
                    <textarea id="nhiGuidelinesInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Šç›¸é—œè—¥å“çš„å¥ä¿çµ¦ä»˜è¦ç¯„..."></textarea>
                </div>

                <div class="mt-auto pt-4">
                    <button id="generateButton" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 ease-in-out hover:scale-105 flex items-center justify-center opacity-70 cursor-not-allowed" disabled>
                        ğŸš€ å•Ÿå‹• AI åˆ†æ
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                         2. ç”¢ç”Ÿçš„ç­†è¨˜è‰ç¨¿
                    </h2>
                     <button id="copyButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                         ä¸€éµè¤‡è£½
                     </button>
                </div>
                
                <div id="progressBarContainer">
                    <div class="progress-bar"></div>
                </div>

                <div id="placeholder" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-lg transition-opacity duration-300">
                    <p class="font-semibold">AI å°‡è‡ªå‹•åŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š</p>
                    <ul class="list-disc list-inside text-left mt-2 text-sm">
                        <li>(v17.4) **è‡ªå‹•è§£æ**ç—…æ­·è³‡æ–™ (å«kg/cm/sex) ä¸¦å›å¡«è¨ˆç®—æ©Ÿã€‚</li>
                        <li>åˆ†æç—…æ­·ä¸¦è­˜åˆ¥ä¸»è¦å•é¡Œã€‚</li>
                        <li>å³æ™‚ä¸Šç¶²æœå°‹æœ€æ–°çš„åœ‹éš›æŒ‡å¼• (GINA, GOLD...)ã€‚</li>
                        <li>(v16.2) **è‡ªå‹•æ ¸å°æ‚¨æä¾›çš„ã€Œå¥ä¿çµ¦ä»˜è¦ç¯„ã€**ï¼Œè©•ä¼°æ ¸åˆªé¢¨éšªã€‚</li>
                        <li>æ•´åˆ DDIã€é‡è¤‡ç”¨è—¥ã€UpToDate/Micromedex ç­‰æ‰€æœ‰è³‡è¨Šã€‚</li>
                    </ul>
                    <p class="text-sm mt-4">æ‰€æœ‰å…§å®¹å‡éœ€ç”±å°ˆæ¥­è—¥å¸«æœ€çµ‚å¯©æ ¸ã€‚</p>
                </div>

                <div id="output" class="hidden prose max-w-none prose-pre:whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 200px;"></div>

                <div id="infoBox" class="hidden mt-4 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg">
                    <h4 class="font-bold text-sm">AI è¼”åŠ©èªªæ˜ (v17.4)ï¼š</h4>
                    <ul class="list-disc list-inside text-sm mt-1">
                        <li><strong>è‡ªå‹•å›å¡«ï¼š</strong> (v17.4) **å¼·åŒ–è§£æ**ï¼æŒ‰ä¸‹ã€Œå•Ÿå‹• AI åˆ†æã€æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•è§£æ `kg`, `cm`, `female` ç­‰è³‡æ–™ä¸¦å›å¡«è¨ˆç®—æ©Ÿã€‚</li>
                        <li><strong>å¥ä¿æ ¸å°ï¼š</strong> (v16.2) AI å·²è¢«æŒ‡ç¤º**å¿…é ˆ**æ ¸å°æ‚¨æä¾›çš„å¥ä¿è¦ç¯„ï¼Œä¸¦åœ¨ (A) ä¸­è©•ä¼°ã€‚</li>
                        <li><strong>æœ€æ–°æŒ‡å¼•ï¼š</strong> AI å·²è¢«æŒ‡ç¤ºåœ¨ã€ŒAssessmentã€ä¸­<strong>å¿…é ˆè¨»æ˜</strong>æ‰€åƒè€ƒæŒ‡å¼•çš„<strong>ã€Œå¯¦éš›å¹´ä»½ã€</strong>èˆ‡<strong>ã€ŒåŸæ–‡å¥å­ã€</strong>ã€‚</li>
                        <li><strong>DDI åˆ†æï¼š</strong> è—¥ç‰©äº¤äº’ä½œç”¨ (DDI) è©•ä¼°å·²ä½¿ç”¨ Gemini æ·±åº¦ç ”ç©¶åŠŸèƒ½å®Œæˆã€‚</li>
                        <li><strong>å°ˆæ¥­å¯©æ ¸ï¼š</strong> å…§å®¹åƒ…ä¾›åƒè€ƒï¼Œè«‹å‹™å¿…ç”±æ‚¨é€²è¡Œæœ€çµ‚çš„å°ˆæ¥­å¯©æ ¸èˆ‡ä¿®æ”¹ã€‚</li>
                    </ul>
                </div>

                <div id="sourcesContainer" class="hidden mt-6">
                    <h3 id="sourcesTitle" class="text-lg font-semibold text-gray-600 mb-2">å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æºï¼š</h3>
                    <ul id="sourcesList" class="list-none list-inside text-sm space-y-1"></ul>
                </div>
            </div>
        </main>

        <section class="bg-white p-6 rounded-xl shadow-xl mt-6">
            <details>
                <summary class="text-xl">å¦‚ä½•å–å¾—èˆ‡ä½¿ç”¨ API é‡‘é‘°ï¼Ÿ</summary>
                <div class="mt-4 prose max-w-none">
                    <p>
                        é€™å€‹å·¥å…·éœ€è¦ã€ŒGoogle Gemini API é‡‘é‘°ã€æ‰èƒ½å•Ÿå‹• AI å¤§è…¦ä¸¦é€£ç·šåˆ° Google æœå°‹ã€‚é€™æ˜¯ä¸€æŠŠå°ˆå±¬æ–¼æ‚¨çš„é‘°åŒ™ã€‚
                        <br>
                        é€™å€‹é‡‘é‘°<strong>åªæœƒ</strong>å„²å­˜åœ¨æ‚¨ç•¶å‰çš„ç€è¦½å™¨ (<code>localStorage</code>) ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ï¼Œå› æ­¤éå¸¸å®‰å…¨ã€‚
                    </p>
                    
                    <div class="instruction-step">
                        <h4>æ­¥é©Ÿ 1ï¼šå‰å¾€ Google AI Studio</h4>
                        <p>
                            é»æ“Šæ­¤é€£çµ <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">https://aistudio.google.com/</a>ï¼Œå¹¶ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥ã€‚
                        </p>
                    </div>
                    
                    <div class="instruction-step">
                        <h4>æ­¥é©Ÿ 2ï¼šå»ºç«‹ API é‡‘é‘°</h4>
                        <p>
                            ç™»å…¥å¾Œï¼Œé»æ“Šé é¢å·¦å´çš„ã€ŒGet API keyã€(å–å¾— API é‡‘é‘°)ã€‚
                            <br>
                            åœ¨ä¸‹ä¸€å€‹ç•«é¢ä¸­ï¼Œé»æ“Šã€ŒCreate API key in new projectã€(åœ¨æ–°å°ˆæ¡ˆä¸­å»ºç«‹ API é‡‘é‘°)ã€‚
                        </p>
                    </div>

                    <div class="instruction-step">
                        <h4>æ­¥é©Ÿ 3ï¼šè¤‡è£½é‡‘é‘°</h4>
                        <p>
                            ç•«é¢ä¸Šæœƒå½ˆå‡ºä¸€å€‹è¦–çª—ï¼Œé¡¯ç¤ºæ‚¨æ–°ç”¢ç”Ÿçš„é‡‘é‘°ï¼ˆå®ƒæ˜¯ä¸€é•·ä¸²éš¨æ©Ÿå­—æ¯å’Œæ•¸å­—ï¼Œä¾‹å¦‚ <code>AIzaSy...</code>ï¼‰ã€‚
                            <br>
                            è«‹é»æ“Šå®ƒæ—é‚Šçš„ã€Œè¤‡è£½ã€æŒ‰éˆ•ã€‚
                        </p>
                    </div>

                    <div class="instruction-step">
                        <h4>æ­¥é©Ÿ 4ï¼šè²¼ä¸Šä¸¦å„²å­˜</h4>
                        <p>
                            å›åˆ°é€™å€‹é é¢ï¼Œå°‡æ‚¨å‰›å‰›è¤‡è£½çš„é‡‘é‘°ï¼Œè²¼åˆ°æœ€ä¸Šæ–¹çš„ã€ŒGoogle Gemini API é‡‘é‘°ã€è¼¸å…¥æ¡†ä¸­ã€‚
                            <br>
                            é»æ“Šã€Œå„²å­˜é‡‘é‘°ã€ã€‚
                        </p>
                    </div>
                    
                    <div class="instruction-step">
                        <h4>æ­¥é©Ÿ 5ï¼šå®Œæˆï¼</h4>
                        <p>
                            æ‚¨ç¾åœ¨å¯ä»¥é–‹å§‹ä½¿ç”¨é€™å€‹å·¥å…·äº†ã€‚é‡‘é‘°å·²å„²å­˜ï¼Œæ‚¨ä¸‹æ¬¡é‡æ–°æ•´ç†æˆ–æ‰“é–‹é€™å€‹ HTML æª”æ¡ˆæ™‚ï¼Œéƒ½ä¸éœ€è¦å†é‡æ–°è¼¸å…¥ã€‚
                        </p>
                    </div>
                </div>
             </details>
        </section>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </div>
                 <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">ç™¼ç”ŸéŒ¯èª¤</h3>
                 <div class="mt-2 px-7 py-3">
                     <p id="errorMessage" class="text-sm text-gray-500">ç„¡æ³•ç”¢ç”Ÿç­†è¨˜ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
                 </div>
                 <div class="items-center px-4 py-3">
                     <button id="closeModalButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">é—œé–‰</button>
                 </div>
            </div>
        </div>
    </div>

    <script>
        // === DOM å…ƒç´  ===
        const generateButton = document.getElementById('generateButton');
        const patientInfoInput = document.getElementById('patientInfo');
        const specialtyFocusSelect = document.getElementById('specialtyFocus');
        const uptodateInfoInput = document.getElementById('uptodateInfo');
        const micromedexInfoInput = document.getElementById('micromedexInfo');
        const openevidenceInfoInput = document.getElementById('openevidenceInfo');
        const termsCheckbox = document.getElementById('termsCheckbox');
        // v16.2: æ–°å¢å¥ä¿ DOM
        const nhiGuidelinesInfoInput = document.getElementById('nhiGuidelinesInfo');

        // v16.0: CrCl & IBW/ABW è¨ˆç®—æ©Ÿ DOM
        const calcSex = document.getElementById('calcSex');
        const calcAge = document.getElementById('calcAge');
        const calcWeight = document.getElementById('calcWeight');
        const calcHeight = document.getElementById('calcHeight');
        const calcScr = document.getElementById('calcScr');
        const calculateCrClBwButton = document.getElementById('calculateCrClBwButton');
        const crclResult = document.getElementById('crclResult');
        const bwResult = document.getElementById('bwResult');

        // v16.0: CHA2DS2-VASc è¨ˆç®—æ©Ÿ DOM
        const c2vAgeLess65 = document.getElementById('c2vAge<65');
        const c2vAge65_74 = document.getElementById('c2vAge65-74');
        const c2vAgeGreater75 = document.getElementById('c2vAge>=75');
        const c2vSexFemale = document.getElementById('c2vSexFemale');
        const c2vChf = document.getElementById('c2vChf');
        const c2vHt = document.getElementById('c2vHt');
        const c2vDm = document.getElementById('c2vDm');
        const c2vStroke = document.getElementById('c2vStroke');
        const c2vVd = document.getElementById('c2vVd');
        const calculateCha2ds2vascButton = document.getElementById('calculateCha2ds2vascButton');
        const cha2ds2vascResult = document.getElementById('cha2ds2vascResult');
        
        // v16.1: BSA è¨ˆç®—æ©Ÿ DOM
        const calculateBsaButton = document.getElementById('calculateBsaButton');
        const calcBsaResult = document.getElementById('calcBsaResult');

        // v16.1: CKD-EPI è¨ˆç®—æ©Ÿ DOM
        const calculateCkdEpiButton = document.getElementById('calculateCkdEpiButton');
        const calcCkdEpiResult = document.getElementById('calcCkdEpiResult');
        
        // v16.1: Child-Pugh è¨ˆç®—æ©Ÿ DOM
        const calculateChildPughButton = document.getElementById('calculateChildPughButton');
        const calcChildPughResult = document.getElementById('calcChildPughResult');
        
        const outputDiv = document.getElementById('output');
        const placeholderDiv = document.getElementById('placeholder');
        const infoBox = document.getElementById('infoBox');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');
        const sourcesTitle = document.getElementById('sourcesTitle');

        const clearInputsButton = document.getElementById('clearInputsButton');
        const copyButton = document.getElementById('copyButton');
        const progressBarContainer = document.getElementById('progressBarContainer');

        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const apiKeyStatus = document.getElementById('apiKeyStatus');

        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        const queryGuidelinesButton = document.getElementById('queryGuidelinesButton');
        const guidelineSpinner = document.getElementById('guidelineSpinner');
        const guidelineListContainer = document.getElementById('guidelineListContainer');
        const guidelineList = document.getElementById('guidelineList');

        // === å…¨åŸŸè®Šæ•¸ ===
        let apiKey = "";
        // v17.2: æ ¹æ“šä½¿ç”¨è€…æŒ‡ç¤ºæ›´æ–°æ¨¡å‹
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";

        // === API é‡‘é‘°è™•ç† ===
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                try {
                    localStorage.setItem('geminiApiKey', key);
                    apiKey = key;
                    apiKeyStatus.textContent = "ç‹€æ…‹ï¼šé‡‘é‘°å·²å„²å­˜ä¸¦è¼‰å…¥ã€‚";
                    apiKeyStatus.className = "text-sm mt-3 text-green-600";
                    apiKeyInput.value = ""; 
                    apiKeyInput.placeholder = "é‡‘é‘°å·²å„²å­˜";
                } catch (e) {
                    apiKeyStatus.textContent = "ç‹€æ…‹ï¼šç„¡æ³•å„²å­˜é‡‘é‘° (ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ localStorage)ã€‚";
                    apiKeyStatus.className = "text-sm mt-3 text-red-600";
                    console.error("å„²å­˜ API é‡‘é‘°æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                }
            } else {
                apiKeyStatus.textContent = "ç‹€æ…‹ï¼šè«‹å…ˆè¼¸å…¥é‡‘é‘°ã€‚";
                apiKeyStatus.className = "text-sm mt-3 text-red-600";
            }
        }
        function loadApiKey() {
            try {
                const storedKey = localStorage.getItem('geminiApiKey');
                if (storedKey) {
                    apiKey = storedKey;
                    apiKeyStatus.textContent = "ç‹€æ…‹ï¼šå·²å¾ç€è¦½å™¨è¼‰å…¥é‡‘é‘°ã€‚";
                    apiKeyStatus.className = "text-sm mt-3 text-green-600";
                    apiKeyInput.placeholder = "é‡‘é‘°å·²å„²å­˜";
                } else {
                    apiKeyStatus.textContent = "ç‹€æ…‹ï¼šå°šæœªè¨­å®šé‡‘é‘°ã€‚è«‹è²¼ä¸Šé‡‘é‘°ä¸¦å„²å­˜ã€‚";
                    apiKeyStatus.className = "text-sm mt-3 text-red-600";
                }
            } catch (e) {
                apiKeyStatus.textContent = "ç‹€æ…‹ï¼šç„¡æ³•è¼‰å…¥é‡‘é‘° (ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ localStorage)ã€‚";
                apiKeyStatus.className = "text-sm mt-3 text-red-600";
                console.error("è¼‰å…¥ API é‡‘é‘°æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
            }
        }

        // === éŒ¯èª¤è™•ç† ===
        function showError(message) {
            if (apiKey === "") {
                errorMessage.textContent = "API é‡‘é‘°å°šæœªè¨­å®šæˆ–ç„¡æ•ˆã€‚è«‹åœ¨æœ€ä¸Šæ–¹çš„ã€Œé€£ç·šè¨­å®šã€å€å¡Šè¼¸å…¥ä¸¦å„²å­˜æ‚¨çš„é‡‘é‘°ï¼Œæˆ–æª¢æŸ¥é‡‘é‘°æ˜¯å¦æ­£ç¢ºã€‚";
            } else {
                errorMessage.textContent = message || "ç™¼ç”ŸæœªçŸ¥çš„éŒ¯èª¤ã€‚";
            }
            errorModal.classList.remove('hidden');
        }
        closeModalButton.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });

        // === v16.2: è¨ˆç®—æ©Ÿé‚è¼¯ ===

        // v16.2: Helper function to set result text
        function setCalcResult(element, text, value, isNoData = false) {
            element.textContent = text;
            element.dataset.value = value;
            if (isNoData) {
                element.className = 'calc-result-nodata block';
            } else if (text) {
                element.className = 'calc-result block';
            }
        }


        // 1. CrCl & IBW/ABW (C-G)
        function calculateCrClAndBw() {
            const age = parseFloat(calcAge.value);
            const weight = parseFloat(calcWeight.value);
            const height = parseFloat(calcHeight.value);
            const scr = parseFloat(calcScr.value);
            const sex = calcSex.value;

            let crclCalculated = false;
            let bwCalculated = false;

            // 1. Calculate CrCl (Cockcroft-Gault)
            if (!isNaN(age) && !isNaN(weight) && !isNaN(scr) && scr > 0) {
                let weightForCrCl = weight; // é è¨­ä½¿ç”¨ ABW
                
                if (!isNaN(height)) {
                    let ibw = (sex === 'Male') ? (50 + 2.3 * (height * 0.393701 - 60)) : (45.5 + 2.3 * (height * 0.393701 - 60));
                    if (ibw < 0) ibw = (sex === 'Male') ? 50 : 45.5; 
                    
                    if (weight < ibw) {
                        weightForCrCl = weight; // é«”é‡éè¼•
                    } else if (weight >= ibw && weight <= ibw * 1.2) {
                        weightForCrCl = ibw; // æ­£å¸¸
                    } else { // è‚¥èƒ– (TBW > 120% IBW)
                        weightForCrCl = ibw + 0.4 * (weight - ibw); // AdjBW
                    }
                }
                
                let crcl = ((140 - age) * weightForCrCl) / (72 * scr);
                if (sex === 'Female') {
                    crcl *= 0.85;
                }
                const crclVal = `${crcl.toFixed(1)} mL/min`;
                setCalcResult(crclResult, `CrCl (C-G): ${crclVal}`, crclVal);
                crclCalculated = true;
            } else {
                 if (crclResult.dataset.value === "") { 
                     setCalcResult(crclResult, "è«‹è¼¸å…¥ CrCl å¿…å¡«æ¬„ä½", "", true); // v17.3: ä¿®æ­£æç¤º
                 }
            }

            // 2. Calculate IBW/ABW è©•ä¼°
            if (!isNaN(height) && !isNaN(weight)) {
                let ibw = (sex === 'Male') ? (50 + 2.3 * (height * 0.393701 - 60)) : (45.5 + 2.3 * (height * 0.393701 - 60));
                if (ibw < 0) ibw = (sex === 'Male') ? 50 : 45.5;

                const upperLimit = ibw * 1.2;
                let assessment = (weight > upperLimit) ? "ä½æ–¼ABWç¯„åœå…§ (TBW/IBW > 1.2)" : "æœªé€²å…¥ABWç¯„åœ (TBW/IBW â‰¤ 1.2)";
                
                const bwVal = `IBW: ${ibw.toFixed(1)} kg. è©•ä¼°: ${assessment}`;
                setCalcResult(bwResult, bwVal, bwVal);
                bwCalculated = true;
            } else {
                 if (bwResult.dataset.value === "") { 
                     setCalcResult(bwResult, "è«‹è¼¸å…¥ Ht/BW", "", true); // v17.3: ä¿®æ­£æç¤º
                 }
            }
        }

        // 2. CHAâ‚‚DSâ‚‚-VASc
        function calculateCha2ds2vasc() {
            let score = 0;
            if (c2vAgeGreater75.checked) score += 2;
            else if (c2vAge65_74.checked) score += 1;
            if (c2vSexFemale.checked) score += 1;
            if (c2vChf.checked) score += 1;
            if (c2vHt.checked) score += 1;
            if (c2vDm.checked) score += 1;
            if (c2vStroke.checked) score += 2;
            if (c2vVd.checked) score += 1;

            const scoreVal = `${score} åˆ†`;
            setCalcResult(cha2ds2vascResult, `Score: ${scoreVal}`, scoreVal);
        }

        // 3. BSA (Mosteller)
        function calculateBsa() {
            const weight = parseFloat(calcWeight.value);
            const height = parseFloat(calcHeight.value);
            
            if (!isNaN(weight) && !isNaN(height) && weight > 0 && height > 0) {
                const bsa = Math.sqrt((height * weight) / 3600);
                const bsaVal = `${bsa.toFixed(2)} mÂ²`;
                setCalcResult(calcBsaResult, `BSA: ${bsaVal}`, bsaVal);
            } else {
                setCalcResult(calcBsaResult, "è«‹è¼¸å…¥èº«é«˜/é«”é‡", "", true);
            }
        }

        // 4. CKD-EPI 2021
        function calculateCkdEpi() {
            const age = parseFloat(calcAge.value);
            const scr = parseFloat(calcScr.value);
            const sex = calcSex.value;

            if (isNaN(age) || isNaN(scr) || scr <= 0) {
                setCalcResult(calcCkdEpiResult, "è«‹è¼¸å…¥å¹´é½¡/SCr", "", true);
                return;
            }

            let kappa = (sex === 'Female') ? 0.7 : 0.9;
            let alpha = (sex === 'Female') ? -0.241 : -0.302;
            let sexFactor = (sex === 'Female') ? 1.012 : 1;

            let eGFR = 142 * Math.pow(Math.min(scr / kappa, 1), alpha) * Math.pow(Math.max(scr / kappa, 1), -1.200) * Math.pow(0.9938, age) * sexFactor;
            
            const eGFRVal = `${eGFR.toFixed(1)} mL/min/1.73mÂ²`;
            setCalcResult(calcCkdEpiResult, `eGFR (CKD-EPI): ${eGFRVal}`, eGFRVal);
        }

        // 5. Child-Pugh Score
        function calculateChildPugh() {
            let score = 0;
            score += parseInt(document.querySelector('input[name="cpAscites"]:checked').value);
            score += parseInt(document.querySelector('input[name="cpEnceph"]:checked').value);
            score += parseInt(document.querySelector('input[name="cpBili"]:checked').value);
            score += parseInt(document.querySelector('input[name="cpAlb"]:checked').value);
            score += parseInt(document.querySelector('input[name="cpInr"]:checked').value);

            let grade = "";
            if (score >= 5 && score <= 6) grade = "A (5-6 åˆ†)";
            else if (score >= 7 && score <= 9) grade = "B (7-9 åˆ†)";
            else if (score >= 10 && score <= 15) grade = "C (10-15 åˆ†)";

            const scoreVal = `Child-Pugh: ${grade}`;
            setCalcResult(calcChildPughResult, scoreVal, scoreVal);
        }

        // === v17.4: å¼·åŒ–ç‰ˆ - è¢«å‹•è§£æèˆ‡å›å¡« ===
        function parseAndFillCalculators(text) {
            
            // 1. Helper Functions
            const findVal = (regex) => {
                const match = text.match(regex);
                return match ? parseFloat(match[1]) : null;
            };
            const findStr = (regex) => {
                const match = text.match(regex);
                return match ? match[1].toUpperCase() : null;
            }

            // 2. Define Regex (v17.4: å¼·åŒ– Sex)
            const regex = {
                sex: /(?:sex|æ€§åˆ¥)\s*[:ï¼š=\s]\s*(M|F|Male|Female|ç”·|å¥³)/i,
                sexStandalone: /\b(female|male|F|M|ç”·|å¥³)\b/i, // v17.4: æ–°å¢
                age: /(?:age|å¹´é½¡)\s*[:ï¼š=\s]\s*(\d{1,3})/i,
                ageYo: /(\d{1,3})\s*y\s*\/?\s*o/i,
                weight: /(?:weight|BW|é«”é‡)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)\s*k?g/i, // å¸¶æ¨™ç±¤
                weightKg: /\b(\d{1,3}(?:\.\d{1,2})?)\s*k?g\b/i, // v17.3: ä¸å¸¶æ¨™ç±¤
                height: /(?:height|èº«é«˜)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)\s*c?m/i, // å¸¶æ¨™ç±¤
                heightCm: /\b(\d{1,3}(?:\.\d{1,2})?)\s*c?m\b/i, // v17.3: ä¸å¸¶æ¨™ç±¤
                scr: /(?:SCr|Crea|Creatinine|Cr)\s*[:ï¼š=\s]\s*(\d{1,2}(?:\.\d{1,3})?)/i, // å‡è¨­ mg/dL
                egfr: /(?:eGFR|CKD-EPI)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)/i,
                crcl: /(?:CrCl|C-G)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)/i,
                bsa: /BSA\s*[:ï¼š=\s]\s*(\d{1,2}(?:\.\d{1,2})?)/i,
                cha2ds2vasc: /(?:CHAâ‚‚DSâ‚‚-VASc|CHADS-VASc)\s*(?:score)?\s*[:ï¼š=\s]\s*(\d{1,2})\s*(?:åˆ†|point|points)?/i,
                childPugh: /(?:Child-Pugh|Child's)\s*(?:score|grade)?\s*[:ï¼š=\s]\s*([ABC])\b/i
            };

            // 3. Parse Raw Data (v17.4: å¼·åŒ– Sex)
            let parsed = {
                sex: findStr(regex.sex) || findStr(regex.sexStandalone),
                age: findVal(regex.age) || findVal(regex.ageYo),
                weight: findVal(regex.weight) || findVal(regex.weightKg),
                height: findVal(regex.height) || findVal(regex.heightCm),
                scr: findVal(regex.scr)
            };
            
            // 4. Parse Calculated Data
            let preCalculated = {
                egfr: findVal(regex.egfr),
                crcl: findVal(regex.crcl),
                bsa: findVal(regex.bsa),
                cha2ds2vasc: findVal(regex.cha2ds2vasc),
                childPugh: findStr(regex.childPugh)
            };

            // 5. Fill Raw Inputs (å¼·åˆ¶è¦†è“‹)
            if (parsed.sex) {
                // v17.4: å¼·åŒ–é‚è¼¯
                if (parsed.sex.startsWith('M') || parsed.sex === 'ç”·') {
                    calcSex.value = 'Male';
                } else if (parsed.sex.startsWith('F') || parsed.sex === 'å¥³') {
                    calcSex.value = 'Female';
                }
            }
            if (parsed.age) calcAge.value = parsed.age;
            if (parsed.weight) calcWeight.value = parsed.weight;
            if (parsed.height) calcHeight.value = parsed.height;
            if (parsed.scr) calcScr.value = parsed.scr;

            // 6. Handle Logic for Each Calculator (å„ªå…ˆä½¿ç”¨ preCalculated, å¦å‰‡è‡ªå‹•è¨ˆç®—)

            // --- Calc 1: CrCl & BW ---
            if (preCalculated.crcl) {
                const crclVal = `${preCalculated.crcl.toFixed(1)} mL/min`;
                setCalcResult(crclResult, `CrCl (C-G): ${crclVal}`, crclVal);
                // ä»éœ€è¨ˆç®— BW (å¦‚æœ Ht/Wt å­˜åœ¨)
                if (calcHeight.value && calcWeight.value) calculateCrClAndBw(); 
            } else if (calcAge.value && calcWeight.value && calcScr.value && calcSex.value) {
                calculateCrClAndBw(); // è‡ªå‹•è¨ˆç®— CrCl + BW
            } else if (calcHeight.value && calcWeight.value) {
                 calculateCrClAndBw(); // è‡³å°‘è¨ˆç®— BW
            } else {
                // åƒ…åœ¨æ²’æœ‰ pre-calculated CrCl æ™‚æ‰é¡¯ç¤ºéŒ¯èª¤
                if (!preCalculated.crcl) setCalcResult(crclResult, "ç„¡è³‡æ–™è¨ˆç®— (ç¼º Age/BW/SCr/Sex)", "", true);
                if (!bwResult.dataset.value) setCalcResult(bwResult, "ç„¡è³‡æ–™è¨ˆç®— (ç¼º Ht/BW)", "", true);
            }

            // --- Calc 2: CHAâ‚‚DSâ‚‚-VASc ---
            if (preCalculated.cha2ds2vasc) {
                const scoreVal = `${preCalculated.cha2ds2vasc} åˆ†`;
                setCalcResult(cha2ds2vascResult, `Score: ${scoreVal}`, scoreVal);
            }
            // (è‹¥ç„¡, å‰‡ä¸å‹•ä½œ)

            // --- Calc 3: BSA ---
            if (preCalculated.bsa) {
                const bsaVal = `${preCalculated.bsa.toFixed(2)} mÂ²`;
                setCalcResult(calcBsaResult, `BSA: ${bsaVal}`, bsaVal);
            } else if (calcWeight.value && calcHeight.value) {
                calculateBsa(); // è‡ªå‹•è¨ˆç®—
            } else {
                setCalcResult(calcBsaResult, "ç„¡è³‡æ–™è¨ˆç®— (ç¼º BW/Height)", "", true);
            }

            // --- Calc 4: CKD-EPI ---
            if (preCalculated.egfr) {
                const eGFRVal = `${preCalculated.egfr.toFixed(1)} mL/min/1.73mÂ²`;
                setCalcResult(calcCkdEpiResult, `eGFR (CKD-EPI): ${eGFRVal}`, eGFRVal);
            } else if (calcAge.value && calcScr.value && calcSex.value) {
                calculateCkdEpi(); // è‡ªå‹•è¨ˆç®—
            } else {
                setCalcResult(calcCkdEpiResult, "ç„¡è³‡æ–™è¨ˆç®— (ç¼º Age/SCr/Sex)", "", true);
            }

            // --- Calc 5: Child-Pugh ---
            if (preCalculated.childPugh) {
                let grade = preCalculated.childPugh;
                let gradeText = `Child-Pugh: ${grade}`;
                if (grade === 'A') gradeText = 'Child-Pugh: A (5-6 åˆ†)';
                else if (grade === 'B') gradeText = 'Child-Pugh: B (7-9 åˆ†)';
                else if (grade === 'C') gradeText = 'Child-Pugh: C (10-15 åˆ†)';
                setCalcResult(calcChildPughResult, gradeText, gradeText);
            }
            // (è‹¥ç„¡, å‰‡ä¸å‹•ä½œ)
        }


        // === æ ¸å¿ƒ API å‘¼å« ===
        async function callGeminiAPI(systemPrompt, userPrompt, useSearch = true) {
            if (apiKey === "") {
                throw new Error("API é‡‘é‘°å°šæœªè¨­å®šã€‚");
            }
            
            let retries = 3;
            let delay = 1000;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: useSearch ? [{ "googleSearch": {} }] : [] // ä¿®æ­£ç‚º "googleSearch"
            };
            
            const apiUrl = `${apiUrlBase}${modelName}:generateContent?key=${apiKey}`;

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorBody = "ç„¡æ³•è®€å–éŒ¯èª¤è©³æƒ…";
                        try {
                            const errJson = await response.json();
                            errorBody = errJson.error?.message || JSON.stringify(errJson);
                            if (errorBody.includes("API key not valid")) {
                                errorBody = "API é‡‘é‘°ç„¡æ•ˆã€‚è«‹æª¢æŸ¥æ‚¨çš„é‡‘é‘°æ˜¯å¦æ­£ç¢ºï¼Œæˆ–é‡æ–°ç”¢ç”Ÿä¸€æŠŠã€‚";
                            }
                            // v17.2: é‡å°æ–°æ¨¡å‹åç¨±è‡ªè¨‚éŒ¯èª¤è¨Šæ¯
                            if (response.status === 404 && (errorBody.includes("not found") || errorBody.includes(modelName))) {
                                errorBody = `æ¨¡å‹åç¨± "${modelName}" æœªæ‰¾åˆ°æˆ–ä¸æ”¯æ´ã€‚ (HTTP 404)`;
                            }
                        } catch (e) { /* å¿½ç•¥ */ }
                        throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}. è©³æƒ…: ${errorBody}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        
                        if (useSearch && candidate.groundingMetadata && candidate.groundingMetadata.searchQueries) {
                           if (candidate.groundingMetadata.groundingAttributions) {
                                sources = candidate.groundingMetadata.groundingAttributions
                                    .map(attr => ({
                                        uri: attr.web?.uri,
                                        title: attr.web?.title,
                                    }))
                                    .filter(source => source.uri && source.title);
                           }
                        }
                        return { text, sources };
                    } else {
                        console.error("API å›æ‡‰æ ¼å¼éŒ¯èª¤æˆ–ç„¡å…§å®¹:", result);
                        let errorMsg = "API å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºã€‚";
                        if (candidate?.finishReason === "SAFETY") {
                            errorMsg = "å…§å®¹å¯èƒ½é•åå®‰å…¨æ”¿ç­–è€Œè¢«é˜»æ“‹ã€‚";
                        } else if (result.promptFeedback?.blockReason) {
                            errorMsg = `è«‹æ±‚è¢«é˜»æ“‹ï¼š${result.promptFeedback.blockReason}`;
                        } else if (!candidate) {
                            errorMsg = "API æœªè¿”å›æœ‰æ•ˆçš„å€™é¸ç­”æ¡ˆ (å¯èƒ½å·²éè¼‰)ã€‚";
                        }
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error(`API å‘¼å«å¤±æ•— (å‰©ä¸‹ ${retries - 1} æ¬¡é‡è©¦):`, error);
                    retries--;
                    if (retries === 0) {
                        throw new Error(error.message === "Failed to fetch" ? "Load failed (ç¶²è·¯é€£ç·šå¤±æ•—)" : error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // === äº‹ä»¶ç›£è½å™¨ ===
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
        });

        saveApiKeyButton.addEventListener('click', saveApiKey);

        termsCheckbox.addEventListener('change', () => {
            generateButton.disabled = !termsCheckbox.checked;
            if (termsCheckbox.checked) {
                generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
            } else {
                generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            }
        });

        // v16.1: è¨ˆç®—æ©ŸæŒ‰éˆ•ç›£è½
        calculateCrClBwButton.addEventListener('click', calculateCrClAndBw);
        calculateCha2ds2vascButton.addEventListener('click', calculateCha2ds2vasc);
        calculateBsaButton.addEventListener('click', calculateBsa);
        calculateCkdEpiButton.addEventListener('click', calculateCkdEpi);
        calculateChildPughButton.addEventListener('click', calculateChildPugh);


        queryGuidelinesButton.addEventListener('click', async () => {
            if (apiKey === "") {
                showError("è«‹å…ˆè¨­å®š API é‡‘é‘°ã€‚");
                return;
            }
            guidelineSpinner.classList.remove('hidden');
            queryGuidelinesButton.disabled = true;
            queryGuidelinesButton.classList.add('opacity-70', 'cursor-not-allowed');
            guidelineList.innerHTML = ''; 
            guidelineListContainer.classList.add('hidden');

            const guidelineQueryPrompt = `æ‚¨æ˜¯ä¸€ä½ AI åŠ©æ‰‹ï¼Œä»»å‹™æ˜¯ä½¿ç”¨ Google æœå°‹ä¾†**å³æ™‚æŸ¥æ ¸**ä»¥ä¸‹å¸¸è¦‹è‡¨åºŠæŒ‡å¼•çš„ã€Œæœ€æ–°ç™¼å¸ƒå¹´ä»½ã€ã€‚
æ‚¨çš„å›è¦†å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œåƒ…å›å‚³åˆ—è¡¨ï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–çµèªï¼š
* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šGINA - Asthma) - [æœ€æ–°å¹´ä»½]
* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šGOLD - COPD) - [æœ€æ–°å¹´ä»½]
* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šAHA/ACC - Hypertension) - [æœ€æ–°å¹´ä»½]
* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šSurviving Sepsis Campaign) - [æœ€æ–°å¹´ä»½]
* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šIDSA - Skin and Soft Tissue Infections) - [æœ€æ–°å¹´ä»½]
* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šKDIGO - CKD) - [æœ€æ–°å¹´ä»½]`;
            const userPrompt = "è«‹ç«‹å³ä½¿ç”¨ Google æœå°‹ï¼Œå¹«æˆ‘æŸ¥è©¢ GINA (Asthma), GOLD (COPD), AHA/ACC (Hypertension), Surviving Sepsis Campaign, IDSA (Skin and Soft Tissue Infections), ä»¥åŠ KDIGO (CKD) çš„æœ€æ–°æŒ‡å¼•ç™¼å¸ƒå¹´ä»½ã€‚";

            try {
                const { text } = await callGeminiAPI(guidelineQueryPrompt, userPrompt, true);
                const lines = text.split('\n').filter(line => line.trim().length > 0);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        guidelineList.appendChild(li);
                    });
                    guidelineListContainer.classList.remove('hidden');
                } else {
                    throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„åˆ—è¡¨ã€‚");
                }
            } catch (error) {
                console.error("æŸ¥è©¢æŒ‡å¼•æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                guidelineList.innerHTML = `<li class="text-red-600">æŸ¥è©¢å¤±æ•—ï¼š${error.message}</li>`;
                guidelineListContainer.classList.remove('hidden');
            } finally {
                guidelineSpinner.classList.add('hidden');
                queryGuidelinesButton.disabled = false;
                queryGuidelinesButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        generateButton.addEventListener('click', async () => {
            if (!termsCheckbox.checked) {
                showError("è«‹å…ˆé–±è®€ä¸¦å‹¾é¸åŒæ„ã€Œä½¿ç”¨æ¢æ¬¾èˆ‡éš±ç§è²æ˜ã€ã€‚");
                return;
            }

            if (apiKey === "") {
                showError("è«‹å…ˆè¨­å®š API é‡‘é‘°ã€‚");
                return;
            }
            
            const patientInfo = patientInfoInput.value;
            const specialtyFocus = specialtyFocusSelect.value;
            const uptodateInfo = uptodateInfoInput.value.trim();
            const micromedexInfo = micromedexInfoInput.value.trim();
            const openevidenceInfo = openevidenceInfoInput.value.trim();
            // v16.2: ç²å–å¥ä¿è³‡æ–™
            const nhiGuidelinesInfo = nhiGuidelinesInfoInput.value.trim();
            
            if (!patientInfo.trim()) {
                showError("è«‹è¼¸å…¥ã€Œç—…æ‚£æ ¸å¿ƒè³‡æ–™ã€ã€‚");
                return;
            }

            // *** v17.4: NEW FEATURE (å¼·åŒ–ç‰ˆ) ***
            // åœ¨æ”¶é›†è³‡æ–™ *ä¹‹å‰*ï¼Œå…ˆåŸ·è¡Œè§£æèˆ‡å›å¡«
            parseAndFillCalculators(patientInfo);
            // *** End of v17.4 Feature ***


            // ç²å– "è¨ˆç®—å¾Œ" (ç¾åœ¨ä¾†è‡ªæ‰‹å‹•æˆ–è‡ªå‹•) çš„å€¼
            const crcl = crclResult.dataset.value || "";
            const bwAssessment = bwResult.dataset.value || "";
            const cha2ds2Score = cha2ds2vascResult.dataset.value || "";
            const bsa = calcBsaResult.dataset.value || "";
            const ckdEpi = calcCkdEpiResult.dataset.value || "";
            const childPugh = calcChildPughResult.dataset.value || "";


            progressBarContainer.style.display = 'block';
            placeholderDiv.classList.add('animate-pulse');
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearInputsButton.disabled = true;
            
            outputDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            infoBox.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';
            sourcesTitle.textContent = 'å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æºï¼š';
            copyButton.disabled = true;

            // v17.2: Prompt ä¿æŒä¸è®Š (v16.2 çš„é‚è¼¯ä¾ç„¶é©ç”¨)
            const systemPrompt = `æ‚¨æ˜¯ä¸€ä½é ‚å°–çš„è‡¨åºŠè—¥å¸«ï¼Œæ“æœ‰è±å¯Œçš„ç¶“é©—ï¼Œä¸¦ä¸”éš¨æ™‚æŒæ¡æœ€æ–°çš„åœ‹éš›é†«ç™‚æŒ‡å¼•ã€‚

æ‚¨çš„ä»»å‹™æ˜¯ (v16.2)ï¼š
1.  ä»”ç´°åˆ†æä½¿ç”¨è€…åœ¨ [ç—…æ‚£æ ¸å¿ƒè³‡æ–™] ä¸­æä¾›çš„è³‡è¨Š (ç—…å²ã€Labã€ç”¨è—¥ç­‰)ã€‚
2.  è‡ªå‹•è­˜åˆ¥å‡ºæœ€ç›¸é—œçš„ä¸»è¦ç—…ç—‡ã€‚
3.  (æœ€é‡è¦) **ä½¿ç”¨ Google æœå°‹ä¾†æŸ¥æ‰¾ä¸¦ç¢ºèª**è©²ç—…ç—‡**ã€Œå¯¦éš›çš„æœ€æ–°æŒ‡å¼•ç‰ˆæœ¬å’Œå¹´ä»½ã€**ã€‚
    * ä¾‹å¦‚ï¼šæœå°‹ "latest GINA guideline update", "current GOLD report version", "AHA hypertension guideline latest year"ã€‚
    * æ‚¨å¿…é ˆç†è§£ï¼ŒæŒ‡å¼•**ä¸¦éæ¯å¹´æ›´æ–°**ã€‚æ‚¨çš„ç›®æ¨™æ˜¯æ‰¾åˆ°é‚£å€‹ã€Œå¯¦éš›çš„ã€å¹´ä»½ã€‚

    // --- ğŸš¨ ç¬¬ 3.1 é» (å¼·åˆ¶å„ªå…ˆç´š) ---
    3.1 åœ¨æœå°‹æŒ‡å¼•æ™‚ï¼Œæ‚¨**å¿…é ˆ**å„ªå…ˆæŸ¥æ‰¾ä¸¦å¼•ç”¨ä»¥ä¸‹å…¨çƒå…¬èªçš„æ¬Šå¨ä¾†æºï¼š
        * **å¿ƒè¡€ç®¡:** ACC/AHA, ESC
        * **è…«ç˜¤:** NCCN, ASCO, ESMO
        * **ç³–å°¿ç—…/å…§åˆ†æ³Œ:** ADA, AACE
        * **èƒ¸è…” (COPD/Asthma):** GOLD, GINA
        * **æ„ŸæŸ“:** IDSA
        * **è…è‡Ÿ:** KDIGO
        * **é¢¨æ¿•å…ç–«:** ACR, EULAR
        å¦‚æœ**ç¢ºå¯¦ç„¡æ³•**åœ¨é€™äº›ä¾†æºä¸­æ‰¾åˆ°ç›´æ¥ç›¸é—œçš„æœ€æ–°æŒ‡å¼•ï¼Œæ‰èƒ½åƒè€ƒå…¶ä»–ä¿¡è­½è‰¯å¥½çš„ä¾†æºï¼Œä½†**å¿…é ˆåœ¨ (A) ä¸­æ˜ç¢ºèªªæ˜**æ‚¨ç‚ºä½•é¸æ“‡äº†æ›¿ä»£ä¾†æºã€‚
    // --- ğŸš¨ çµæŸ ---

4.  (é‡è¦) **è«‹åˆ†æ**ç—…æ‚£ç›®å‰ç”¨è—¥æ¸…å–®ä¸­çš„**æ½›åœ¨è—¥ç‰©äº¤äº’ä½œç”¨ (DDI)** æˆ–**é‡è¤‡ç”¨è—¥ (Duplicate Therapy)**ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Google æœå°‹ä¾†è¼”åŠ©é©—è­‰ã€‚
5.  (v14.1) å¦‚æœä½¿ç”¨è€…æä¾›äº† [å°ˆç§‘ç„¦é»] (ä¾‹å¦‚ "å¿ƒè‡Ÿå…§ç§‘")ï¼Œæ‚¨çš„è©•ä¼°æ‡‰æ›´å´é‡æ–¼è©²é ˜åŸŸï¼Œä¸¦**å„ªå…ˆåƒè€ƒè©²é ˜åŸŸçš„æ¬Šå¨æŒ‡å¼•** (å¦‚ ACC/AHA)ã€‚

6.  (v16.2) ä½¿ç”¨è€…å·²åœ¨ App ä¸­ä½¿ç”¨è¨ˆç®—æ©Ÿï¼Œä¸¦åœ¨ [APPè¨ˆç®—çµæœ] æ¬„ä½æä¾›äº†ã€Œå·²ç®—å‡ºçš„å€¼ã€ã€‚æ‚¨**å¿…é ˆ**å°‡é€™äº›ã€Œè¨ˆç®—çµæœã€æ•´åˆåˆ°æ‚¨çš„ (O) å®¢è§€è³‡æ–™æˆ– (A) è©•ä¼°ä¸­ã€‚
    * **å‚™æ´é‚è¼¯ï¼š** å¦‚æœ [APPè¨ˆç®—çµæœ] æ¬„ä½ç‚ºç©º (ä»£è¡¨ä½¿ç”¨è€…æœªè¨ˆç®—)ï¼Œæ‚¨æ‰éœ€è¦åƒä»¥å‰ä¸€æ¨£ï¼Œè‡ªè¡Œå¾ [ç—…æ‚£æ ¸å¿ƒè³‡æ–™] ä¸­æŠ“å– eGFR, Lab, Age ç­‰è³‡è¨Šä¾†é€²è¡Œè©•ä¼°ã€‚

7.  (v16.2 æ–°å¢ä»»å‹™) å¦‚æœä½¿ç”¨è€…åœ¨ [å¥ä¿çµ¦ä»˜è¦ç¯„] æ¬„ä½æä¾›äº†è³‡è¨Šï¼Œæ‚¨**å¿…é ˆ**å°‡å…¶ä½œç‚º**æœ€é«˜å„ªå…ˆç´š**çš„è©•ä¼°é …ç›®ä¹‹ä¸€ã€‚
    * æ‚¨çš„ä»»å‹™æ˜¯ï¼š**æ ¹æ“šç—…æ‚£çš„è¨ºæ–·ã€Labã€å’Œè¨ˆç®—å‡ºçš„åˆ†æ•¸ (å¦‚ Child-Pugh, CrCl)ï¼Œåš´æ ¼åˆ¤æ–·**ç›®å‰çš„è™•æ–¹æ˜¯å¦ç¬¦åˆé€™äº›å¥ä¿è¦ç¯„ã€‚
    * å¿…é ˆåœ¨ (A) æˆ– (P) ä¸­æå‡ºæ‚¨çš„**æ˜ç¢ºè©•ä¼°** (ä¾‹å¦‚ï¼š"ç¬¦åˆ OOO è—¥ç‰©çš„å¥ä¿çµ¦ä»˜æ¢ä»¶" æˆ– "ç›®å‰ Child-Pugh Bï¼Œä¸ç¬¦åˆ OOO çµ¦ä»˜æ¨™æº–ï¼Œæé­æ ¸åˆª")ã€‚

8.  (v15.2) ä½¿ç”¨è€…å¯èƒ½æœƒåœ¨ [UpToDate è³‡æ–™], [Micromedex è³‡æ–™], [OpenEvidence è³‡æ–™] æ¬„ä½æä¾›è£œå……è³‡è¨Šã€‚
9.  (v15.2) å¦‚æœç¬¬ 8 é»çš„æ¬„ä½ã€Œæœ‰å…§å®¹ã€ï¼Œæ‚¨**å¿…é ˆ**å°‡é€™äº›é‡é»æ•´åˆåˆ°æ‚¨çš„ (A) æˆ– (P) ä¸­ï¼Œä¸¦ä¸”**ã€Œæ˜ç¢ºè¨»æ˜ä¾†æºã€**(ä¾‹å¦‚ï¼š"æ ¹æ“š Micromedex è³‡æ–™..." æˆ– "UpToDate äº¦æŒ‡å‡º...")ã€‚å¦‚æœæ¬„ä½ç‚ºç©ºï¼Œå‰‡å¿½ç•¥ã€‚
10. æ ¹æ“šã€ŒSOAPã€æ ¼å¼ï¼Œæ’°å¯«ä¸€ä»½å°ˆæ¥­ã€ç²¾ç¢ºã€æ ¼å¼åŒ–çš„è—¥å¸«ç­†è¨˜è‰ç¨¿ (ä¿ç•™ç²—é«”å’Œæ›è¡Œ)ã€‚
11. åœ¨æ‚¨çš„ã€ŒAssessment (A)ã€éƒ¨åˆ†ï¼š
    * **(v14.1 å¼·åˆ¶)** **å¿…é ˆæ˜ç¢ºæåŠ**æ‚¨åƒè€ƒçš„æŒ‡å¼•åç¨±èˆ‡**ã€Œå¯¦éš›å¹´ä»½ã€** (ä¾‹å¦‚ï¼š"æ ¹æ“š GINA 2024 æŒ‡å¼•...")ï¼Œ**ä¸”è©²æŒ‡å¼•æ‡‰å„ªå…ˆä¾†è‡ªç¬¬ 3.1 é»çš„æ¸…å–®**ã€‚
    * **(v14.1 å¼·åˆ¶)** **å¿…é ˆå¼•ç”¨**è©²æŒ‡å¼•ä¸­çš„**ã€Œç²¾ç¢ºåŸæ–‡å¥å­ã€**ä¾†æ”¯æŒæ‚¨çš„è‡¨åºŠæ±ºç­– (ä¾‹å¦‚ï¼š"...GINA 2024 å»ºè­°... (åŸæ–‡: '...')")ã€‚
    * **å¿…é ˆåŒ…å«**æ‚¨å° DDI æˆ–é‡è¤‡ç”¨è—¥çš„è©•ä¼°ã€‚
    * **å¿…é ˆåŒ…å«**å°è…åŠŸèƒ½ (eGFR æˆ– æ‚¨æ”¶åˆ°çš„ CrCl (C-G), CKD-EPI) çš„è€ƒé‡èˆ‡åŠ‘é‡è©•ä¼°ã€‚
    * **(v16.1)** **å¿…é ˆåŒ…å«**å°è‚åŠŸèƒ½ (æ‚¨æ”¶åˆ°çš„ Child-Pugh Score) çš„è€ƒé‡èˆ‡åŠ‘é‡è©•ä¼°ã€‚
    * **(v16.1)** è‹¥æä¾›äº† BSAï¼Œæ‡‰è©•ä¼°æ˜¯å¦éœ€ç”¨æ–¼åŒ–ç™‚è—¥ç‰©ç­‰åŠ‘é‡è¨ˆç®—ã€‚
    * **(v16.2)** **å¿…é ˆåŒ…å«**æ‚¨å°å¥ä¿è¦ç¯„çš„æ ¸å°çµæœ (å¦‚æœä½¿ç”¨è€…æœ‰æä¾›è¦ç¯„)ã€‚

12. åœ¨æ‚¨çš„ã€ŒPlan (P)ã€éƒ¨åˆ†ï¼š
    * æ‚¨çš„æ‰€æœ‰å»ºè­°éƒ½å¿…é ˆ**ç¬¦åˆ**æ‚¨åœ¨ (A) ä¸­æåˆ°çš„æœ€æ–°æŒ‡å¼•ï¼Œä¸¦ä¸”**ä¸å¾—é•å** (A) ä¸­æåˆ°çš„å¥ä¿çµ¦ä»˜è¦ç¯„ã€‚

13. (*** v16.0 é«”é‡è©•ä¼°é‚è¼¯ ***)
    * å¦‚æœæ‚¨åœ¨ [APPè¨ˆç®—çµæœ] ä¸­æ”¶åˆ° "ä½æ–¼ABWç¯„åœå…§" æˆ–é¡ä¼¼çš„æè¿°ï¼Œé€™ä»£è¡¨ç—…æ‚£çš„ã€Œå¯¦éš›é«”é‡ã€å·²è¶…éã€Œç†æƒ³é«”é‡ã€ä¸€å®šæ¯”ä¾‹ã€‚
    * åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œæ‚¨åœ¨ (A) æˆ– (P) ä¸­è©•ä¼°è—¥ç‰©åŠ‘é‡æ™‚ (ç‰¹åˆ¥æ˜¯æ°´æº¶æ€§è—¥ç‰©)ï¼Œå¿…é ˆæ„è­˜åˆ°**ä¸æ‡‰**ç›´æ¥ä½¿ç”¨å¯¦éš›é«”é‡ (TBW) æˆ–ç†æƒ³é«”é‡ (IBW)ï¼Œè€Œæ‡‰**å»ºè­°**ä½¿ç”¨ã€Œèª¿æ•´é«”é‡ (Adjusted Body Weight, ABW)ã€ä¾†è¨ˆç®—ï¼Œä¸¦åœ¨ç­†è¨˜ä¸­æåŠé€™ä¸€é» (ä¾‹å¦‚ï¼š "ç—…æ‚£é«”é‡ä½æ–¼ABWç¯„åœï¼Œå»ºè­°ä½¿ç”¨ ABW (Adjusted Body Weight) é€²è¡ŒåŠ‘é‡è¨ˆç®—..."ï¼‰ã€‚

14. (*** v16.2 æ ¼å¼è¦æ±‚ ***)
    * æ‚¨çš„å›è¦†**å¿…é ˆ**åš´æ ¼éµå®ˆæ­¤æ ¼å¼ï¼š
    [å®Œæ•´çš„ SOAP ç­†è¨˜ (S, O, A, P)]
    ---GUIDELINES_USED---
    * [æŒ‡å¼• 1 åç¨±] - [å¹´ä»½] (æ‡‰å„ªå…ˆä¾†è‡ªç¬¬ 3.1 é»æ¸…å–®)
    * [æŒ‡å¼• 2 åç¨±] - [å¹´ä»½]
    * [å…¶ä»–åƒè€ƒçš„ DDI è³‡æ–™åº«æˆ–æ–‡ç»]
    * (v15.2) [è‹¥æœ‰ä½¿ç”¨ UpToDate, è«‹è¨»æ˜]
    * (v15.2) [è‹¥æœ‰ä½¿ç”¨ Micromedex, è«‹è¨»æ˜]
    * (v15.2) [è‹¥æœ‰ä½¿ç”¨ OpenEvidence, è«‹è¨»æ˜]
    * (v16.1) [è‹¥æœ‰ä½¿ç”¨ APPè¨ˆç®—çµæœ (CrCl/BW/CHA2DS2-VASc/BSA/CKD-EPI/Child-Pugh), è«‹è¨»æ˜]
    * (v16.2) [è‹¥æœ‰ä½¿ç”¨ å¥ä¿çµ¦ä»˜è¦ç¯„, è«‹è¨»æ˜]

15. (*** v14.4 æ ¼å¼ç¦æ­¢ ***)
    * **ç¦æ­¢**åœ¨æ‚¨çš„å›è¦†ä¸­ä½¿ç”¨ä»»ä½• LaTeX èªæ³• (ä¾‹å¦‚ $...$ æˆ– $$...$$ æˆ– \text{})ã€‚
    * å¿…é ˆç›´æ¥ä½¿ç”¨ Unicode å­—å…ƒ (ä¾‹å¦‚ï¼šÎ², Î±, Â°, â‰ˆ, mmHg)ã€‚`;

            // v16.2: æ›´æ–° User Prompt
            let userPrompt = `--- ç—…æ‚£æ ¸å¿ƒè³‡æ–™ (å¿…å¡«) START ---
${patientInfo}
--- ç—…æ‚£æ ¸å¿ƒè³‡æ–™ END ---
`;
            if (specialtyFocus) { userPrompt += `\n--- å°ˆç§‘ç„¦é» (é¸å¡«) ---\n${specialtyFocus}\n`; }
            
            // v16.2: çµ„åˆè¨ˆç®—çµæœ
            // v17.0: é€™äº›è®Šæ•¸ç¾åœ¨æœƒåŒ…å«è‡ªå‹•è§£ææˆ–è¨ˆç®—å¾Œçš„å€¼
            let calcResults = "";
            if (crcl) { calcResults += `Creatine Clearance (Cockcroft-Gault): ${crcl}\n`; }
            if (ckdEpi) { calcResults += `eGFR (CKD-EPI 2021): ${ckdEpi}\n`; }
            if (bwAssessment) { calcResults += `é«”é‡è©•ä¼° (IBW/ABW): ${bwAssessment}\n`; }
            if (bsa) { calcResults += `Body Surface Area (BSA): ${bsa}\n`; }
            if (cha2ds2Score) { calcResults += `CHA2DS2-VASc Score: ${cha2ds2Score}\n`; }
            if (childPugh) { calcResults += `è‚åŠŸèƒ½ (Child-Pugh Score): ${childPugh}\n`; }
            
            if (calcResults) {
                userPrompt += `\n--- APPè¨ˆç®—çµæœ (é¸å¡«) START ---\n${calcResults.trim()}\n--- APPè¨ˆç®—çµæœ END ---\n`;
            }

            if (uptodateInfo) { userPrompt += `\n--- UpToDate è³‡æ–™ (é¸å¡«) START ---\n${uptodateInfo}\n--- UpToDate è³‡æ–™ END ---\n`; }
            if (micromedexInfo) { userPrompt += `\n--- Micromedex è³‡æ–™ (é¸å¡«) START ---\n${micromedexInfo}\n--- Micromedex è³‡æ–™ END ---\n`; }
            if (openevidenceInfo) { userPrompt += `\n--- OpenEvidence è³‡æ–™ (é¸å¡«) START ---\n${openevidenceInfo}\n--- OpenEvidence è³‡æ–™ END ---\n`; }
            // v16.2: æ–°å¢å¥ä¿è³‡æ–™
            if (nhiGuidelinesInfo) { userPrompt += `\n--- å¥ä¿çµ¦ä»˜è¦ç¯„ (é¸å¡«) START ---\n${nhiGuidelinesInfo}\n--- å¥ä¿çµ¦ä»˜è¦ç¯„ END ---\n`; }
            
            userPrompt += `\nè«‹æ ¹æ“šä¸Šè¿°æ‰€æœ‰è³‡è¨Šï¼Œä½¿ç”¨æœ€æ–°çš„åœ‹éš›æŒ‡å¼•ç”¢ç”Ÿä¸€ä»½è—¥å¸« SOAP ç­†è¨˜ã€‚`;

            // console.log("System Prompt:", systemPrompt);
            // console.log("User Prompt:", userPrompt);

            try {
                const { text, sources } = await callGeminiAPI(systemPrompt, userPrompt, true); 
                
                const delimiter = '---GUIDELINES_USED---';
                let soapNote = text;
                let guidelinesText = '';
                let hasContent = false; 

                if (text.includes(delimiter)) {
                    const parts = text.split(delimiter);
                    soapNote = parts[0].trim();
                    guidelinesText = parts[1].trim();
                }
                
                soapNote = soapNote.replace(/\$\$(.*?)\$\$/g, '$1');
                soapNote = soapNote.replace(/\$(.*?)\$/g, '$1');
                soapNote = soapNote.replace(/\\text\{(.*?)\}/g, '$1');
                soapNote = soapNote.replace(/\\beta/g, 'Î²');
                soapNote = soapNote.replace(/\\alpha/g, 'Î±');
                soapNote = soapNote.replace(/\\gamma/g, 'Î³');
                soapNote = soapNote.replace(/\\delta/g, 'Î´');
                soapNote = soapNote.replace(/\\approx/g, 'â‰ˆ');
                soapNote = soapNote.replace(/\\circ/g, 'Â°');
                soapNote = soapNote.replace(/\\textdegree/g, 'Â°');
                soapNote = soapNote.replace(/\\mmHg/g, 'mmHg');
                soapNote = soapNote.replace(/\\/g, ''); 
                soapNote = soapNote.replace(/\{/g, '');
                soapNote = soapNote.replace(/\}/g, '');
                
                let safeHtml = soapNote
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                safeHtml = safeHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                outputDiv.innerHTML = `<pre>${safeHtml}</pre>`;
                
                outputDiv.classList.remove('hidden');
                placeholderDiv.classList.add('hidden');
                infoBox.classList.remove('hidden');

                if (guidelinesText) {
                    const lines = guidelinesText.split('\n').filter(line => line.trim().length > 0);
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        li.className = 'text-gray-800 font-semibold'; 
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }

                if (sources && sources.length > 0) {
                    if (hasContent) {
                        const separator = document.createElement('li');
                        separator.innerHTML = '<hr class="my-2 border-gray-300">';
                        separator.setAttribute("aria-hidden", "true");
                        sourcesList.appendChild(separator);
                    }
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = source.uri;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.className = 'text-blue-600 hover:underline';
                        a.textContent = source.title || 'ç›¸é—œåƒè€ƒæ–‡ä»¶';
                        li.appendChild(a);
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }
                
                if (hasContent) {
                    sourcesContainer.classList.remove('hidden');
                }
                
                copyButton.disabled = false;

            } catch (error) {
                console.error("ç”¢ç”Ÿ SOAP ç­†è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showError(`ç„¡æ³•ç”¢ç”Ÿç­†è¨˜ï¼š${error.message}`);
                copyButton.disabled = true;
            } finally {
                progressBarContainer.style.display = 'none';
                placeholderDiv.classList.remove('animate-pulse');
                generateButton.disabled = !termsCheckbox.checked; 
                if (termsCheckbox.checked) {
                    generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                clearInputsButton.disabled = false;
            }
        });

        // v16.2: æ›´æ–°æ¸…é™¤æŒ‰éˆ•é‚è¼¯
        clearInputsButton.addEventListener('click', () => {
            patientInfoInput.value = '';
            specialtyFocusSelect.value = '';
            uptodateInfoInput.value = '';
            micromedexInfoInput.value = '';
            openevidenceInfoInput.value = '';
            nhiGuidelinesInfoInput.value = ''; // v16.2
            
            // Clear CrCl & IBW/ABW (calc 1)
            calcSex.value = 'Male';
            calcAge.value = '';
            calcWeight.value = '';
            calcHeight.value = '';
            calcScr.value = '';
            setCalcResult(crclResult, "", "");
            setCalcResult(bwResult, "", "");

            // Clear CHA2DS2-VASc (calc 2)
            c2vAgeLess65.checked = true;
            document.getElementById('c2vSexMale').checked = true;
            c2vChf.checked = false;
            c2vHt.checked = false;
            c2vDm.checked = false;
            c2vStroke.checked = false;
            c2vVd.checked = false;
            setCalcResult(cha2ds2vascResult, "", "");

            // Clear BSA (calc 3)
            setCalcResult(calcBsaResult, "", "");
            
            // Clear CKD-EPI (calc 4)
            setCalcResult(calcCkdEpiResult, "", "");
            
            // Clear Child-Pugh (calc 5)
            document.querySelector('input[name="cpAscites"][value="1"]').checked = true;
            document.querySelector('input[name="cpEnceph"][value="1"]').checked = true;
            document.querySelector('input[name="cpBili"][value="1"]').checked = true;
            document.querySelector('input[name="cpAlb"][value="1"]').checked = true;
            document.querySelector('input[name="cpInr"][value="1"]').checked = true;
            setCalcResult(calcChildPughResult, "", "");

            termsCheckbox.checked = false;
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            
            outputDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            infoBox.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';
            copyButton.disabled = true;
        });

        copyButton.addEventListener('click', () => {
            const preElement = outputDiv.querySelector('pre');
            const textToCopy = preElement ? (preElement.textContent || preElement.innerText) : '';

            if (!textToCopy) {
                showError("æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½ã€‚");
                return;
            }
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.textContent = "å·²è¤‡è£½!";
                    setTimeout(() => { copyButton.textContent = "ä¸€éµè¤‡è£½"; }, 2000);
                } else {
                    showError("è¤‡è£½å¤±æ•—ã€‚ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æ­¤åŠŸèƒ½ã€‚");
                }
            } catch (err) {
                console.error("è¤‡è£½å¤±æ•—: ", err);
                showError(`è¤‡è£½å¤±æ•—ï¼š${err.message}`);
            }
            document.body.removeChild(textArea);
        });
    </script>

    <footer class="text-center py-6 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">
            æœ¬å·¥å…·åŸå§‹ç¢¼èˆ‡æ›´æ–°ç‰ˆå¯æ–¼ 
            <a href="https://github.com/Almightyhao/Google-SOAP-writter" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                https://github.com/Almightyhao/Google-SOAP-writter
            </a>
             æŸ¥æ‰¾
        </p>
    </footer>

</body>
</html>
