<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v20.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .spinner { border-top-color: transparent; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* v18.0: è¦–åœ–åˆ‡æ› */
        .view { display: none; }
        
        /* v18.0: å°è¦½åˆ— */
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
            color: #4b5563; /* text-gray-600 */
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }
        .nav-button.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* v18.1: å°ˆæ¡ˆåˆ—è¡¨æ¨£å¼ */
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem;
            background-color: white;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .project-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6; /* border-blue-500 */
        }
        .project-name {
            font-weight: 600;
            color: #1f2937; /* text-gray-800 */
            cursor: pointer;
            flex-grow: 1;
        }
        .project-date {
            font-size: 0.875rem;
            color: #6b7280; /* text-gray-500 */
            margin-right: 1rem;
        }
        .project-delete-btn {
            background-color: #fee2e2; /* bg-red-100 */
            color: #dc2626; /* text-red-600 */
            border-radius: 9999px;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }
        .project-delete-btn:hover {
            background-color: #dc2626; /* hover:bg-red-600 */
            color: white;
        }
        
        /* v18.1: README å…§å®¹æ¨£å¼ */
        .prose-readme {
             font-size: 0.95rem; line-height: 1.6;
        }
        .prose-readme h1 { font-size: 1.5rem; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 1.5rem; }
        .prose-readme h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; }
        .prose-readme ul, .prose-readme ol { list-style-position: inside; margin-left: 1.5rem; margin-top: 0.5rem; }
        .prose-readme code { background-color: #f3f4f6; color: #c026d3; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        .prose-readme a { color: #2563eb; text-decoration: underline; }
        .prose-readme pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; overflow-x: auto; }

        /* --- v17.4 æ—¢æœ‰æ¨£å¼ (ä¿ç•™) --- */
        .prose pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; }
        #guidelineList li { padding: 4px 0; border-bottom: 1px solid #f3f4f6; }
        #guidelineList li:last-child { border-bottom: none; }
        details summary { cursor: pointer; font-weight: 600; color: #1f2937; background-color: #f9fafb; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; transition: background-color 0.2s; }
        details summary:hover { background-color: #f3f4f6; }
        details[open] summary { background-color: #f3f4f6; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .calculator-content { padding: 1rem; border: 1px solid #e5e7eb; border-top: 0; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: #ffffff; }
        .instruction-step { margin-top: 1rem; }
        .instruction-step h4 { font-weight: 600; color: #1f2937; }
        .instruction-step p { font-size: 0.95rem; color: #374151; }
        .instruction-step code { background-color: #f3f4f6; color: #c026d3; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        #progressBarContainer { display: none; width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 0.75rem; background-color: #3b82f6; border-radius: 9999px; animation: indeterminate-progress 2s linear infinite; }
        @keyframes indeterminate-progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .terms-section { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .terms-section h3 { font-weight: 700; color: #b45309; display: flex; align-items: center; }
        .terms-section ul { list-style-type: decimal; margin-left: 1.5rem; font-size: 0.9rem; margin-top: 0.5rem; line-height: 1.6; }
        .calc-button { background-color: #10b981; color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: background-color 0.2s; }
        .calc-button:hover { background-color: #059669; }
        .calc-result { font-weight: 700; color: #1d4ed8; font-size: 1.125rem; text-align: right; min-height: 28px; }
        .calc-result-nodata { font-weight: 500; color: #9ca3af; font-size: 0.9rem; text-align: right; min-height: 28px; }
        .calc-label { display: block; font-size: 0.875rem; font-medium; color: #374151; margin-bottom: 0.5rem; }
        .calc-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); outline: none; }
        .calc-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        .calc-select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); background-color: white; outline: none; }
        .calc-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        .calc-radio-group { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .calc-radio-label { display: flex; align-items: center; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; }
        .calc-radio-label input { margin-right: 0.5rem; color: #3b82f6; }
        .calc-radio-label:has(input:checked) { background-color: #eff6ff; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v20.0)</h1>
            <p class="mt-2 text-lg text-gray-600">å°ˆæ¡ˆç®¡ç†ãƒ»AI é©…å‹•çš„æŒ‡å¼•æŸ¥æ ¸ãƒ»æ™‚åºåˆ†æãƒ»è‡ªå‹•è£½åœ–</p>
        </header>

        <nav class="bg-white p-2 rounded-lg shadow-md mb-6 flex flex-wrap items-center justify-center gap-2 md:gap-4">
            <button id="nav-home" class="nav-button active">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                ä¸»é  / å°ˆæ¡ˆ
            </button>
            <button id="nav-soap-note" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                SOAP ç­†è¨˜
            </button>
            <button id="nav-calculator" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M16 4h-2a2 2 0 1 0-4 0H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2M8 2v4M16 2v4M12 10h4M12 14h4M12 18h4M8 10h.01M8 14h.01M8 18h.01"></path></svg>
                è‡¨åºŠè¨ˆç®—æ©Ÿ
            </button>
            <button id="nav-settings" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                è¨­å®š
            </button>
        </nav>

        <main>
            <div id="view-home" class="view" style="display: block;">
                
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">å°ˆæ¡ˆç®¡ç†</h2>
                    <button id="newProjectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        æ–°å¢ SOAP ç­†è¨˜å°ˆæ¡ˆ
                    </button>
                    
                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-3">å·²å„²å­˜çš„å°ˆæ¡ˆ</h3>
                    <div id="projectListContainer" class="space-y-3">
                        <p id="noProjectsMessage" class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰å·²å„²å­˜çš„å°ˆæ¡ˆã€‚</p>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">ç‰ˆæœ¬æ›´æ–°èªªæ˜ (ä¾†è‡ª GitHub)</h2>
                    <div id="readme-version-info-container" class="prose-readme">
                        <p class="text-gray-500">æ­£åœ¨å¾ GitHub è¼‰å…¥ README.md...</p>
                        </div>
                    
                    <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700 border-b pb-2">é–‹å§‹ä½¿ç”¨</h2>
                    <div class="prose max-w-none prose-lg">
                        <ol class="list-decimal list-inside space-y-2">
                            <li>
                                è«‹å…ˆå‰å¾€ <button id="nav-settings-shortcut" class="text-blue-600 font-medium hover:underline inline-block p-0 border-0 bg-transparent cursor-pointer">ã€Œè¨­å®šã€</button> é é¢ï¼Œè¼¸å…¥ä¸¦å„²å­˜æ‚¨çš„ API é‡‘é‘°ã€‚
                            </li>
                            <li>
                                ç„¶å¾Œå‰å¾€ <button id="nav-soap-note-shortcut" class="text-blue-600 font-medium hover:underline inline-block p-0 border-0 bg-transparent cursor-pointer">ã€ŒSOAP ç­†è¨˜ã€</button> é é¢ï¼Œé–‹å§‹æ‚¨çš„å·¥ä½œã€‚
                            </li>
                        </ol>
                    </div>
                </section>
            </div>
<div id="view-soap-note" class="view">
                
                <section class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div class="md:col-span-1">
                            <label for="projectNameInput" class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                            <input type="text" id="projectNameInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±...">
                        </div>
                        <div class="md:col-span-2 flex flex-wrap gap-2 justify-end items-center">
                            <button id="saveProjectButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 flex-grow md:flex-grow-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 w-5 h-5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                å„²å­˜
                            </button>
                            <button id="saveAsProjectButton" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 flex-grow md:flex-grow-0">
                                å¦å­˜æ–°æª”
                            </button>
                            <button id="deleteProjectButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-all duration-200 flex-grow md:flex-grow-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 w-5 h-5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                     <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>
                         AI çŸ¥è­˜åº«å³æ™‚ç‹€æ…‹
                     </h2>
                     <button id="queryGuidelinesButton" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 flex items-center justify-center">
                         <div id="guidelineSpinner" class="spinner border-4 border-white rounded-full mr-3 hidden"></div>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                         å³æ™‚æŸ¥è©¢ä¸»è¦æŒ‡å¼•ç‰ˆæœ¬
                     </button>
                     <div id="guidelineListContainer" class="mt-4 hidden">
                         <h3 class="text-lg font-semibold text-gray-800 mb-2">å³æ™‚æŸ¥è©¢çµæœï¼š</h3>
                         <ul id="guidelineList" class="text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200"></ul>
                     </div>
                </section>
                
                <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                                1. è¼¸å…¥ç—…æ‚£è³‡æ–™
                            </h2>
                            <button id="clearInputsButton" class="text-sm text-slate-500 hover:text-red-600 font-medium py-1 px-2 rounded-lg hover:bg-red-50 transition-all duration-200 hover:scale-105 hover:shadow-md flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                ä¸€éµæ¸…é™¤
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <label for="specialtyFocus" class="block text-sm font-medium text-gray-600 mb-2">å°ˆç§‘ç„¦é» (é¸å¡«)</label>
                            <select id="specialtyFocus" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="" selected>ç„¡ç‰¹å®šç§‘åˆ¥ (ç¶œåˆè©•ä¼°)</option>
                                <option value="å¿ƒè‡Ÿå…§ç§‘">å¿ƒè‡Ÿå…§ç§‘ (Cardiology)</option>
                                <option value="èƒ¸è…”å…§ç§‘">èƒ¸è…”å…§ç§‘ (Pulmonology)</option>
                                <option value="è…è‡Ÿå…§ç§‘">è…è‡Ÿå…§ç§‘ (Nephrology)</option>
                                <option value="æ„ŸæŸ“ç§‘">æ„ŸæŸ“ç§‘ (Infectious Disease)</option>
                                <option value="æ–°é™³ä»£è¬ç§‘">æ–°é™³ä»£è¬ç§‘ (Metabolism)</option>
                                <option value="é¢¨æ¿•å…ç–«ç§‘">é¢¨æ¿•å…ç–«ç§‘ (Rheumatology)</option>
                                <option value="è¡€æ¶²è…«ç˜¤ç§‘">è¡€æ¶²è…«ç˜¤ç§‘ (Hemato-Oncology)</option>
                                <option value="è…¸èƒƒè‚è†½ç§‘">è…¸èƒƒè‚è†½ç§‘ (Gastroenterology)</option>
                                <option value="ç¥ç¶“å…§ç§‘">ç¥ç¶“å…§ç§‘ (Neurology)</option>
                                <option value="åŠ è­·ç—…æˆ¿">åŠ è­·ç—…æˆ¿ (ICU)</option>
                            </select>
                        </div>

                        <div class="terms-section">
                            <h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-yellow-600"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>ä½¿ç”¨æ¢æ¬¾ (å¿…è®€)</h3>
                            <ul>
                                <li>ä½¿ç”¨è€…æ‰¿è«¾ï¼Œæ‰€æœ‰è¼¸å…¥è³‡æ–™**å‡å·²å®Œæˆã€Œå»è­˜åˆ¥åŒ–ã€**ã€‚</li>
                                <li>è‹¥ä½¿ç”¨è€…é•åæ‰¿è«¾ï¼Œè¼¸å…¥ã€Œå¯è­˜åˆ¥ã€çš„å€‹äººè³‡æ–™ï¼Œ**æ‰€æœ‰ç›¸é—œæ³•å¾‹è²¬ä»»ç”±è©²ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ“”**ã€‚</li>
                                <li>**è«‹å†æ¬¡ç¢ºèªè³‡æ–™ä¸å«ä»»ä½•å¯è­˜åˆ¥å€‹äººçš„è³‡è¨Šå¾Œï¼Œå†æŒ‰ä¸‹ã€Œå•Ÿå‹• AI åˆ†æã€æŒ‰éˆ•ã€‚**</li>
                            </ul>
                        </div>
                        <div class="flex items-center mb-4">
                            <input id="termsCheckbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="termsCheckbox" class="ml-2 block text-sm text-gray-900">æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°ã€Œä½¿ç”¨æ¢æ¬¾ã€ã€‚</label>
                        </div>
                        <div class="mb-4">
                            <label for="patientInfo" class="block text-sm font-medium text-gray-600 mb-2">ç—…æ‚£æ ¸å¿ƒè³‡æ–™ (AI åˆ†æç”¨)<span class="text-xs text-gray-500">(ä¾‹å¦‚ï¼šAge: 70, Sex: M, SCr: 1.2 (10/1) -> 1.5 (10/2)...)</span></label>
                            <textarea id="patientInfo" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è²¼å…¥ã€Œå»è­˜åˆ¥åŒ–ã€å¾Œçš„ç—…æ‚£è³‡è¨Š..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="chartingDataInput" class="block text-sm font-medium text-gray-600 mb-2">
                                è¦–è¦ºåŒ–åœ–è¡¨è³‡æ–™ (è£½åœ–ç”¨)
                                <span class="text-xs text-gray-500">(ä¾‹å¦‚ï¼šSCr: 1.2(10/1), 1.5(10/2) | Vanco: (10/1-10/5))</span>
                            </label>
                            <textarea id="chartingDataInput" rows="5" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¸€è¡Œä¸€å€‹ Lab (SCr, WBC...) æˆ–è—¥ç‰© (Vanco, Mero...)..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="uptodateInfo" class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ UpToDate (é¸å¡«)</label>
                            <textarea id="uptodateInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Š UpToDate çš„é‡é»..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="micromedexInfo" class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ Micromedex (é¸å¡«)</label>
                            <textarea id="micromedexInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Š Micromedex çš„é‡é»..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="openevidenceInfo" class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ OpenEvidence (é¸å¡«)</label>
                            <textarea id="openevidenceInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Š OpenEvidence çš„é‡é»..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="nhiGuidelinesInfo" class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆå¥ä¿çµ¦ä»˜è¦ç¯„ (é¸å¡«)</label>
                            <textarea id="nhiGuidelinesInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Šç›¸é—œè—¥å“çš„å¥ä¿çµ¦ä»˜è¦ç¯„..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="apiProviderSelect" class="block text-sm font-medium text-gray-600 mb-2">AI æ¨¡å‹é¸æ“‡</label>
                            <select id="apiProviderSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="gemini" selected>Google Gemini (gemini-2.5-flash-preview)</option>
                                <option value="grok">Grok (xAI)</option>
                            </select>
                        </div>
                        <div class="mt-auto pt-4">
                            <button id="generateButton" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 ease-in-out hover:scale-105 flex items-center justify-center opacity-70 cursor-not-allowed" disabled>
                                ğŸš€ å•Ÿå‹• AI åˆ†æ & è£½åœ–
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>2. ç”¢ç”Ÿçš„ç­†è¨˜è‰ç¨¿</h2>
                             <button id="copyButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ä¸€éµè¤‡è£½</button>
                        </div>
                        <div id="progressBarContainer"><div class="progress-bar"></div></div>
                        
                        <div id="autoCalcDisplay" class="hidden mb-4 bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">è‡ªå‹•è¨ˆç®—åƒè€ƒ (åƒ…ä¾›è—¥å¸«æŸ¥æ ¸ï¼Œæœªå‚³é€ç»™ AI)ï¼š</h4>
                            <div id="autoCalcList" class="text-sm space-y-1"></div>
                        </div>
                        
                        <div id="chartsContainer" class="hidden mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <div id="labChartsContainer">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">Lab æ•¸æ“šè¶¨å‹¢åœ–</h3>
                                <div id="labChartsGoHere">
                                    </div>
                                <p id="noLabChartMessage" class="text-gray-500 text-center py-2 hidden">æœªåœ¨ã€Œè¦–è¦ºåŒ–åœ–è¡¨è³‡æ–™ã€æ¬„ä½ä¸­åµæ¸¬åˆ°å¯ç¹ªè£½çš„ Lab æ•¸æ“š (ä¾‹å¦‚ï¼šSCr, K+)ã€‚</p>
                            </div>
                            
                            <div id="ganttChartContainer" class="mt-6">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ç”¨è—¥å²ç”˜ç‰¹åœ–</h3>
                                <div id="ganttChartGoHere">
                                    <canvas id="ganttChartCanvas" style="max-height: 300px;"></canvas>
                                </div>
                                <p id="noGanttChartMessage" class="text-gray-500 text-center py-2 hidden">æœªåœ¨ã€Œè¦–è¦ºåŒ–åœ–è¡¨è³‡æ–™ã€æ¬„ä½ä¸­åµæ¸¬åˆ°å¯ç¹ªè£½çš„ç”¨è—¥å² (ä¾‹å¦‚ï¼šVanco: 10/1-10/5)ã€‚</p>
                            </div>
                        </div>


                        <div id="placeholder" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-lg transition-opacity duration-300">
                            <p class="font-semibold">AI å°‡è‡ªå‹•åŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š</p>
                            <ul class="list-disc list-inside text-left mt-2 text-sm">
                                <li>(v20.0) **è‡ªå‹•ç¹ªè£½**ã€Œè¦–è¦ºåŒ–åœ–è¡¨è³‡æ–™ã€ä¸­çš„ Lab è¶¨å‹¢åœ–èˆ‡ç”¨è—¥å²ç”˜ç‰¹åœ–ã€‚</li>
                                <li>(v18.2) åˆ†æã€Œç—…æ‚£æ ¸å¿ƒè³‡æ–™ã€ä¸­çš„æ™‚åºæ€§è³‡æ–™ (ä¾‹å¦‚ SCr è¶¨å‹¢)ã€‚</li>
                                <li>(v18.0) è‡ªå‹•è§£æã€Œç—…æ‚£æ ¸å¿ƒè³‡æ–™ã€ä¸¦åœ¨ã€Œè‡ªå‹•è¨ˆç®—åƒè€ƒå€ã€é¡¯ç¤ºçµæœã€‚</li>
                                <li>(v16.2) **è‡ªå‹•æ ¸å°æ‚¨æä¾›çš„ã€Œå¥ä¿çµ¦ä»˜è¦ç¯„ã€**ï¼Œè©•ä¼°æ ¸åˆªé¢¨éšªã€‚</li>
                            </ul>
                            <p class="text-sm mt-4">æ‰€æœ‰å…§å®¹å‡éœ€ç”±å°ˆæ¥­è—¥å¸«æœ€çµ‚å¯©æ ¸ã€‚</p>
                        </div>
                        <div id="output" class="hidden prose max-w-none prose-pre:whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 200px;"></div>
                        
                        <div id="infoBox" class="hidden mt-4 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm">AI è¼”åŠ©èªªæ˜ (v20.0)ï¼š</h4>
                            <ul class="list-disc list-inside text-sm mt-1">
                                <li><strong>è‡ªå‹•è£½åœ– (æ–°)ï¼š</strong> ç³»çµ±å·²è‡ªå‹•è§£æã€Œè¦–è¦ºåŒ–åœ–è¡¨è³‡æ–™ã€æ¬„ä½ä¸¦ç¹ªè£½ Lab åœ–èˆ‡ç”˜ç‰¹åœ–ã€‚</li>
                                <li><strong>æ™‚åºåˆ†æï¼š</strong> AI å·²è¢«æŒ‡ç¤º**å¿…é ˆ**åˆ†æã€Œç—…æ‚£æ ¸å¿ƒè³‡æ–™ã€ä¸­çš„ Lab data å‹•æ…‹è¶¨å‹¢ã€‚</li>
                                <li><strong>è‡ªå‹•å›å¡«ï¼š</strong> ç³»çµ±å·²è‡ªå‹•è§£æã€Œç—…æ‚£æ ¸å¿ƒè³‡æ–™ã€ä¸¦åœ¨ã€Œè‡ªå‹•è¨ˆç®—åƒè€ƒå€ã€é¡¯ç¤ºçµæœã€‚</li>
                                <li><strong>å¥ä¿æ ¸å°ï¼š</strong> AI å·²è¢«æŒ‡ç¤º**å¿…é ˆ**æ ¸å°æ‚¨æä¾›çš„å¥ä¿è¦ç¯„ã€‚</li>
                            </ul>
                        </div>
                        <div id="sourcesContainer" class="hidden mt-6">
                            <h3 id="sourcesTitle" class="text-lg font-semibold text-gray-600 mb-2">å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æºï¼š</h3>
                            <ul id="sourcesList" class="list-none list-inside text-sm space-y-1"></ul>
                        </div>
                    </div>
                </main>
            </div>
<div id="view-calculator" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">è‡¨åºŠè¨ˆç®—æ©Ÿ (æ‰‹å‹•)</h2>
                    <p class="text-gray-600 mb-6">æ­¤é é¢åƒ…ä¾›æ‚¨æ‰‹å‹•è¨ˆç®—ã€‚SOAP ç­†è¨˜é é¢æœƒè‡ªå‹•è§£æç—…æ‚£è³‡æ–™ä¸¦åœ¨èƒŒæ™¯è¨ˆç®—ï¼Œä¸å—æ­¤è™•æ•¸å€¼å½±éŸ¿ã€‚</p>
                    <div class="space-y-4">
                        <details>
                            <summary class="flex justify-between items-center"><span>1. CrCl (C-G) & IBW/ABW è¨ˆç®—</span><span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span></summary>
                            <div class="calculator-content space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="manual_calcSex" class="calc-label">æ€§åˆ¥</label><select id="manual_calcSex" class="calc-select"><option value="Male">ç”·æ€§</option><option value="Female">å¥³æ€§</option></select></div>
                                    <div><label for="manual_calcAge" class="calc-label">å¹´é½¡ (years)</label><input type="number" id="manual_calcAge" class="calc-input" placeholder="ä¾‹å¦‚: 70"></div>
                                    <div><label for="manual_calcWeight" class="calc-label">é«”é‡ (kg)</label><input type="number" id="manual_calcWeight" class="calc-input" placeholder="ä¾‹å¦‚: 65"></div>
                                    <div><label for="manual_calcHeight" class="calc-label">èº«é«˜ (cm)</label><input type="number" id="manual_calcHeight" class="calc-input" placeholder="ä¾‹å¦‚: 170"></div>
                                    <div><label for="manual_calcScr" class="calc-label">è¡€æ¸…è‚Œé…¸é… (SCr, mg/dL)</label><input type="number" id="manual_calcScr" class="calc-input" placeholder="ä¾‹å¦‚: 1.2"></div>
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateCrClBwButton" class="calc-button">è¨ˆç®— CrCl & IBW/ABW</button>
                                    <div class="text-right"><span id="manual_crclResult" class="calc-result block"></span><span id="manual_bwResult" class="calc-result block"></span></div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>2. CHAâ‚‚DSâ‚‚-VASc é¢¨éšªè¨ˆç®—</span><span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span></summary>
                            <div class="calculator-content space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <fieldset><legend class="calc-label">å¹´é½¡ (Age)</legend><div class="space-y-2">
                                        <div class="flex items-center"><input id="manual_c2vAge<65" name="manual_c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="0" checked><label for="manual_c2vAge<65" class="ml-2 block text-sm text-gray-900">&lt; 65 æ­² (0 åˆ†)</label></div>
                                        <div class="flex items-center"><input id="manual_c2vAge65-74" name="manual_c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="1"><label for="manual_c2vAge65-74" class="ml-2 block text-sm text-gray-900">65-74 æ­² (+1 åˆ†)</label></div>
                                        <div class="flex items-center"><input id="manual_c2vAge>=75" name="manual_c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="2"><label for="manual_c2vAge>=75" class="ml-2 block text-sm text-gray-900">â‰¥ 75 æ­² (+2 åˆ†)</label></div>
                                    </div></fieldset>
                                    <fieldset><legend class="calc-label">æ€§åˆ¥ (Sex)</legend><div class="space-y-2">
                                        <div class="flex items-center"><input id="manual_c2vSexMale" name="manual_c2vSex" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="0" checked><label for="manual_c2vSexMale" class="ml-2 block text-sm text-gray-900">ç”·æ€§ (0 åˆ†)</label></div>
                                        <div class="flex items-center"><input id="manual_c2vSexFemale" name="manual_c2vSex" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="1"><label for="manual_c2vSexFemale" class="ml-2 block text-sm text-gray-900">å¥³æ€§ (+1 åˆ†)</label></div>
                                    </div></fieldset>
                                </div>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                                    <div class="flex items-center"><input id="manual_c2vChf" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vChf" class="ml-2 block text-sm text-gray-900">å¿ƒè‡Ÿè¡°ç«­ (CHF) (+1)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vHt" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vHt" class="ml-2 block text-sm text-gray-900">é«˜è¡€å£“ (Hypertension) (+1)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vDm" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vDm" class="ml-2 block text-sm text-gray-900">ç³–å°¿ç—… (Diabetes) (+1)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vStroke" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vStroke" class="ml-2 block text-sm text-gray-900">ä¸­é¢¨/TIA/TE (+2)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vVd" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vVd" class="ml-2 block text-sm text-gray-900">è¡€ç®¡ç–¾ç—… (Vascular) (+1)</label></div>
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateCha2ds2vascButton" class="calc-button">è¨ˆç®—åˆ†æ•¸</button>
                                    <span id="manual_cha2ds2vascResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>3. BSA (Mosteller) è¨ˆç®—</span><span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span></summary>
                            <div class="calculator-content space-y-4">
                                <p class="text-sm text-gray-500">è«‹åœ¨ (1) ä¸­è¼¸å…¥èº«é«˜èˆ‡é«”é‡ã€‚</p>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateBsaButton" class="calc-button">è¨ˆç®— BSA</button>
                                    <span id="manual_calcBsaResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>4. eGFR (CKD-EPI 2021) è¨ˆç®—</span><span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span></summary>
                            <div class="calculator-content space-y-4">
                                <p class="text-sm text-gray-500">è«‹åœ¨ (1) ä¸­è¼¸å…¥æ€§åˆ¥ã€å¹´é½¡ã€SCrã€‚</p>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateCkdEpiButton" class="calc-button">è¨ˆç®— eGFR (CKD-EPI)</button>
                                    <span id="manual_calcCkdEpiResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>5. Child-Pugh Score (è‚åŠŸèƒ½) è¨ˆç®—</span><span class="text-sm font-normal text-blue-600">é»æ“Šå±•é–‹</span></summary>
                            <div class="calculator-content space-y-4">
                                <fieldset><legend class="calc-label">è…¹æ°´ (Ascites)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpAscites" value="1" checked> ç„¡ (1 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAscites" value="2"> è¼•å¾® (2 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAscites" value="3"> ä¸­/é‡åº¦ (3 åˆ†)</label></div></fieldset>
                                <fieldset><legend class="calc-label">è‚è…¦ç—…è®Š (Encephalopathy)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpEnceph" value="1" checked> ç„¡ (1 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpEnceph" value="2"> ç¬¬ 1-2 ç´š (2 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpEnceph" value="3"> ç¬¬ 3-4 ç´š (3 åˆ†)</label></div></fieldset>
                                <fieldset><legend class="calc-label">é»ƒç–¸æŒ‡æ•¸ (Bilirubin, mg/dL)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpBili" value="1" checked> &lt; 2 (1 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpBili" value="2"> 2 - 3 (2 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpBili" value="3"> &gt; 3 (3 åˆ†)</label></div></fieldset>
                                <fieldset><legend class="calc-label">ç™½è›‹ç™½ (Albumin, g/dL)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpAlb" value="1" checked> &gt; 3.5 (1 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAlb" value="2"> 2.8 - 3.5 (2 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAlb" value="3"> &lt; 2.8 (3 åˆ†)</label></div></fieldset>
                                <fieldset><legend class="calc-label">å‡è¡€æ™‚é–“ (INR)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpInr" value="1" checked> &lt; 1.7 (1 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpInr" value="2"> 1.7 - 2.3 (2 åˆ†)</label><label class="calc-radio-label"><input type="radio" name="manual_cpInr" value="3"> &gt; 2.3 (3 åˆ†)</label></div></fieldset>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateChildPughButton" class="calc-button">è¨ˆç®— Child-Pugh Score</button>
                                    <span id="manual_calcChildPughResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                    </div>
                </section>
            </div>

            <div id="view-settings" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6 border-l-4 border-blue-500">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>API é‡‘é‘°è¨­å®š</h2>
                     <p class="text-gray-600 mb-6">é‡‘é‘°å°‡å®‰å…¨åœ°å„²å­˜åœ¨æ‚¨æœ¬æ©Ÿç€è¦½å™¨çš„ `localStorage` ä¸­ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</p>
                     <div class="space-y-6">
                         <div>
                             <label for="geminiApiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API é‡‘é‘°</label>
                             <input type="password" id="geminiApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Šæ‚¨çš„ Google Gemini API é‡‘é‘° (AIzaSy...)">
                             <p id="geminiApiStatus" class="text-sm mt-2 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚</p>
                             <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline">å¦‚ä½•å–å¾— Gemini é‡‘é‘°ï¼Ÿ</a>
                         </div>
                         <div>
                             <label for="grokApiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Grok (xAI) API é‡‘é‘°</label>
                             <input type="password" id="grokApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è²¼ä¸Šæ‚¨çš„ Grok API é‡‘é‘° (gk_...)">
                             <p id="grokApiStatus" class="text-sm mt-2 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚</p>
                             <a href="https://x.ai/docs/api/get-started" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline">å¦‚ä½•å–å¾— Grok é‡‘é‘°ï¼Ÿ</a>
                         </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                         <button id="saveSettingsButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105">å„²å­˜è¨­å®š</button>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white"><div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">ç™¼ç”ŸéŒ¯èª¤</h3>
            <div class="mt-2 px-7 py-3"><p id="errorMessage" class="text-sm text-gray-500">ç„¡æ³•ç”¢ç”Ÿç­†è¨˜ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p></div>
            <div class="items-center px-4 py-3"><button id="closeModalButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">é—œé–‰</button></div>
        </div></div>
    </div>
    
    <footer class="text-center py-6 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">
            æœ¬å·¥å…·åŸå§‹ç¢¼èˆ‡æ›´æ–°ç‰ˆå¯æ–¼ 
            <a href="https://github.com/Almightyhao/Google-SOAP-writter" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                https://github.com/Almightyhao/Google-SOAP-writter
            </a>
             æŸ¥æ‰¾ (v20.0)
        </p>
    </footer>

    <div id="hidden-calc-storage" style="display: none;">
        <input id="calcSex"> <input id="calcAge"> <input id="calcWeight">
        <input id="calcHeight"> <input id="calcScr">
        <span id="crclResult"></span> <span id="bwResult"></span>
        <input id="c2vAge<65"> <input id="c2vAge65-74"> <input id="c2vAge>=75">
        <input id="c2vSexFemale"> <input id="c2vChf"> <input id="c2vHt">
        <input id="c2vDm"> <input id="c2vStroke"> <input id="c2vVd">
        <span id="cha2ds2vascResult"></span> <span id="calcBsaResult"></span>
        <span id="calcCkdEpiResult"></span> <span id="calcChildPughResult"></span>
        <input name="cpAscites" value="1"> <input name="cpEnceph" value="1">
        <input name="cpBili" value="1"> <input name_cpAlb" value="1">
        <input name="cpInr" value="1">
    </div>
<script>
        // === v20.0: å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ===
        let appSettings = {
            apiKeys: {
                gemini: "",
                grok: ""
            },
            projects: [] 
        };
        let currentProjectId = null; 
        let activeCharts = []; // v19.0: å„²å­˜ Chart.js å¯¦ä¾‹ (åŒ…å« Lab å’Œ Gantt)

        // v17.2: æ¨¡å‹åç¨±
        const geminiModelName = "gemini-2.5-flash-preview-09-2025";
        const geminiApiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
        
        // v18.0: Grok æ¨¡å‹åç¨±
        const grokModelName = "grok-1"; // ç¯„ä¾‹
        const grokApiUrlBase = "https://api.x.ai/v1/chat/completions"; // ç¯„ä¾‹

        const appStorageKey = 'smartPharmacistSettings_v20_0'; // v20.0: æ›´æ–°é‡‘é‘°
        // v18.1: GitHub README è¨­å®š
        const githubReadmeUrl = "https://api.github.com/repos/Almightyhao/SOAP-writter/readme";

        // === v18.1: è¦–åœ– (View) DOM å…ƒç´  ===
        const views = {
            home: document.getElementById('view-home'),
            soapNote: document.getElementById('view-soap-note'),
            calculator: document.getElementById('view-calculator'),
            settings: document.getElementById('view-settings'),
        };
        
        // === v18.1: å°è¦½åˆ— (Nav) DOM å…ƒç´  ===
        const navButtons = {
            home: document.getElementById('nav-home'),
            soapNote: document.getElementById('nav-soap-note'),
            calculator: document.getElementById('nav-calculator'),
            settings: document.getElementById('nav-settings'),
        };
        const navSettingsShortcut = document.getElementById('nav-settings-shortcut');
        const navSoapNoteShortcut = document.getElementById('nav-soap-note-shortcut');

        // === v18.1: ä¸»é  (Home) DOM å…ƒç´  ===
        const newProjectButton = document.getElementById('newProjectButton');
        const projectListContainer = document.getElementById('projectListContainer');
        const noProjectsMessage = document.getElementById('noProjectsMessage');
        const readmeContainer = document.getElementById('readme-version-info-container');

        // === v18.1: è¨­å®š (Settings) DOM å…ƒç´  ===
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const grokApiKeyInput = document.getElementById('grokApiKeyInput');
        const geminiApiStatus = document.getElementById('geminiApiStatus');
        const grokApiStatus = document.getElementById('grokApiStatus');
        const saveSettingsButton = document.getElementById('saveSettingsButton');

        // === v18.1 & v20.0: SOAP ç­†è¨˜ (Dashboard) DOM å…ƒç´  ===
        const projectNameInput = document.getElementById('projectNameInput');
        const saveProjectButton = document.getElementById('saveProjectButton');
        const saveAsProjectButton = document.getElementById('saveAsProjectButton');
        const deleteProjectButton = document.getElementById('deleteProjectButton');

        const generateButton = document.getElementById('generateButton');
        const patientInfoInput = document.getElementById('patientInfo');
        const specialtyFocusSelect = document.getElementById('specialtyFocus');
        const uptodateInfoInput = document.getElementById('uptodateInfo');
        const micromedexInfoInput = document.getElementById('micromedexInfo');
        const openevidenceInfoInput = document.getElementById('openevidenceInfo');
        const termsCheckbox = document.getElementById('termsCheckbox');
        const nhiGuidelinesInfoInput = document.getElementById('nhiGuidelinesInfo');
        const apiProviderSelect = document.getElementById('apiProviderSelect');
        const chartingDataInput = document.getElementById('chartingDataInput'); // v19.2: æ–°å¢

        const outputDiv = document.getElementById('output');
        const placeholderDiv = document.getElementById('placeholder');
        const infoBox = document.getElementById('infoBox');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');
        const sourcesTitle = document.getElementById('sourcesTitle');
        const clearInputsButton = document.getElementById('clearInputsButton');
        const copyButton = document.getElementById('copyButton');
        const progressBarContainer = document.getElementById('progressBarContainer');

        const queryGuidelinesButton = document.getElementById('queryGuidelinesButton');
        const guidelineSpinner = document.getElementById('guidelineSpinner');
        const guidelineListContainer = document.getElementById('guidelineListContainer');
        const guidelineList = document.getElementById('guidelineList');
        
        const autoCalcDisplay = document.getElementById('autoCalcDisplay');
        const autoCalcList = document.getElementById('autoCalcList');
        
        // === v20.0: åœ–è¡¨ DOM å…ƒç´  ===
        const chartsContainer = document.getElementById('chartsContainer');
        const labChartsContainer = document.getElementById('labChartsContainer');
        const labChartsGoHere = document.getElementById('labChartsGoHere');
        const noLabChartMessage = document.getElementById('noLabChartMessage');
        const ganttChartContainer = document.getElementById('ganttChartContainer');
        const ganttChartGoHere = document.getElementById('ganttChartGoHere');
        const ganttChartCanvas = document.getElementById('ganttChartCanvas');
        const noGanttChartMessage = document.getElementById('noGanttChartMessage');

        // === v18.0: éŒ¯èª¤è™•ç† (Error Modal) DOM å…ƒç´  ===
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // === v18.0: è‡¨åºŠè¨ˆç®—æ©Ÿ (Calculator) DOM å…ƒç´  ===
        const manual_calcSex = document.getElementById('manual_calcSex');
        const manual_calcAge = document.getElementById('manual_calcAge');
        const manual_calcWeight = document.getElementById('manual_calcWeight');
        const manual_calcHeight = document.getElementById('manual_calcHeight');
        const manual_calcScr = document.getElementById('manual_calcScr');
        const manual_calculateCrClBwButton = document.getElementById('manual_calculateCrClBwButton');
        const manual_crclResult = document.getElementById('manual_crclResult');
        const manual_bwResult = document.getElementById('manual_bwResult');
        
        const manual_c2vAgeLess65 = document.getElementById('manual_c2vAge<65');
        const manual_c2vAge65_74 = document.getElementById('manual_c2vAge65-74');
        const manual_c2vAgeGreater75 = document.getElementById('manual_c2vAge>=75');
        const manual_c2vSexFemale = document.getElementById('manual_c2vSexFemale');
        const manual_c2vChf = document.getElementById('manual_c2vChf');
        const manual_c2vHt = document.getElementById('manual_c2vHt');
        const manual_c2vDm = document.getElementById('manual_c2vDm');
        const manual_c2vStroke = document.getElementById('manual_c2vStroke');
        const manual_c2vVd = document.getElementById('manual_c2vVd');
        const manual_calculateCha2ds2vascButton = document.getElementById('manual_calculateCha2ds2vascButton');
        const manual_cha2ds2vascResult = document.getElementById('manual_cha2ds2vascResult');
        
        const manual_calculateBsaButton = document.getElementById('manual_calculateBsaButton');
        const manual_calcBsaResult = document.getElementById('manual_calcBsaResult');
        const manual_calculateCkdEpiButton = document.getElementById('manual_calculateCkdEpiButton');
        const manual_calcCkdEpiResult = document.getElementById('manual_calcCkdEpiResult');
        const manual_calculateChildPughButton = document.getElementById('manual_calculateChildPughButton');
        const manual_calcChildPughResult = document.getElementById('manual_calcChildPughResult');

        // === v18.0: æ ¸å¿ƒ - è¦–åœ–åˆ‡æ› (Routing) ===
        function showView(viewId) {
            Object.values(views).forEach(view => view.style.display = 'none');
            if (views[viewId]) {
                views[viewId].style.display = 'block';
            } else {
                views.home.style.display = 'block'; // é è¨­
            }
            Object.keys(navButtons).forEach(key => {
                // v18.1: æ›´æ–° ID æ˜ å°„
                const buttonId = (key === 'soapNote') ? 'nav-soap-note' : `nav-${key}`;
                if (navButtons[key]) {
                    if (key === viewId) {
                        navButtons[key].classList.add('active');
                    } else {
                        navButtons[key].classList.remove('active');
                    }
                }
            });
            window.scrollTo(0, 0); // åˆ‡æ›è¦–åœ–æ™‚æ»¾å‹•åˆ°é ‚éƒ¨
        }
        
        // === v18.1: æ ¸å¿ƒ - è³‡æ–™åº« (LocalStorage) ===
        function saveAppSettings() {
            try {
                localStorage.setItem(appStorageKey, JSON.stringify(appSettings));
            } catch (e) {
                console.error("å„²å­˜ AppSettings æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                showError("ç„¡æ³•å„²å­˜è¨­å®š (ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ localStorage)ã€‚");
            }
        }
        
        function loadAppSettings() {
            try {
                const storedSettings = localStorage.getItem(appStorageKey);
                if (storedSettings) {
                    appSettings = JSON.parse(storedSettings);
                    if (!appSettings.apiKeys) appSettings.apiKeys = { gemini: "", grok: "" }; // ä¿æŒç›¸å®¹
                    if (!appSettings.projects) appSettings.projects = [];
                }
            } catch (e) {
                console.error("è¼‰å…¥ AppSettings æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                // å¦‚æœè§£æå¤±æ•—ï¼Œé‡è¨­ç‚ºé è¨­å€¼
                appSettings = { apiKeys: { gemini: "", grok: "" }, projects: [] };
            }
        }
        
        // === v18.1: æ ¸å¿ƒ - è¨­å®š (Settings) é é¢é‚è¼¯ ===
        function saveApiKeysToStorage() {
            const newGeminiKey = geminiApiKeyInput.value.trim();
            const newGrokKey = grokApiKeyInput.value.trim();
            
            if (newGeminiKey) appSettings.apiKeys.gemini = newGeminiKey;
            if (newGrokKey) appSettings.apiKeys.grok = newGrokKey;
            
            saveAppSettings(); // å„²å­˜æ•´å€‹ appSettings
            
            if (!newGeminiKey && !newGrokKey) {
                alert("æœªè¼¸å…¥æ–°é‡‘é‘°ã€‚");
            } else {
                alert("è¨­å®šå·²å„²å­˜ï¼");
            }
            // é‡æ–°æ•´ç† UI ç‹€æ…‹
            updateSettingsUI();
        }

        function updateSettingsUI() {
            // è¼‰å…¥ Gemini ç‹€æ…‹
            if (appSettings.apiKeys.gemini) {
                geminiApiStatus.textContent = "ç‹€æ…‹ï¼šå·²å¾ç€è¦½å™¨è¼‰å…¥é‡‘é‘°ã€‚";
                geminiApiStatus.className = "text-sm mt-2 text-green-600";
                geminiApiKeyInput.value = "";
                geminiApiKeyInput.placeholder = "é‡‘é‘°å·²å„²å­˜";
            } else {
                geminiApiStatus.textContent = "ç‹€æ…‹ï¼šå°šæœªè¨­å®šé‡‘é‘°ã€‚";
                geminiApiStatus.className = "text-sm mt-2 text-red-600";
                geminiApiKeyInput.placeholder = "è²¼ä¸Šæ‚¨çš„ Google Gemini API é‡‘é‘° (AIzaSy...)";
            }
            // è¼‰å…¥ Grok ç‹€æ…‹
            if (appSettings.apiKeys.grok) {
                grokApiStatus.textContent = "ç‹€æ…‹ï¼šå·²å¾ç€è¦½å™¨è¼‰å…¥é‡‘é‘°ã€‚";
                grokApiStatus.className = "text-sm mt-2 text-green-600";
                grokApiKeyInput.value = "";
                grokApiKeyInput.placeholder = "é‡‘é‘°å·²å„²å­˜";
            } else {
                grokApiStatus.textContent = "ç‹€æ…‹ï¼šå°šæœªè¨­å®šé‡‘é‘°ã€‚";
                grokApiStatus.className = "text-sm mt-2 text-red-600";
                grokApiKeyInput.placeholder = "è²¼ä¸Šæ‚¨çš„ Grok API é‡‘é‘° (gk_...)";
            }
        }

        // === v18.1: æ ¸å¿ƒ - å°ˆæ¡ˆç®¡ç† (Project Management) ===
        
        // æ¸²æŸ“å°ˆæ¡ˆåˆ—è¡¨åˆ°ä¸»é 
        function renderProjectList() {
            projectListContainer.innerHTML = ''; // æ¸…ç©º
            
            if (appSettings.projects.length === 0) {
                noProjectsMessage.style.display = 'block';
                return;
            }
            
            noProjectsMessage.style.display = 'none';
            
            // æ’åºï¼šæœ€æ–°çš„åœ¨æœ€å‰é¢
            const sortedProjects = [...appSettings.projects].sort((a, b) => b.updatedAt - a.updatedAt);
            
            sortedProjects.forEach(project => {
                const projectEl = document.createElement('div');
                projectEl.className = 'project-item';
                
                const lastUpdated = new Date(project.updatedAt).toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                projectEl.innerHTML = `
                    <div class="project-name" data-id="${project.id}">${project.name}</div>
                    <span class="project-date">${lastUpdated}</span>
                    <button class="project-delete-btn" data-id="${project.id}" title="åˆªé™¤å°ˆæ¡ˆ">X</button>
                `;
                
                // ç¶å®šäº‹ä»¶ï¼šé»æ“Šåç¨± = è¼‰å…¥
                projectEl.querySelector('.project-name').addEventListener('click', () => {
                    loadProject(project.id);
                });
                
                // ç¶å®šäº‹ä»¶ï¼šé»æ“Š X = åˆªé™¤
                projectEl.querySelector('.project-delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // é¿å…è§¸ç™¼è¼‰å…¥
                    deleteProject(project.id);
                });
                
                projectListContainer.appendChild(projectEl);
            });
        }
        
        // å¾ä¸»é é»æ“Š "æ–°å¢"
        function createNewProject() {
            currentProjectId = null; // æ¨™è¨˜ç‚ºæ–°å°ˆæ¡ˆ
            clearSoapInputs(); // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
            projectNameInput.value = "æœªå‘½åå°ˆæ¡ˆ";
            showView('soapNote');
            projectNameInput.focus();
        }
        
        // *** v19.2: è¼‰å…¥é‚è¼¯ (å·²æ›´æ–°) ***
        function loadProject(projectId) {
            const project = appSettings.projects.find(p => p.id === projectId);
            if (!project) {
                showError("æ‰¾ä¸åˆ°è©²å°ˆæ¡ˆã€‚");
                return;
            }
            
            currentProjectId = project.id;
            
            // --- Load Inputs ---
            projectNameInput.value = project.name;
            patientInfoInput.value = project.data.patientInfo || '';
            chartingDataInput.value = project.data.chartingData || ''; // v19.2: æ–°å¢
            specialtyFocusSelect.value = project.data.specialtyFocus || '';
            uptodateInfoInput.value = project.data.uptodateInfo || '';
            micromedexInfoInput.value = project.data.micromedexInfo || '';
            openevidenceInfoInput.value = project.data.openevidenceInfo || '';
            nhiGuidelinesInfoInput.value = project.data.nhiGuidelinesInfo || '';

            // --- Load Outputs (v18.3) ---
            const soapNoteHtml = project.data.soapNoteOutput || '';
            const sourcesHtml = project.data.sourcesOutput || '';
            const autoCalcHtml = project.data.autoCalcOutput || '';

            if (soapNoteHtml) {
                outputDiv.innerHTML = soapNoteHtml;
                outputDiv.classList.remove('hidden');
                placeholderDiv.classList.add('hidden');
                infoBox.classList.remove('hidden'); 
                copyButton.disabled = false;
            } else {
                clearSoapOutputs(); // æœƒè‡ªå‹•æ¸…ç©ºåœ–è¡¨
            }

            if (sourcesHtml) {
                sourcesList.innerHTML = sourcesHtml;
                sourcesTitle.textContent = 'å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æº (å·²å„²å­˜)ï¼š'; 
                sourcesContainer.classList.remove('hidden');
            } else {
                sourcesContainer.classList.add('hidden');
                sourcesList.innerHTML = '';
            }

            if (autoCalcHtml) {
                autoCalcList.innerHTML = autoCalcHtml;
                autoCalcDisplay.classList.remove('hidden');
            } else {
                autoCalcDisplay.classList.add('hidden');
                autoCalcList.innerHTML = '';
            }
            
            // v19.2: è¼‰å…¥å°ˆæ¡ˆæ™‚ï¼Œè‡ªå‹•å¾ã€Œè£½åœ–æ¬„ä½ã€é‡æ–°ç¹ªè£½åœ–è¡¨
            parseAndRenderCharts(chartingDataInput.value);

            termsCheckbox.checked = false; // è¼‰å…¥å¾Œä»éœ€é‡æ–°åŒæ„
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');

            showView('soapNote');
        }
        
        // *** v19.2: å„²å­˜é‚è¼¯ (å·²æ›´æ–°) ***
        function getProjectDataFromUI() {
            return {
                // --- Inputs ---
                patientInfo: patientInfoInput.value,
                chartingData: chartingDataInput.value, // v19.2: æ–°å¢
                specialtyFocus: specialtyFocusSelect.value,
                uptodateInfo: uptodateInfoInput.value,
                micromedexInfo: micromedexInfoInput.value,
                openevidenceInfo: openevidenceInfoInput.value,
                nhiGuidelinesInfo: nhiGuidelinesInfoInput.value,
                
                // --- Outputs (v18.3) ---
                soapNoteOutput: outputDiv.innerHTML,
                sourcesOutput: sourcesList.innerHTML,
                autoCalcOutput: autoCalcList.innerHTML
                // v19.0: æˆ‘å€‘ä¸å„²å­˜åœ–è¡¨æœ¬èº«ï¼Œåªå„²å­˜ chartingDataï¼Œè¼‰å…¥æ™‚é‡ç¹ª
            };
        }

        // åœ¨ SOAP é é¢æŒ‰ä¸‹ "å„²å­˜"
        function saveCurrentProject() {
            const projectName = projectNameInput.value.trim();
            if (!projectName) {
                showError("å°ˆæ¡ˆåç¨±ä¸å¯ç‚ºç©ºã€‚");
                return;
            }
            
            const projectData = getProjectDataFromUI();
            
            if (currentProjectId) {
                // æ›´æ–°ç¾æœ‰å°ˆæ¡ˆ
                const index = appSettings.projects.findIndex(p => p.id === currentProjectId);
                if (index !== -1) {
                    appSettings.projects[index].name = projectName;
                    appSettings.projects[index].data = projectData;
                    appSettings.projects[index].updatedAt = Date.now();
                    
                    saveAppSettings();
                    alert(`å°ˆæ¡ˆ "${projectName}" å·²æ›´æ–°ã€‚`);
                }
            } else {
                // å„²å­˜ç‚ºæ–°å°ˆæ¡ˆ
                saveAsNewProject(projectName, projectData);
            }
        }
        
        // åœ¨ SOAP é é¢æŒ‰ä¸‹ "å¦å­˜æ–°æª”"
        function saveAsNewProject(name = null, data = null) {
            let projectName = name || projectNameInput.value.trim();
            if (!projectName || projectName === "æœªå‘½åå°ˆæ¡ˆ") {
                projectName = `å°ˆæ¡ˆ ${new Date().toLocaleString('zh-TW')}`;
            }
            
            const projectData = data || getProjectDataFromUI();
            const newId = `project_${Date.now()}`;
            
            const newProject = {
                id: newId,
                name: projectName,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                data: projectData
            };
            
            appSettings.projects.push(newProject);
            saveAppSettings();
            
            currentProjectId = newId; // æ›´æ–°ç›®å‰ ID
            projectNameInput.value = projectName; // æ›´æ–°è¼¸å…¥æ¡†
            
            if (!name) { // åªæœ‰ç•¶ä½¿ç”¨è€…ä¸»å‹•é»æ“Š "å¦å­˜æ–°æª”" æ™‚æ‰è·³é€šçŸ¥
                alert(`å·²å¦å­˜æ–°æª”ç‚º "${projectName}"ã€‚`);
            }
        }
        
        // åœ¨ SOAP é é¢æŒ‰ä¸‹ "åˆªé™¤"
        function deleteCurrentProject() {
             if (!currentProjectId) {
                showError("é€™æ˜¯ä¸€å€‹å°šæœªå„²å­˜çš„æ–°å°ˆæ¡ˆï¼Œç„¡æ³•åˆªé™¤ã€‚");
                return;
            }
            
            if (confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆ "${projectNameInput.value}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                appSettings.projects = appSettings.projects.filter(p => p.id !== currentProjectId);
                saveAppSettings();
                
                alert("å°ˆæ¡ˆå·²åˆªé™¤ã€‚");
                
                // è¿”å›ä¸»é ä¸¦åˆ·æ–°åˆ—è¡¨
                renderProjectList();
                showView('home');
            }
        }
        
        // åœ¨ ä¸»é  åˆ—è¡¨æŒ‰ä¸‹ "X"
        function deleteProject(projectId) {
            const project = appSettings.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆ "${project.name}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                appSettings.projects = appSettings.projects.filter(p => p.id !== projectId);
                saveAppSettings();
                renderProjectList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            }
        }
        
        // === v18.2.1: ä¸»é  - README æŠ“å– (ä¿®æ­£ UTF-8 äº‚ç¢¼) ===
        async function fetchReadme() {
            try {
                const response = await fetch(githubReadmeUrl, {
                    headers: { 'Accept': 'application/vnd.github.v3.json' }
                });
                if (!response.ok) throw new Error(`GitHub API éŒ¯èª¤: ${response.status}`);
                
                const data = await response.json();
                
                // *** äº‚ç¢¼ä¿®æ­£é–‹å§‹ ***
                const binaryString = atob(data.content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decoder = new TextDecoder('utf-8');
                const readmeContent = decoder.decode(bytes);
                // *** äº‚ç¢¼ä¿®æ­£çµæŸ ***

                readmeContainer.innerHTML = marked.parse(readmeContent);
                
            } catch (error) {
                console.error("æŠ“å– README å¤±æ•—:", error);
                readmeContainer.innerHTML = `<p class="text-red-600">ç„¡æ³•è¼‰å…¥ç‰ˆæœ¬èªªæ˜ï¼š${error.message}</p>`;
            }
        }

        // === éŒ¯èª¤è™•ç† (v17.4 -> v18.1) ===
        function showError(message) {
            let activeKey = "";
            let provider = "Gemini";
            try {
                if (apiProviderSelect) {
                    provider = apiProviderSelect.value;
                }
            } catch(e) {/* ignore if element not visible */}
            
            if (provider === 'gemini') activeKey = appSettings.apiKeys.gemini;
            if (provider === 'grok') activeKey = appSettings.apiKeys.grok;

            if (activeKey === "" && (message.includes("API") || message.includes("é‡‘é‘°"))) {
                errorMessage.textContent = `API é‡‘é‘°å°šæœªè¨­å®šæˆ–ç„¡æ•ˆã€‚è«‹å‰å¾€ã€Œè¨­å®šã€é é¢è¼¸å…¥ä¸¦å„²å­˜ ${provider} é‡‘é‘°ã€‚`;
            } else {
                errorMessage.textContent = message || "ç™¼ç”ŸæœªçŸ¥çš„éŒ¯èª¤ã€‚";
            }
            errorModal.classList.remove('hidden');
        }
        closeModalButton.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });
        
        // === v18.0: ç´”è¨ˆç®—é‚è¼¯ (Pure Functions) ===
        function setCalcResult(element, text, isNoData = false) {
            element.textContent = text;
            if (isNoData) {
                element.className = 'calc-result-nodata block';
            } else if (text) {
                element.className = 'calc-result block';
            }
        }

        function getCrClBwString(age, weight, height, scr, sex) {
            let crclVal = "CrCl (C-G): ç„¡è³‡æ–™";
            let bwVal = "IBW/ABW: ç„¡è³‡æ–™";

            try {
                const n_age = parseFloat(age);
                const n_weight = parseFloat(weight);
                const n_height = parseFloat(height);
                const n_scr = parseFloat(scr);

                if (!isNaN(n_height) && !isNaN(n_weight) && n_height > 0 && n_weight > 0) {
                    let ibw = (sex === 'Male') ? (50 + 2.3 * (n_height * 0.393701 - 60)) : (45.5 + 2.3 * (n_height * 0.393701 - 60));
                    if (ibw < 0) ibw = (sex === 'Male') ? 50 : 45.5;
                    const upperLimit = ibw * 1.2;
                    let assessment = (n_weight > upperLimit) ? "ä½æ–¼ABWç¯„åœå…§ (TBW/IBW > 1.2)" : "æœªé€²å…¥ABWç¯„åœ (TBW/IBW â‰¤ 1.2)";
                    bwVal = `IBW: ${ibw.toFixed(1)} kg. (${assessment})`;

                    if (!isNaN(n_age) && !isNaN(n_scr) && n_scr > 0) {
                        let weightForCrCl = n_weight;
                        if (n_weight < ibw) weightForCrCl = n_weight;
                        else if (n_weight >= ibw && n_weight <= upperLimit) weightForCrCl = ibw;
                        else weightForCrCl = ibw + 0.4 * (n_weight - ibw); // AdjBW
                        let crcl = ((140 - n_age) * weightForCrCl) / (72 * n_scr);
                        if (sex === 'Female') crcl *= 0.85;
                        crclVal = `CrCl (C-G): ${crcl.toFixed(1)} mL/min`;
                    }
                }
            } catch (e) { console.error("CrCl calculation error:", e) }
            return { crcl: crclVal, bw: bwVal };
        }

        function getCha2ds2vascString(age, sex, chf, ht, dm, stroke, vd) {
            try {
                let score = 0;
                const n_age = parseFloat(age);
                if (isNaN(n_age)) return "CHAâ‚‚DSâ‚‚-VASc: ç„¡è³‡æ–™ (ç¼ºå¹´é½¡)";
                if (n_age >= 75) score += 2;
                else if (n_age >= 65) score += 1;
                if (sex === 'Female') score += 1;
                if (chf) score += 1;
                if (ht) score += 1;
                if (dm) score += 1;
                if (stroke) score += 2;
                if (vd) score += 1;
                return `CHAâ‚‚DSâ‚‚-VASc: ${score} åˆ†`;
            } catch (e) { return "CHAâ‚‚DSâ‚‚-VASc: ç„¡è³‡æ–™"; }
        }

        function getBsaString(weight, height) {
            try {
                const n_weight = parseFloat(weight);
                const n_height = parseFloat(height);
                if (!isNaN(n_weight) && !isNaN(n_height) && n_weight > 0 && n_height > 0) {
                    const bsa = Math.sqrt((n_height * n_weight) / 3600);
                    return `BSA (Mosteller): ${bsa.toFixed(2)} mÂ²`;
                }
            } catch (e) { /* */ }
            return "BSA (Mosteller): ç„¡è³‡æ–™ (ç¼ºHt/BW)";
        }

        function getCkdEpiString(age, scr, sex) {
            try {
                const n_age = parseFloat(age);
                const n_scr = parseFloat(scr);
                if (isNaN(n_age) || isNaN(n_scr) || n_scr <= 0) return "eGFR (CKD-EPI): ç„¡è³‡æ–™ (ç¼ºAge/SCr)";
                let kappa = (sex === 'Female') ? 0.7 : 0.9;
                let alpha = (sex === 'Female') ? -0.241 : -0.302;
                let sexFactor = (sex === 'Female') ? 1.012 : 1;
                let eGFR = 142 * Math.pow(Math.min(n_scr / kappa, 1), alpha) * Math.pow(Math.max(n_scr / kappa, 1), -1.200) * Math.pow(0.9938, n_age) * sexFactor;
                return `eGFR (CKD-EPI): ${eGFR.toFixed(1)} mL/min/1.73mÂ²`;
            } catch (e) { return "eGFR (CKD-EPI): ç„¡è³‡æ–™"; }
        }

        function getChildPughString(ascites, enceph, bili, alb, inr) {
            try {
                let score = parseInt(ascites) + parseInt(enceph) + parseInt(bili) + parseInt(alb) + parseInt(inr);
                if (isNaN(score)) return "Child-Pugh: ç„¡è³‡æ–™";
                let grade = "";
                if (score >= 5 && score <= 6) grade = "A (5-6 åˆ†)";
                else if (score >= 7 && score <= 9) grade = "B (7-9 åˆ†)";
                else if (score >= 10 && score <= 15) grade = "C (10-15 åˆ†)";
                return `Child-Pugh: ${grade}`;
            } catch (e) { return "Child-Pugh: ç„¡è³‡æ–™"; }
        }

        // === v18.0: å„€è¡¨æ¿ - è‡ªå‹•è§£æèˆ‡è¨ˆç®— ===
        function parseAndAutoCalculate(text) {
            const findVal = (regex) => { const match = text.match(regex); return match ? parseFloat(match[1]) : null; };
            const findStr = (regex) => { const match = text.match(regex); return match ? match[1].toUpperCase() : null; }
            const regex = {
                sex: /(?:sex|æ€§åˆ¥)\s*[:ï¼š=\s]\s*(M|F|Male|Female|ç”·|å¥³)/i,
                sexStandalone: /\b(female|male|F|M|ç”·|å¥³)\b/i,
                age: /(?:age|å¹´é½¡)\s*[:ï¼š=\s]\s*(\d{1,3})/i,
                ageYo: /(\d{1,3})\s*y\s*\/?\s*o/i,
                weight: /(?:weight|BW|é«”é‡)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)\s*k?g/i,
                weightKg: /\b(\d{1,3}(?:\.\d{1,2})?)\s*k?g\b/i,
                height: /(?:height|èº«é«˜)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)\s*c?m/i,
                heightCm: /\b(\d{1,3}(?:\.\d{1,2})?)\s*c?m\b/i,
                scr: /(?:SCr|Crea|Creatinine|Cr)\s*[:ï¼š=\s]\s*(?!.*\([\d\/-]+\))(\d{1,2}(?:\.\d{1,3})?)/i, // v19.2: æ’é™¤æœ‰æ—¥æœŸçš„ (?!...)
                chf: /\b(CHF|å¿ƒè¡°|Heart Failure)\b/i,
                ht: /\b(HTN|HT|é«˜è¡€å£“|Hypertension)\b/i,
                dm: /\b(DM|Diabetes|ç³–å°¿ç—…)\b/i,
                stroke: /\b(Stroke|TIA|CVA)\b/i,
                vd: /\b(Vascular Disease|PVD|MI|CAD)\b/i,
                egfr: /(?:eGFR|CKD-EPI)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)/i,
                crcl: /(?:CrCl|C-G)\s*[:ï¼š=\s]\s*(\d{1,3}(?:\.\d{1,2})?)/i,
                bsa: /BSA\s*[:ï¼š=\s]\s*(\d{1,2}(?:\.\d{1,2})?)/i,
                cha2ds2vasc: /(?:CHAâ‚‚DSâ‚‚-VASc|CHADS-VASc)\s*(?:score)?\s*[:ï¼š=\s]\s*(\d{1,2})\s*(?:åˆ†|point|points)?/i,
                childPugh: /(?:Child-Pugh|Child's)\s*(?:score|grade)?\s*[:ï¼š=\s]\s*([ABC])\b/i
            };
            let parsed = {
                sexStr: findStr(regex.sex) || findStr(regex.sexStandalone),
                age: findVal(regex.age) || findVal(regex.ageYo),
                weight: findVal(regex.weight) || findVal(regex.weightKg),
                height: findVal(regex.height) || findVal(regex.heightCm),
                scr: findVal(regex.scr),
                chf: text.match(regex.chf),
                ht: text.match(regex.ht),
                dm: text.match(regex.dm),
                stroke: text.match(regex.stroke),
                vd: text.match(regex.vd),
            };
            let sex = 'Male';
            if (parsed.sexStr) { if (parsed.sexStr.startsWith('F') || parsed.sexStr === 'å¥³') sex = 'Female'; }
            let preCalculated = {
                egfr: findVal(regex.egfr),
                crcl: findVal(regex.crcl),
                bsa: findVal(regex.bsa),
                cha2ds2vasc: findVal(regex.cha2ds2vasc),
                childPugh: findStr(regex.childPugh)
            };
            let results = [];
            if (preCalculated.crcl) {
                results.push(`CrCl (C-G): ${preCalculated.crcl.toFixed(1)} mL/min (ä¾†è‡ªåŸæ–‡)`);
            } else {
                const { crcl } = getCrClBwString(parsed.age, parsed.weight, parsed.height, parsed.scr, sex);
                results.push(crcl);
            }
            const { bw } = getCrClBwString(parsed.age, parsed.weight, parsed.height, parsed.scr, sex);
            results.push(bw);
            if (preCalculated.egfr) {
                results.push(`eGFR (CKD-EPI): ${preCalculated.egfr.toFixed(1)} mL/min/1.73mÂ² (ä¾†è‡ªåŸæ–‡)`);
            } else {
                results.push(getCkdEpiString(parsed.age, parsed.scr, sex));
            }
            if (preCalculated.bsa) {
                results.push(`BSA (Mosteller): ${preCalculated.bsa.toFixed(2)} mÂ² (ä¾†è‡ªåŸæ–‡)`);
            } else {
                results.push(getBsaString(parsed.weight, parsed.height));
            }
            if (preCalculated.cha2ds2vasc) {
                results.push(`CHAâ‚‚DSâ‚‚-VASc: ${preCalculated.cha2ds2vasc} åˆ† (ä¾†è‡ªåŸæ–‡)`);
            } else {
                results.push(getCha2ds2vascString(parsed.age, sex, parsed.chf, parsed.ht, parsed.dm, parsed.stroke, parsed.vd));
            }
            if (preCalculated.childPugh) {
                results.push(`Child-Pugh: ${preCalculated.childPugh} ç´š (ä¾†è‡ªåŸæ–‡)`);
            } else {
                results.push("Child-Pugh: ç„¡è³‡æ–™ (è«‹æ‰‹å‹•è¨ˆç®—)");
            }
            return results;
        }
        
        // === v20.0: NEW Charting Functions (Flexible Date Fix) ===
        
        // éŠ·æ¯€æ‰€æœ‰ç¾å­˜çš„åœ–è¡¨
        function destroyActiveCharts() {
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            labChartsGoHere.innerHTML = ''; // æ¸…ç©º Lab å®¹å™¨
            // ç”˜ç‰¹åœ–çš„ Canvas æ˜¯éœæ…‹çš„ï¼Œæˆ‘å€‘åªéœ€éŠ·æ¯€ chart å¯¦ä¾‹
        }

        // v20.0: è¼”åŠ©å‡½å¼ - å°‡ '10/1' æˆ– '114/10/1' è½‰æ›ç‚º JS Date ç‰©ä»¶
        function parseChartDate(dateString) {
            const parts = dateString.split(/[\/-]/);
            let year, month, day;

            if (parts.length === 3) { // æ ¼å¼ç‚º Y/M/D (ä¾‹å¦‚ 114/10/1 æˆ– 2025/10/1)
                year = parseInt(parts[0]);
                month = parseInt(parts[1]) - 1; // JS æœˆä»½å¾ 0 é–‹å§‹
                day = parseInt(parts[2]);
                if (year < 200) { // å‡è¨­æ˜¯æ°‘åœ‹å¹´
                    year += 1911;
                }
            } else if (parts.length === 2) { // æ ¼å¼ç‚º M/D (ä¾‹å¦‚ 10/1)
                year = new Date().getFullYear(); // é è¨­ç‚ºä»Šå¹´
                month = parseInt(parts[0]) - 1;
                day = parseInt(parts[1]);
            } else {
                return null; // ç„¡æ³•è§£æçš„æ ¼å¼
            }
            
            // è™•ç†è·¨å¹´ä»½å•é¡Œ (ä¾‹å¦‚ï¼šç¾åœ¨ 1 æœˆï¼Œä½†æ—¥æœŸæ˜¯ 12/25ï¼Œæ‡‰è¦–ç‚ºå»å¹´)
            const today = new Date();
            const date = new Date(year, month, day);
            if (parts.length === 2 && date > today) {
                date.setFullYear(year - 1);
            }
            return date;
        }

        // v20.0: è§£æ Lab Data
        function parseLabDataForChart(text) {
            const labData = {};
            const lines = text.split('\n');
            // v19.3: å½ˆæ€§æ•¸å€¼ (å¯åŒ…å«å–®ä½) + å½ˆæ€§æ—¥æœŸ (å¯ç‚º Y/M/D æˆ– M/D)
            const pointRegex = /(\d+(?:\.\d+)?)\s*.*?\s*\(?([\d\.\/-]+)\)?/g;
            
            // v20.0: æ”¯æ´çš„ Lab é—œéµå­— (å¿…é ˆåœ¨è¡Œé¦–)
            const supportedLabs = ['SCR', 'WBC', 'K +', 'NA +', 'PLT', 'AST', 'ALT', 'HB', 'BUN', 'CRP'];

            lines.forEach(line => {
                const parts = line.split(/[:ï¼š]/);
                if (parts.length < 2) return; 

                const labName = parts[0].trim().toUpperCase().replace('+', ' +');
                const dataString = parts[1];

                const cleanLabName = supportedLabs.find(lab => labName.startsWith(lab));
                if (!cleanLabName) return; // ä¸æ˜¯æ”¯æ´çš„ Labï¼Œè·³é

                if (!labData[cleanLabName]) {
                    labData[cleanLabName] = { labels: [], data: [] };
                }

                let pointMatch;
                while ((pointMatch = pointRegex.exec(dataString)) !== null) {
                    const value = parseFloat(pointMatch[1]);
                    const dateStr = pointMatch[2];
                    const dateObj = parseChartDate(dateStr); // v20.0: è½‰æ›ç‚º Date ç‰©ä»¶
                    
                    if (!isNaN(value) && dateObj) {
                        labData[cleanLabName].labels.push(dateObj); // å„²å­˜ Date ç‰©ä»¶
                        labData[cleanLabName].data.push(value);
                    }
                }
            });
            return labData;
        }
        
        // v20.0: è§£æç”¨è—¥å² (Gantt)
        function parseMedDataForGantt(text) {
            const medData = { labels: [], data: [], colors: [] };
            const lines = text.split('\n');
            // v20.0: åŒ¹é… 'Vanco: (10/1-10/5)' æˆ– 'Mero (10/1 - 10/5)'
            const medRegex = /^(.*?)\s*[:ï¼š]?\s*\(?([\d\.\/-]+)\s*-\s*([\d\.\/-]+)\)?/i;
            
            const colorPalette = ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899'];
            let colorIndex = 0;

            lines.forEach(line => {
                const match = line.match(medRegex);
                if (match) {
                    const medName = match[1].trim();
                    const startDate = parseChartDate(match[2]);
                    let endDate = parseChartDate(match[3]);
                    
                    if (medName && startDate && endDate) {
                        // ç¢ºä¿çµæŸæ—¥æœŸæ¯”é–‹å§‹æ—¥æœŸæ™š
                        if (endDate < startDate) {
                            endDate.setFullYear(endDate.getFullYear() + 1);
                        }
                        
                        // ç‚ºäº†è®“ç”˜ç‰¹åœ–çš„æ¢ç‹€åœ¨ "ä¸€å¤©" çš„ä¸­é–“ï¼Œæˆ‘å€‘å°‡çµæŸæ—¥æœŸ +1 å¤©
                        endDate.setDate(endDate.getDate() + 1); 

                        medData.labels.push(medName);
                        medData.data.push([startDate, endDate]);
                        
                        // åˆ†é…é¡è‰²
                        medData.colors.push(colorPalette[colorIndex % colorPalette.length]);
                        colorIndex++;
                    }
                }
            });
            return medData;
        }


        // æ¸²æŸ“ Lab åœ–è¡¨
        function renderLabCharts(labData) {
            let chartsCreated = 0;
            labChartsGoHere.innerHTML = ''; // æ¸…ç©º Lab å®¹å™¨

            Object.keys(labData).forEach(labName => {
                const chartData = labData[labName];
                if (chartData.data.length > 1) { // è‡³å°‘ 2 å€‹é»
                    const canvasId = `chart_lab_${labName.replace(' +', 'Plus')}`;
                    const canvasEl = document.createElement('canvas');
                    canvasEl.id = canvasId;
                    canvasEl.style.maxHeight = '250px'; 
                    canvasEl.style.marginTop = '1rem';
                    labChartsGoHere.appendChild(canvasEl);
                    
                    const ctx = canvasEl.getContext('2d');
                    const newChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            // labels å·²æ˜¯ Date ç‰©ä»¶ï¼ŒChart.js æœƒè‡ªå‹•è™•ç†
                            datasets: [{
                                label: labName,
                                data: chartData.data.map((value, index) => ({ x: chartData.labels[index], y: value })),
                                fill: false,
                                borderColor: '#' + (Math.random().toString(16) + '000000').substring(2,8),
                                tension: 0.1,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointBackgroundColor: 'white'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${labName} è¶¨å‹¢åœ–`,
                                    font: { size: 16 }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time', // X è»¸ç‚ºæ™‚é–“
                                    time: {
                                        unit: 'day',
                                        tooltipFormat: 'MM/dd',
                                        displayFormats: {
                                            day: 'MM/dd'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'æ—¥æœŸ'
                                    }
                                },
                                y: {
                                    beginAtZero: false 
                                }
                            }
                        }
                    });
                    activeCharts.push(newChart);
                    chartsCreated++;
                }
            });

            if (chartsCreated > 0) {
                labChartsContainer.classList.remove('hidden');
                noLabChartMessage.classList.add('hidden');
            } else {
                labChartsContainer.classList.add('hidden');
                noLabChartMessage.classList.remove('hidden');
            }
            return chartsCreated;
        }
        
        // v20.0: æ¸²æŸ“ç”¨è—¥å²ç”˜ç‰¹åœ–
        function renderGanttChart(medData) {
            if (medData.data.length > 0) {
                ganttChartContainer.classList.remove('hidden');
                noGanttChartMessage.classList.add('hidden');
                
                const ctx = ganttChartCanvas.getContext('2d');
                const newChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: medData.labels,
                        datasets: [{
                            label: 'ç”¨è—¥æœŸé–“',
                            data: medData.data,
                            backgroundColor: medData.colors,
                            barPercentage: 0.6,
                        }]
                    },
                    options: {
                        indexAxis: 'y', // è½‰ç‚ºæ©«å‘æ¢å½¢åœ–
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false // éš±è—åœ–ä¾‹
                            },
                            title: {
                                display: true,
                                text: 'ç”¨è—¥å²ç”˜ç‰¹åœ–',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'MM/dd',
                                    displayFormats: {
                                        day: 'MM/dd'
                                    }
                                },
                                min: medData.data.length > 0 ? new Date(Math.min(...medData.data.map(d => d[0]))) : new Date(), // å‹•æ…‹è¨­å®š X è»¸æœ€å°æ—¥æœŸ
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        }
                    }
                });
                activeCharts.push(newChart);
                return 1;
            } else {
                ganttChartContainer.classList.add('hidden');
                noGanttChartMessage.classList.remove('hidden');
                return 0;
            }
        }
        
        // v20.0: ç¸½åŒ…è£å‡½å¼
        function parseAndRenderCharts(text) {
            destroyActiveCharts(); // æ°¸é å…ˆæ¸…ç©º
            if (!text || text.trim() === "") {
                chartsContainer.classList.add('hidden'); // å¦‚æœæ¬„ä½æ˜¯ç©ºçš„ï¼Œéš±è—åœ–è¡¨å€
                return;
            }
            
            try {
                const labData = parseLabDataForChart(text);
                const medData = parseMedDataForGantt(text);
                
                const labChartsCreated = renderLabCharts(labData);
                const ganttChartsCreated = renderGanttChart(medData);
                
                if (labChartsCreated > 0 || ganttChartsCreated > 0) {
                    chartsContainer.classList.remove('hidden');
                    if (labChartsCreated === 0) {
                        labChartsContainer.classList.add('hidden');
                        noLabChartMessage.classList.remove('hidden');
                    }
                    if (ganttChartsCreated === 0) {
                        ganttChartContainer.classList.add('hidden');
                        noGanttChartMessage.classList.remove('hidden');
                    }
                } else {
                    chartsContainer.classList.add('hidden');
                }
                
            } catch (error) {
                console.error("è£½åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                chartsContainer.classList.remove('hidden');
                labChartsContainer.classList.add('hidden');
                ganttChartContainer.classList.add('hidden');
                noLabChartMessage.textContent = `è£½åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
                noLabChartMessage.classList.remove('hidden');
                noGanttChartMessage.classList.add('hidden');
            }
        }

        // === v18.1: æ¸…ç©ºå‡½å¼ (v20.0 æ›´æ–°) ===
        function clearSoapInputs() {
            // é€™å€‹æŒ‰éˆ•ç¾åœ¨åªæ¸…é™¤è¼¸å…¥ï¼Œä¸å½±éŸ¿ "å°ˆæ¡ˆ" æœ¬èº«
            patientInfoInput.value = '';
            chartingDataInput.value = ''; // v19.2: æ–°å¢
            specialtyFocusSelect.value = '';
            uptodateInfoInput.value = '';
            micromedexInfoInput.value = '';
            openevidenceInfoInput.value = '';
            nhiGuidelinesInfoInput.value = '';
            termsCheckbox.checked = false;
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearSoapOutputs();
        }
        
        function clearSoapOutputs() {
            outputDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            infoBox.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';
            copyButton.disabled = true;
            autoCalcDisplay.classList.add('hidden');
            autoCalcList.innerHTML = '';
            
            // v19.0: æ¸…é™¤åœ–è¡¨
            destroyActiveCharts();
            chartsContainer.classList.add('hidden');
            noLabChartMessage.classList.add('hidden');
            noGanttChartMessage.classList.add('hidden');
        }

        // === v18.1: æ ¸å¿ƒ API å‘¼å« (å·²æ›´æ–°) ===
        
        // å‘¼å« Gemini
        async function callGeminiAPI(systemPrompt, userPrompt, useSearch = true) {
            const apiKey = appSettings.apiKeys.gemini;
            if (apiKey === "") {
                throw new Error("Gemini API é‡‘é‘°å°šæœªè¨­å®šã€‚");
            }
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: useSearch ? [{ "googleSearch": {} }] : []
            };
            
            const apiUrl = `${geminiApiUrlBase}${geminiModelName}:generateContent?key=${apiKey}`;

            // v17.4: é‡è©¦é‚è¼¯
            let retries = 3;
            let delay = 1000;
            
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorBody = "ç„¡æ³•è®€å–éŒ¯èª¤è©³æƒ…";
                        try {
                            const errJson = await response.json();
                            errorBody = errJson.error?.message || JSON.stringify(errJson);
                            if (errorBody.includes("API key not valid")) errorBody = "Gemini API é‡‘é‘°ç„¡æ•ˆã€‚";
                            if (response.status === 404) errorBody = `Gemini æ¨¡å‹ "${geminiModelName}" æœªæ‰¾åˆ°ã€‚`;
                        } catch (e) { /* å¿½ç•¥ */ }
                        throw new Error(`Gemini HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}. è©³æƒ…: ${errorBody}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        if (useSearch && candidate.groundingMetadata?.groundingAttributions) {
                            sources = candidate.groundingMetadata.groundingAttributions
                                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources }; // æˆåŠŸï¼Œè·³å‡ºè¿´åœˆ
                    } else {
                        console.error("Gemini API å›æ‡‰æ ¼å¼éŒ¯èª¤:", result);
                        let errorMsg = "Gemini API å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºã€‚";
                        if (candidate?.finishReason === "SAFETY") errorMsg = "å…§å®¹å¯èƒ½é•åå®‰å…¨æ”¿ç­–è€Œè¢«é˜»æ“‹ã€‚";
                        else if (result.promptFeedback?.blockReason) errorMsg = `è«‹æ±‚è¢«é˜»æ“‹ï¼š${result.promptFeedback.blockReason}`;
                        else if (!candidate) errorMsg = "API æœªè¿”å›æœ‰æ•ˆçš„å€™é¸ç­”æ¡ˆ (å¯èƒ½å·²éè¼‰)ã€‚";
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error(`API å‘¼å«å¤±æ•— (å‰©ä¸‹ ${retries - 1} æ¬¡é‡è©¦):`, error);
                    retries--;
                    if (retries === 0) {
                        throw new Error(error.message === "Failed to fetch" ? "Load failed (ç¶²è·¯é€£ç·šå¤±æ•—)" : error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // å‘¼å« Grok (v18.1)
        async function callGrokAPI(systemPrompt, userPrompt) {
            const apiKey = appSettings.apiKeys.grok;
            if (apiKey === "") {
                throw new Error("Grok API é‡‘é‘°å°šæœªè¨­å®šã€‚");
            }
            
            const payload = {
                model: grokModelName,
                messages: [
                    { "role": "system", "content": systemPrompt },
                    { "role": "user", "content": userPrompt }
                ],
            };
            
            const apiUrl = grokApiUrlBase;
            
            // v17.4: é‡è©¦é‚è¼¯
            let retries = 3;
            let delay = 1000;
            
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorBody = "ç„¡æ³•è®€å–éŒ¯èª¤è©³æƒ…";
                        try {
                            const errJson = await response.json();
                            errorBody = errJson.error?.message || JSON.stringify(errJson);
                            if (response.status === 401) errorBody = "Grok API é‡‘é‘°ç„¡æ•ˆæˆ–æœªæˆæ¬Šã€‚";
                        } catch (e) { /* å¿½ç•¥ */ }
                        throw new Error(`Grok HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}. è©³æƒ…: ${errorBody}`);
                    }

                    const result = await response.json();
                    const text = result.choices?.[0]?.message?.content;

                    if (text) {
                        // Grok API (æ¨™æº–) ä¸æœƒåƒ Gemini ä¸€æ¨£è¿”å› sources çµæ§‹
                        return { text, sources: [] }; // æˆåŠŸï¼Œè·³å‡ºè¿´åœˆ
                    } else {
                        console.error("Grok API å›æ‡‰æ ¼å¼éŒ¯èª¤:", result);
                        let errorMsg = "Grok API å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºã€‚";
                        if (result.choices?.[0]?.finish_reason === "safety") errorMsg = "å…§å®¹å¯èƒ½é•åå®‰å…¨æ”¿ç­–è€Œè¢«é˜»æ“‹ã€‚";
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error(`API å‘¼å«å¤±æ•— (å‰©ä¸‹ ${retries - 1} æ¬¡é‡è©¦):`, error);
                    retries--;
                    if (retries === 0) {
                        throw new Error(error.message === "Failed to fetch" ? "Load failed (ç¶²è·¯é€£ç·šå¤±æ•—)" : error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // === v18.1: äº‹ä»¶ç›£è½å™¨ (Event Listeners) ===

        // é é¢è¼‰å…¥æ™‚
        document.addEventListener('DOMContentLoaded', () => {
            loadAppSettings();      // è¼‰å…¥ localStorage
            updateSettingsUI();     // æ›´æ–°ã€Œè¨­å®šã€é é¢çš„ UI ç‹€æ…‹
            renderProjectList();    // æ¸²æŸ“ã€Œä¸»é ã€çš„å°ˆæ¡ˆåˆ—è¡¨
            fetchReadme();          // æŠ“å– GitHub README
            showView('home');       // é è¨­é¡¯ç¤ºä¸»é 
            
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
        });

        // v18.1: å°è¦½åˆ—
        navButtons.home.addEventListener('click', () => {
            renderProjectList(); // æ¯æ¬¡è¿”å›ä¸»é æ™‚ï¼Œéƒ½é‡æ–°æ•´ç†å°ˆæ¡ˆåˆ—è¡¨
            showView('home');
        });
        navButtons.soapNote.addEventListener('click', () => {
            if (!currentProjectId) {
                createNewProject(); // å¦‚æœæ˜¯é»æ“Šé ‚éƒ¨ Navï¼Œä¸€å¾‹è¦–ç‚ºé–‹æ–°å°ˆæ¡ˆ
            }
            showView('soapNote');
        });
        navButtons.calculator.addEventListener('click', () => showView('calculator'));
        navButtons.settings.addEventListener('click', () => showView('settings'));
        
        // v18.1: ä¸»é ä¸Šçš„æ·å¾‘
        navSettingsShortcut.addEventListener('click', () => showView('settings'));
        navSoapNoteShortcut.addEventListener('click', () => {
            createNewProject(); // ä¸»é ä¸Šçš„ã€Œé–‹å§‹å·¥ä½œã€= é–‹æ–°å°ˆæ¡ˆ
        });
        newProjectButton.addEventListener('click', createNewProject);

        // v18.1: è¨­å®šé é¢
        saveSettingsButton.addEventListener('click', saveApiKeysToStorage);
        
        // v18.1: SOAP ç­†è¨˜é é¢ - å°ˆæ¡ˆç®¡ç†
        saveProjectButton.addEventListener('click', saveCurrentProject);
        saveAsProjectButton.addEventListener('click', saveAsNewProject);
        deleteProjectButton.addEventListener('click', deleteCurrentProject);

        // v18.1: SOAP ç­†è¨˜é é¢ - AI æ ¸å¿ƒ
        termsCheckbox.addEventListener('change', () => {
            generateButton.disabled = !termsCheckbox.checked;
            if (termsCheckbox.checked) {
                generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
            } else {
                generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            }
        });
        
        // v18.0: æ‰‹å‹•è¨ˆç®—æ©Ÿé é¢
        manual_calculateCrClBwButton.addEventListener('click', () => {
            const age = manual_calcAge.value;
            const weight = manual_calcWeight.value;
            const height = manual_calcHeight.value;
            const scr = manual_calcScr.value;
            const sex = manual_calcSex.value;
            const { crcl, bw } = getCrClBwString(age, weight, height, scr, sex);
            setCalcResult(manual_crclResult, crcl);
            setCalcResult(manual_bwResult, bw);
        });
        manual_calculateCha2ds2vascButton.addEventListener('click', () => {
            const age = manual_c2vAgeGreater75.checked ? 75 : (manual_c2vAge65_74.checked ? 65 : 64);
            const sex = manual_c2vSexFemale.checked ? 'Female' : 'Male';
            const result = getCha2ds2vascString(
                age, sex,
                manual_c2vChf.checked, manual_c2vHt.checked, manual_c2vDm.checked,
                manual_c2vStroke.checked, manual_c2vVd.checked
            );
            setCalcResult(manual_cha2ds2vascResult, result);
        });
        manual_calculateBsaButton.addEventListener('click', () => {
             const result = getBsaString(manual_calcWeight.value, manual_calcHeight.value);
             setCalcResult(manual_calcBsaResult, result);
        });
        manual_calculateCkdEpiButton.addEventListener('click', () => {
            const result = getCkdEpiString(manual_calcAge.value, manual_calcScr.value, manual_calcSex.value);
            setCalcResult(manual_calcCkdEpiResult, result);
        });
        manual_calculateChildPughButton.addEventListener('click', () => {
            const result = getChildPughString(
                document.querySelector('input[name="manual_cpAscites"]:checked').value,
                document.querySelector('input[name="manual_cpEnceph"]:checked').value,
                document.querySelector('input[name="manual_cpBili"]:checked').value,
                document.querySelector('input[name="manual_cpAlb"]:checked').value,
                document.querySelector('input[name="manual_cpInr"]:checked').value
            );
            setCalcResult(manual_calcChildPughResult, result);
        });

        // v17.4: æŒ‡å¼•æŸ¥è©¢ (ä¸è®Š)
        queryGuidelinesButton.addEventListener('click', async () => {
            if (appSettings.apiKeys.gemini === "") { // æ­¤åŠŸèƒ½å¼·åˆ¶ä½¿ç”¨ Gemini (å› å…¶ Google Search)
                showError("æ­¤åŠŸèƒ½éœ€è¨­å®š Google Gemini API é‡‘é‘°ã€‚");
                return;
            }
            guidelineSpinner.classList.remove('hidden');
            queryGuidelinesButton.disabled = true;
            queryGuidelinesButton.classList.add('opacity-70', 'cursor-not-allowed');
            guidelineList.innerHTML = ''; 
            guidelineListContainer.classList.add('hidden');
            const guidelineQueryPrompt = `æ‚¨æ˜¯ä¸€ä½ AI åŠ©æ‰‹ï¼Œä»»å‹™æ˜¯ä½¿ç”¨ Google æœå°‹ä¾†**å³æ™‚æŸ¥æ ¸**ä»¥ä¸‹å¸¸è¦‹è‡¨åºŠæŒ‡å¼•çš„ã€Œæœ€æ–°ç™¼å¸ƒå¹´ä»½ã€ã€‚\næ‚¨çš„å›è¦†å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œåƒ…å›å‚³åˆ—è¡¨ï¼Œä¸è¦æœ‰ä»»ä½•å‰è¨€æˆ–çµèªï¼š\n* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šGINA - Asthma) - [æœ€æ–°å¹´ä»½]\n* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šGOLD - COPD) - [æœ€æ–°å¹´ä»½]\n* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šAHA/ACC - Hypertension) - [æœ€æ–°å¹´ä»½]\n* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šSurviving Sepsis Campaign) - [æœ€æ–°å¹´ä»½]\n* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šIDSA - Skin and Soft Tissue Infections) - [æœ€æ–°å¹´ä»½]\n* [æŒ‡å¼•åç¨±] (ä¾‹å¦‚ï¼šKDIGO - CKD) - [æœ€æ–°å¹´ä»½]`;
            const userPrompt = "è«‹ç«‹å³ä½¿ç”¨ Google æœå°‹ï¼Œå¹«æˆ‘æŸ¥è©¢ GINA (Asthma), GOLD (COPD), AHA/ACC (Hypertension), Surviving Sepsis Campaign, IDSA (Skin and Soft Tissue Infections), ä»¥åŠ KDIGO (CKD) çš„æœ€æ–°æŒ‡å¼•ç™¼å¸ƒå¹´ä»½ã€‚";
            try {
                const { text } = await callGeminiAPI(guidelineQueryPrompt, userPrompt, true);
                const lines = text.split('\n').filter(line => line.trim().length > 0);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        guidelineList.appendChild(li);
                    });
                    guidelineListContainer.classList.remove('hidden');
                } else { throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„åˆ—è¡¨ã€‚"); }
            } catch (error) {
                console.error("æŸ¥è©¢æŒ‡å¼•æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                guidelineList.innerHTML = `<li class="text-red-600">æŸ¥è©¢å¤±æ•—ï¼š${error.message}</li>`;
                guidelineListContainer.classList.remove('hidden');
            } finally {
                guidelineSpinner.classList.add('hidden');
                queryGuidelinesButton.disabled = false;
                queryGuidelinesButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // v20.0: ç”¢ç”Ÿç­†è¨˜ (*** æ ¸å¿ƒ ***)
        generateButton.addEventListener('click', async () => {
            if (!termsCheckbox.checked) {
                showError("è«‹å…ˆé–±è®€ä¸¦å‹¾é¸åŒæ„ã€Œä½¿ç”¨æ¢æ¬¾ã€ã€‚");
                return;
            }
            
            const provider = apiProviderSelect.value;
            let activeApiKey = "";
            if (provider === 'gemini') activeApiKey = appSettings.apiKeys.gemini;
            if (provider === 'grok') activeKey = appSettings.apiKeys.grok;
            if (activeApiKey === "") {
                showError(`è«‹å…ˆåœ¨ã€Œè¨­å®šã€é é¢è¨­å®š ${provider} çš„ API é‡‘é‘°ã€‚`);
                return;
            }
            
            const patientInfo = patientInfoInput.value;
            if (!patientInfo.trim()) {
                showError("è«‹è¼¸å…¥ã€Œç—…æ‚£æ ¸å¿ƒè³‡æ–™ã€ã€‚");
                return;
            }

            // --- UI ç‹€æ…‹æ›´æ–° (é–‹å§‹) ---
            progressBarContainer.style.display = 'block';
            placeholderDiv.classList.add('animate-pulse');
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearInputsButton.disabled = true;
            clearSoapOutputs(); // v19.0: ä½¿ç”¨æ­¤å‡½å¼æ¸…ç©ºæ‰€æœ‰è¼¸å‡ºï¼ŒåŒ…æ‹¬èˆŠåœ–è¡¨
            placeholderDiv.classList.remove('hidden'); // ç¢ºä¿ placeholder é¡¯ç¤º

            // *** v20.0: å•Ÿå‹•è‡ªå‹•è£½åœ– (å¾æ–°æ¬„ä½è®€å–) ***
            parseAndRenderCharts(chartingDataInput.value);

            // *** v18.0: å•Ÿå‹•è‡ªå‹•è¨ˆç®— (å¾èˆŠæ¬„ä½è®€å–) ***
            const autoCalculatedResults = parseAndAutoCalculate(patientInfo);
            autoCalcList.innerHTML = autoCalculatedResults
                .map(res => `<li>${res.includes("ç„¡è³‡æ–™") ? `<span class="text-gray-400">${res}</span>` : `<strong>${res}</strong>`}</li>`)
                .join('');
            autoCalcDisplay.classList.remove('hidden');


            // v18.2: å»ºç«‹ Prompt (å¼·åŒ–æ™‚åºåˆ†æ)
            const systemPrompt = `æ‚¨æ˜¯ä¸€ä½é ‚å°–çš„è‡¨åºŠè—¥å¸«ï¼Œæ“æœ‰è±å¯Œçš„ç¶“é©—ï¼Œä¸¦ä¸”éš¨æ™‚æŒæ¡æœ€æ–°çš„åœ‹éš›é†«ç™‚æŒ‡å¼•ã€‚

æ‚¨çš„ä»»å‹™æ˜¯ (v18.2)ï¼š
1.  ä»”ç´°åˆ†æä½¿ç”¨è€…åœ¨ [ç—…æ‚£æ ¸å¿ƒè³‡æ–™] ä¸­æä¾›çš„è³‡è¨Š (ç—…å²ã€Labã€ç”¨è—¥ç­‰)ã€‚

// --- ğŸš¨ ç¬¬ 1.1 é» (v18.2 æ–°å¢ï¼šæ™‚åºåˆ†æ) ---
1.1 (æ¥µé‡è¦) æ‚¨å¿…é ˆ**ç‰¹åˆ¥æ³¨æ„** Lab data (ä¾‹å¦‚ SCr, K+, WBC) æˆ– Vital Signs çš„**ã€Œæ™‚åºæ€§è®ŠåŒ–ã€**ã€‚
    * ç¯„ä¾‹ï¼šå¦‚æœè³‡æ–™é¡¯ç¤º \`SCr: 1.2 (10/1) -> 1.5 (10/2) -> 1.3 (10/3)\`ã€‚
    * æ‚¨**ä¸æ‡‰**åªæŠ“å–ç¬¬ä¸€å€‹å€¼ (1.2) æˆ–æœ€å¾Œä¸€å€‹å€¼ (1.3)ã€‚
    * æ‚¨å¿…é ˆåœ¨ (A) ä¸­è©•ä¼°é€™å€‹ã€Œå…ˆä¸Šå‡å†ä¸‹é™ã€çš„**è¶¨å‹¢**ï¼Œä¾‹å¦‚ï¼š"ç—…æ‚£è…åŠŸèƒ½æ–¼ 10/2 å‡ºç¾æ€¥æ€§æƒ¡åŒ– (SCr 1.5)ï¼Œç›®å‰å·²æ”¹å–„ (1.3)ï¼Œä½†ä»éœ€ç›£æ¸¬..."ã€‚
    * é€™å°æ–¼è©•ä¼° AKIã€é›»è§£è³ªè®ŠåŒ–ã€æ„ŸæŸ“æŒ‡æ¨™ (WBC, CRP) çš„æ²»ç™‚åæ‡‰è‡³é—œé‡è¦ã€‚
// --- ğŸš¨ çµæŸ ---

2.  è‡ªå‹•è­˜åˆ¥å‡ºæœ€ç›¸é—œçš„ä¸»è¦ç—…ç—‡ã€‚
3.  (æœ€é‡è¦) **ä½¿ç”¨ Google æœå°‹ä¾†æŸ¥æ‰¾ä¸¦ç¢ºèª**è©²ç—…ç—‡**ã€Œå¯¦éš›çš„æœ€æ–°æŒ‡å¼•ç‰ˆæœ¬å’Œå¹´ä»½ã€**ã€‚(Grok æ¨¡å‹è«‹ä½¿ç”¨å…§å»ºæœå°‹)
    * æ‚¨å¿…é ˆç†è§£ï¼ŒæŒ‡å¼•**ä¸¦éæ¯å¹´æ›´æ–°**ã€‚

    // --- ğŸš¨ ç¬¬ 3.1 é» (å¼·åˆ¶å„ªå…ˆç´š) ---
    3.1 åœ¨æœå°‹æŒ‡å¼•æ™‚ï¼Œæ‚¨**å¿…é ˆ**å„ªå…ˆæŸ¥æ‰¾ä¸¦å¼•ç”¨ä»¥ä¸‹å…¨çƒå…¬èªçš„æ¬Šå¨ä¾†æºï¼š
        * **å¿ƒè¡€ç®¡:** ACC/AHA, ESC
        * **è…«ç˜¤:** NCCN, ASCO, ESMO
        * **ç³–å°¿ç—…/å…§åˆ†æ³Œ:** ADA, AACE
        * **èƒ¸è…” (COPD/Asthma):** GOLD, GINA
        * **æ„ŸæŸ“:** IDSA
        * **è…è‡Ÿ:** KDIGO
        * **é¢¨æ¿•å…ç–«:** ACR, EULAR
        å¦‚æœ**ç¢ºå¯¦ç„¡æ³•**åœ¨é€™äº›ä¾†æºä¸­æ‰¾åˆ°ç›´æ¥ç›¸é—œçš„æœ€æ–°æŒ‡å¼•ï¼Œæ‰èƒ½åƒè€ƒå…¶ä»–ä¿¡è­½è‰¯å¥½çš„ä¾†æºï¼Œä½†**å¿…é ˆåœ¨ (A) ä¸­æ˜ç¢ºèªªæ˜**ã€‚
    // --- ğŸš¨ çµæŸ ---

4.  (é‡è¦) **è«‹åˆ†æ**ç—…æ‚£ç›®å‰ç”¨è—¥æ¸…å–®ä¸­çš„**æ½›åœ¨è—¥ç‰©äº¤äº’ä½œç”¨ (DDI)** æˆ–**é‡è¤‡ç”¨è—¥ (Duplicate Therapy)**ã€‚
5.  (v14.1) å¦‚æœä½¿ç”¨è€…æä¾›äº† [å°ˆç§‘ç„¦é»] (ä¾‹å¦‚ "å¿ƒè‡Ÿå…§K")ï¼Œæ‚¨çš„è©•ä¼°æ‡‰æ›´å´é‡æ–¼è©²é ˜åŸŸã€‚

6.  (v18.0 é‚è¼¯) æ‚¨**å¿…é ˆ**è‡ªè¡Œå¾ [ç—…æ‚£æ ¸å¿ƒè³‡æ–™] æ¬„ä½ä¸­æŠ“å– eGFR, Lab, Age, Child-Pugh Grade (å¦‚æœæœ‰æä¾›) ç­‰è³‡è¨Šä¾†é€²è¡Œè©•ä¼°ã€‚

7.  (v16.2 æ–°å¢ä»»å‹™) å¦‚æœä½¿ç”¨è€…åœ¨ [å¥ä¿çµ¦ä»˜è¦ç¯„] æ¬„ä½æä¾›äº†è³‡è¨Šï¼Œæ‚¨**å¿…é ˆ**å°‡å…¶ä½œç‚º**æœ€é«˜å„ªå…ˆç´š**çš„è©•ä¼°é …ç›®ä¹‹ä¸€ã€‚
    * æ‚¨çš„ä»»å‹™æ˜¯ï¼š**æ ¹æ“šç—…æ‚£çš„è¨ºæ–·ã€Labã€å’Œè¨ˆç®—å‡ºçš„åˆ†æ•¸ (å¦‚ Child-Pugh, CrCl)ï¼Œåš´æ ¼åˆ¤æ–·**ç›®å‰çš„è™•æ–¹æ˜¯å¦ç¬¦åˆé€™äº›å¥ä¿è¦ç¯„ã€‚
    * å¿…é ˆåœ¨ (A) æˆ– (P) ä¸­æå‡ºæ‚¨çš„**æ˜ç¢ºè©•ä¼°** (ä¾‹å¦‚ï¼š"ç¬¦åˆ OOO è—¥ç‰©çš„å¥ä¿çµ¦ä»˜æ¢ä»¶" æˆ– "ç›®å‰ Child-Pugh Bï¼Œä¸ç¬¦åˆ OOO çµ¦ä»˜æ¨™æº–ï¼Œæé­æ ¸åˆª")ã€‚

8.  (v15.2) ä½¿ç”¨è€…å¯èƒ½æœƒåœ¨ [UpToDate è³‡æ–™], [Micromedex è³‡æ–™], [OpenEvidence è³‡æ–™] æ¬„ä½æä¾›è£œå……è³‡è¨Šã€‚
9.  (v15.2) å¦‚æœç¬¬ 8 é»çš„æ¬„ä½ã€Œæœ‰å…§å®¹ã€ï¼Œæ‚¨**å¿…é ˆ**å°‡é€™äº›é‡é»æ•´åˆåˆ°æ‚¨çš„ (A) æˆ– (P) ä¸­ï¼Œä¸¦ä¸”**ã€Œæ˜ç¡®è¨»æ˜ä¾†æºã€**ã€‚

10. æ ¹æ“šã€ŒSOAPã€æ ¼å¼ï¼Œæ’°å¯«ä¸€ä»½å°ˆæ¥­ã€ç²¾ç¢ºã€æ ¼å¼åŒ–çš„è—¥å¸«ç­†è¨˜è‰ç¨¿ (ä¿ç•™ç²—é«”å’Œæ›è¡Œ)ã€‚

11. åœ¨æ‚¨çš„ã€ŒAssessment (A)ã€éƒ¨åˆ†ï¼š
    * **(v18.2 å¼·åˆ¶)** **å¿…é ˆåŒ…å«**æ‚¨å° Lab data **æ™‚åºæ€§è¶¨å‹¢**çš„åˆ†æ (åƒè¦‹ç¬¬ 1.1 é»)ã€‚
    * **(v14.1 å¼·åˆ¶)** **å¿…é ˆæ˜ç¢ºæåŠ**æ‚¨åƒè€ƒçš„æŒ‡å¼•åç¨±èˆ‡**ã€Œå¯¦éš›å¹´ä»½ã€**ã€‚
    * **(v14.1 å¼·åˆ¶)** **å¿…é ˆå¼•ç”¨**è©²æŒ‡å¼•ä¸­çš„**ã€Œç²¾ç¢ºåŸæ–‡å¥å­ã€**ä¾†æ”¯æŒæ‚¨çš„è‡¨åºŠæ±ºç­–ã€‚
    * **å¿…é ˆåŒ…å«**æ‚¨å° DDI æˆ–é‡è¤‡ç”¨è—¥çš„è©•ä¼°ã€‚
    * **å¿…é ˆåŒ…å«**å°è…åŠŸèƒ½ (eGFR æˆ– CrCl) çš„è€ƒé‡èˆ‡åŠ‘é‡è©•ä¼° (ä¸¦çµåˆæ™‚åºæ€§è¶¨å‹¢)ã€‚
    * **(v16.1)** **å¿…é ˆåŒ…å«**å°è‚åŠŸèƒ½ (Child-Pugh Score) çš„è€ƒé‡èˆ‡åŠ‘é‡è©•ä¼°ã€‚
    * **(v16.2)** **å¿…é ˆåŒ…å«**æ‚¨å°å¥ä¿è¦ç¯„çš„æ ¸å°çµæœ (å¦‚æœä½¿ç”¨è€…æœ‰æä¾›è¦ç¯„)ã€‚

12. åœ¨æ‚¨çš„ã€ŒPlan (P)ã€éƒ¨åˆ†ï¼š
    * æ‚¨çš„æ‰€æœ‰å»ºè­°éƒ½å¿…é ˆ**ç¬¦åˆ**æ‚¨åœ¨ (A) ä¸­æåˆ°çš„æœ€æ–°æŒ‡å¼•ï¼Œä¸¦ä¸”**ä¸å¾—é•å** (A) ä¸­æåˆ°çš„å¥ä¿çµ¦ä»˜è¦ç¯„ã€‚

13. (v18.0 é«”é‡é‚è¼¯æ›´æ–°) æ‚¨**å¿…é ˆ**è‡ªè¡Œå¾ [ç—…æ‚£æ ¸å¿ƒè³‡æ–™] æŠ“å– Height/Weightï¼Œè‡ªè¡Œè©•ä¼° IBW/ABWã€‚å¦‚æœç—…æ‚£é«”é‡éèƒ– (ä¾‹å¦‚ TBW/IBW > 1.2)ï¼Œæ‚¨æ‡‰**å»ºè­°**ä½¿ç”¨ã€Œèª¿æ•´é«”é‡ (Adjusted Body Weight, ABW)ã€ä¾†è¨ˆç®—æ°´æº¶æ€§è—¥ç‰©åŠ‘é‡ã€‚

14. (*** v16.2 æ ¼å¼è¦æ±‚ ***)
    * æ‚¨çš„å›è¦†**å¿…é ˆ**åš´æ ¼éµå®ˆæ­¤æ ¼å¼ï¼š
    [å®Œæ•´çš„ SOAP ç­†è¨˜ (S, O, A, P)]
    ---GUIDELINES_USED---
    * [æŒ‡å¼• 1 åç¨±] - [å¹´ä»½]
    * [æŒ‡å¼• 2 åç¨±] - [å¹´ä»½]
    * [å…¶ä»–åƒè€ƒçš„ DDI è³‡æ–™åº«æˆ–æ–‡ç»]
    * (v15.2) [è‹¥æœ‰ä½¿ç”¨ UpToDate, è«‹è¨»æ˜]
    * (v15.2) [è‹¥æœ‰ä½¿ç”¨ Micromedex, è«‹è¨»æ˜]
    * (v15.2) [è‹¥æœ‰ä½¿ç”¨ OpenEvidence, è«‹è¨»æ˜]
    * (v16.2) [è‹¥æœ‰ä½¿ç”¨ å¥ä¿çµ¦ä»˜è¦ç¯„, è«‹è¨»æ˜]

15. (*** v19.2 ç‰¹åˆ¥æŒ‡ç¤º ***)
    * AI **ä¸éœ€è¦**è®€å–æˆ–åˆ†æ `[è¦–è¦ºåŒ–åœ–è¡¨è³‡æ–™]` æ¬„ä½ï¼Œè©²æ¬„ä½åƒ…ä¾›å‰ç«¯è£½åœ–ä½¿ç”¨ã€‚AI åªéœ€è¦å°ˆæ³¨æ–¼ `[ç—…æ‚£æ ¸å¿ƒè³‡æ–™]`ã€‚
16. (*** v14.4 æ ¼å¼ç¦æ­¢ ***)
    * **ç¦æ­¢**åœ¨æ‚¨çš„å›è¦†ä¸­ä½¿ç”¨ä»»ä½• LaTeX èªæ³•ã€‚å¿…é ˆç›´æ¥ä½¿ç”¨ Unicode å­—å…ƒ (ä¾‹å¦‚ï¼šÎ², Î±, Â°, â‰ˆ, mmHg)ã€‚`;
            
            const specialtyFocus = specialtyFocusSelect.value;
            const uptodateInfo = uptodateInfoInput.value.trim();
            const micromedexInfo = micromedexInfoInput.value.trim();
            const openevidenceInfo = openevidenceInfoInput.value.trim();
            const nhiGuidelinesInfo = nhiGuidelinesInfoInput.value.trim();

            let userPrompt = `--- ç—…æ‚£æ ¸å¿ƒè³‡æ–™ (å¿…å¡«) START ---\n${patientInfo}\n--- ç—…æ‚£æ ¸å¿ƒè³‡æ–™ END ---\n`;
            // v19.2: ä¸å†å‚³é€ chartingData çµ¦ AI
            if (specialtyFocus) { userPrompt += `\n--- å°ˆç§‘ç„¦é» (é¸å¡«) ---\n${specialtyFocus}\n`; }
            if (uptodateInfo) { userPrompt += `\n--- UpToDate è³‡æ–™ (é¸å¡«) START ---\n${uptodateInfo}\n--- UpToDate è³‡æ–™ END ---\n`; }
            if (micromedexInfo) { userPrompt += `\n--- Micromedex è³‡æ–™ (é¸å¡«) START ---\n${micromedexInfo}\n--- Micromedex è³‡æ–™ END ---\n`; }
            if (openevidenceInfo) { userPrompt += `\n--- OpenEvidence è³‡æ–™ (é¸å¡«) START ---\n${openevidenceInfo}\n--- OpenEvidence è³‡æ–™ END ---\n`; }
            if (nhiGuidelinesInfo) { userPrompt += `\n--- å¥ä¿çµ¦ä»˜è¦ç¯„ (é¸å¡«) START ---\n${nhiGuidelinesInfo}\n--- å¥ä¿çµ¦ä»˜è¦ç¯„ END ---\n`; }
            userPrompt += `\nè«‹æ ¹æ“šä¸Šè¿°æ‰€æœ‰è³‡è¨Šï¼Œä½¿ç”¨æœ€æ–°çš„åœ‹éš›æŒ‡å¼•ç”¢ç”Ÿä¸€ä»½è—¥å¸« SOAP ç­†è¨˜ã€‚`;

            try {
                let text = "";
                let sources = [];
                
                if (provider === 'gemini') {
                    const result = await callGeminiAPI(systemPrompt, userPrompt, true);
                    text = result.text;
                    sources = result.sources;
                } else if (provider === 'grok') {
                    const result = await callGrokAPI(systemPrompt, userPrompt);
                    text = result.text;
                    sources = result.sources; // Grok API æ¨™æº–å›å‚³ä¸å« sources
                }
                
                // --- è™•ç†å›å‚³çµæœ (åŒ v17.4) ---
                const delimiter = '---GUIDELINES_USED---';
                let soapNote = text;
                let guidelinesText = '';
                let hasContent = false; 

                if (text.includes(delimiter)) {
                    const parts = text.split(delimiter);
                    soapNote = parts[0].trim();
                    guidelinesText = parts[1].trim();
                }
                
                // LaTeX æ¸…ç†
                soapNote = soapNote.replace(/\$\$(.*?)\$\$/g, '$1').replace(/\$(.*?)\$/g, '$1')
                                 .replace(/\\text\{(.*?)\}/g, '$1').replace(/\\beta/g, 'Î²')
                                 .replace(/\\alpha/g, 'Î±').replace(/\\gamma/g, 'Î³')
                                 .replace(/\\delta/g, 'Î´').replace(/\\approx/g, 'â‰ˆ')
                                 .replace(/\\circ/g, 'Â°').replace(/\\textdegree/g, 'Â°')
                                 .replace(/\\mmHg/g, 'mmHg').replace(/\\/g, '')
                                 .replace(/\{/g, '').replace(/\}/g, '');
                
                let safeHtml = soapNote.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                safeHtml = safeHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                outputDiv.innerHTML = `<pre>${safeHtml}</pre>`;
                outputDiv.classList.remove('hidden');
                placeholderDiv.classList.add('hidden');
                infoBox.classList.remove('hidden');

                if (guidelinesText) {
                    const lines = guidelinesText.split('\n').filter(line => line.trim().length > 0);
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        li.className = 'text-gray-800 font-semibold'; 
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }

                if (sources && sources.length > 0) { // ä¸»è¦ä¾†è‡ª Gemini
                    if (hasContent) {
                        const separator = document.createElement('li');
                        separator.innerHTML = '<hr class="my-2 border-gray-300">';
                        sourcesList.appendChild(separator);
                    }
                    sourcesTitle.textContent = 'å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æº (ä¾†è‡ª Google Search)ï¼š';
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = source.uri; a.target = '_blank'; a.rel = 'noopener noreferrer';
                        a.className = 'text-blue-600 hover:underline';
                        a.textContent = source.title || 'ç›¸é—œåƒè€ƒæ–‡ä»¶';
                        li.appendChild(a);
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }
                
                if (hasContent) {
                    sourcesContainer.classList.remove('hidden');
                }
                
                copyButton.disabled = false;

            } catch (error) {
                console.error(`ç”¢ç”Ÿ SOAP ç­†è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤ (${provider}):`, error);
                showError(`ç„¡æ³•ç”¢ç”Ÿç­†è¨˜ (${provider})ï¼š${error.message}`);
                copyButton.disabled = true;
            } finally {
                progressBarContainer.style.display = 'none';
                placeholderDiv.classList.remove('animate-pulse');
                generateButton.disabled = !termsCheckbox.checked; 
                if (termsCheckbox.checked) {
                    generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                clearInputsButton.disabled = false;
            }
        });

        // v18.1: æ¸…é™¤æŒ‰éˆ• (Dashboard)
        clearInputsButton.addEventListener('click', () => {
            // é€™å€‹æŒ‰éˆ•ç¾åœ¨åªæ¸…é™¤è¼¸å…¥ï¼Œä¸å½±éŸ¿ "å°ˆæ¡ˆ" æœ¬èº«
            patientInfoInput.value = '';
            chartingDataInput.value = ''; // v19.2: æ–°å¢
            specialtyFocusSelect.value = '';
            uptodateInfoInput.value = '';
            micromedexInfoInput.value = '';
            openevidenceInfoInput.value = '';
            nhiGuidelinesInfoInput.value = '';
            termsCheckbox.checked = false;
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearSoapOutputs();
        });

        // v17.4: è¤‡è£½æŒ‰éˆ• (ä¸è®Š)
        copyButton.addEventListener('click', () => {
            const preElement = outputDiv.querySelector('pre');
            const textToCopy = preElement ? (preElement.textContent || preElement.innerText) : '';
            if (!textToCopy) { showError("æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½ã€‚"); return; }
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.textContent = "å·²è¤‡è£½!";
                    setTimeout(() => { copyButton.textContent = "ä¸€éµè¤‡è£½"; }, 2000);
                } else { showError("è¤‡è£½å¤±æ•—ã€‚"); }
            } catch (err) { showError(`è¤‡è£½å¤±æ•—ï¼š${err.message}`); }
            document.body.removeChild(textArea);
        });

    </script>
    </body>
</html>