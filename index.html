<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v21.6 - Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        body { font-family: "Inter", system-ui, sans-serif; }
        .spinner { border-top-color: transparent; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* è¦–åœ–åˆ‡æ› */
        .view { display: none; }
        
        /* å°è¦½åˆ— */
        .nav-button { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; font-weight: 500; color: #4b5563; cursor: pointer; }
        .nav-button:hover { background-color: #f3f4f6; }
        .nav-button.active { background-color: #3b82f6; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* å°ˆæ¡ˆåˆ—è¡¨ */
        .project-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: white; transition: all 0.2s; }
        .project-item:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-color: #3b82f6; }
        .project-name { font-weight: 600; color: #1f2937; cursor: pointer; flex-grow: 1; }
        .project-date { font-size: 0.875rem; color: #6b7280; margin-right: 1rem; }
        .project-delete-btn { background-color: #fee2e2; color: #dc2626; border-radius: 9999px; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.2s; }
        .project-delete-btn:hover { background-color: #dc2626; color: white; }
        
        /* CSS for Chart Cards (Grid Layout) */
        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { .chart-grid { grid-template-columns: repeat(2, 1fr); } }
        .chart-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; border: 1px solid #f3f4f6; transition: transform 0.2s; }
        .chart-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .chart-title { text-align: center; font-size: 1.125rem; font-weight: 700; color: #374151; margin-bottom: 1rem; }

        /* General Styles */
        .prose pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; }
        .terms-section { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .calc-button { background-color: #10b981; color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: background-color 0.2s; }
        .calc-button:hover { background-color: #059669; }
        .calculator-content { padding: 1rem; border: 1px solid #e5e7eb; background-color: #ffffff; border-radius: 0.5rem; margin-top: 0.5rem;}
        
        /* Progress Bar */
        #progressBarContainer { display: none; width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 0.75rem; background-color: #3b82f6; border-radius: 9999px; animation: indeterminate-progress 2s linear infinite; }
        @keyframes indeterminate-progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v21.6)</h1>
            <p class="mt-2 text-lg text-gray-600">å°ˆæ¡ˆç®¡ç†ãƒ»AI é©…å‹•çš„æŒ‡å¼•æŸ¥æ ¸ãƒ»å¯è¦–åŒ–åœ–è¡¨</p>
        </header>

        <nav class="bg-white p-2 rounded-lg shadow-md mb-6 flex flex-wrap items-center justify-center gap-2 md:gap-4">
            <button id="nav-home" class="nav-button active">ä¸»é  / å°ˆæ¡ˆ</button>
            <button id="nav-soap-note" class="nav-button">SOAP ç­†è¨˜</button>
            <button id="nav-calculator" class="nav-button">è‡¨åºŠè¨ˆç®—æ©Ÿ</button>
            <button id="nav-settings" class="nav-button">è¨­å®š</button>
        </nav>

        <main>
            <div id="view-home" class="view" style="display: block;">
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">å°ˆæ¡ˆç®¡ç†</h2>
                    <button id="newProjectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 transition-transform duration-200 hover:scale-105 flex items-center justify-center text-lg">
                        æ–°å¢ SOAP ç­†è¨˜å°ˆæ¡ˆ
                    </button>
                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-3">å·²å„²å­˜çš„å°ˆæ¡ˆ</h3>
                    <div id="projectListContainer" class="space-y-3">
                        <p id="noProjectsMessage" class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰å·²å„²å­˜çš„å°ˆæ¡ˆã€‚</p>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">åŠŸèƒ½èªªæ˜</h2>
                    <div class="prose text-sm text-gray-600 mt-4">
                        <ul class="list-disc pl-5">
                            <li><strong>v21.6 ä¿®æ­£ï¼š</strong> è§£æ±ºç”˜ç‰¹åœ–åœ¨ç·Šæ¹Šæ—¥æœŸæ ¼å¼ (å¦‚ 10/1-10/25) ä¸‹è§£æéŒ¯èª¤çš„å•é¡Œã€‚</li>
                            <li><strong>v21.5 ç¾åŒ–ï¼š</strong> ç”˜ç‰¹åœ–æ¡ç”¨è—¥ä¸¸å½¢ç‹€è¨­è¨ˆï¼ŒLab åœ–è¡¨æ”¯æ´è‡ªå‹•åˆ†çµ„èˆ‡é›™ Y è»¸ã€‚</li>
                            <li><strong>v21.4 å¢å¼·ï¼š</strong> Lab æ•¸æ“šæ”¯æ´ç„¡å†’è™Ÿçš„é¬†æ•£æ ¼å¼è¼¸å…¥ã€‚</li>
                        </ul>
                    </div>
                </section>
            </div>

            <div id="view-soap-note" class="view">
                <section class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div class="md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                            <input type="text" id="projectNameInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±...">
                        </div>
                        <div class="md:col-span-2 flex flex-wrap gap-2 justify-end items-center">
                            <button id="saveProjectButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">å„²å­˜</button>
                            <button id="saveAsProjectButton" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">å¦å­˜æ–°æª”</button>
                            <button id="deleteProjectButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">åˆªé™¤</button>
                        </div>
                    </div>
                </section>

                <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">1. è¼¸å…¥ç—…æ‚£è³‡æ–™</h2>
                            <button id="clearInputsButton" class="text-sm text-slate-500 hover:text-red-600 font-medium py-1 px-2 rounded-lg hover:bg-red-50">ä¸€éµæ¸…é™¤</button>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-600 mb-2">å°ˆç§‘ç„¦é» (é¸å¡«)</label>
                            <select id="specialtyFocus" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <option value="" selected>ç„¡ç‰¹å®šç§‘åˆ¥ (ç¶œåˆè©•ä¼°)</option>
                                <option value="å¿ƒè‡Ÿå…§ç§‘">å¿ƒè‡Ÿå…§ç§‘ (Cardiology)</option>
                                <option value="èƒ¸è…”å…§ç§‘">èƒ¸è…”å…§ç§‘ (Pulmonology)</option>
                                <option value="è…è‡Ÿå…§ç§‘">è…è‡Ÿå…§ç§‘ (Nephrology)</option>
                                <option value="æ„ŸæŸ“ç§‘">æ„ŸæŸ“ç§‘ (Infectious Disease)</option>
                                <option value="æ–°é™³ä»£è¬ç§‘">æ–°é™³ä»£è¬ç§‘ (Metabolism)</option>
                                <option value="åŠ è­·ç—…æˆ¿">åŠ è­·ç—…æˆ¿ (ICU)</option>
                            </select>
                        </div>

                        <div class="terms-section">
                            <h3 class="font-bold">ä½¿ç”¨æ¢æ¬¾ (å¿…è®€)</h3>
                            <ul class="list-disc pl-5 text-sm mt-1">
                                <li>æ‰€æœ‰è¼¸å…¥è³‡æ–™**å‡é ˆå·²å»è­˜åˆ¥åŒ–**ã€‚</li>
                                <li>é•åéš±ç§è¦ç¯„ä¹‹æ³•å¾‹è²¬ä»»ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ“”ã€‚</li>
                            </ul>
                        </div>
                        <div class="flex items-center mb-4">
                            <input id="termsCheckbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="termsCheckbox" class="ml-2 block text-sm text-gray-900">æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°ã€Œä½¿ç”¨æ¢æ¬¾ã€ã€‚</label>
                        </div>

                        <div class="mb-4">
                            <label for="patientInfo" class="block text-sm font-medium text-gray-600 mb-2">ç—…æ‚£æ ¸å¿ƒè³‡æ–™ (AI åˆ†æç”¨)</label>
                            <textarea id="patientInfo" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è²¼å…¥ã€Œå»è­˜åˆ¥åŒ–ã€å¾Œçš„ç—…æ‚£è³‡è¨Š..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="labDataInput" class="block text-sm font-medium text-gray-600 mb-2">
                                Lab æ•¸æ“š (è£½åœ–ç”¨) <span class="text-xs text-blue-600 font-bold">* æ”¯æ´ç„¡å†’è™Ÿèˆ‡è‡ªå‹•åˆ†çµ„</span>
                            </label>
                            <textarea id="labDataInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š
AST 40 (10/1)
Glucose (PC) 130 (10/2)
WBC: 15 (10/3)"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="medDataInput" class="block text-sm font-medium text-gray-600 mb-2">
                                ç”¨è—¥å² (ç”˜ç‰¹åœ–ç”¨) <span class="text-xs text-blue-600 font-bold">* v21.6 ä¿®æ­£æ—¥æœŸè§£æ</span>
                            </label>
                            <textarea id="medDataInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š
Vanco 1g Q12H (10/1-10/5)
Qtern 20mg (10/25-11/5)"></textarea>
                        </div>
                        
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ UpToDate (é¸å¡«)</label><textarea id="uptodateInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ Micromedex (é¸å¡«)</label><textarea id="micromedexInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ OpenEvidence (é¸å¡«)</label><textarea id="openevidenceInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆå¥ä¿çµ¦ä»˜è¦ç¯„ (é¸å¡«)</label><textarea id="nhiGuidelinesInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-600 mb-2">AI æ¨¡å‹é¸æ“‡</label>
                            <select id="apiProviderSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <option value="gemini" selected>Google Gemini (gemini-2.5-flash-preview)</option>
                                <option value="grok">Grok (xAI)</option>
                            </select>
                        </div>
                        <div class="mt-auto pt-4">
                            <button id="generateButton" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 opacity-70 cursor-not-allowed" disabled>
                                ğŸš€ å•Ÿå‹• AI åˆ†æ & è£½åœ–
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">2. ç”¢ç”Ÿçš„ç­†è¨˜è‰ç¨¿</h2>
                             <button id="copyButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:opacity-50" disabled>ä¸€éµè¤‡è£½</button>
                        </div>
                        <div id="progressBarContainer"><div class="progress-bar"></div></div>
                        
                        <div id="autoCalcDisplay" class="hidden mb-4 bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">è‡ªå‹•è¨ˆç®—åƒè€ƒï¼š</h4><div id="autoCalcList" class="text-sm space-y-1"></div>
                        </div>
                        
                        <div id="chartsContainer" class="hidden mb-6 p-6 border border-gray-100 rounded-2xl bg-white shadow-lg">
                            <div id="labChartsContainer">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">Lab æ•¸æ“šè¶¨å‹¢åœ–</h3>
                                <div id="labChartsGoHere" class="chart-grid"></div>
                                <p id="noLabChartMessage" class="text-gray-500 text-center py-2 hidden">æœªåµæ¸¬åˆ° Lab æ•¸æ“šã€‚</p>
                            </div>
                            <div id="ganttChartContainer" class="mt-6">
                                <div id="ganttChartGoHere">
                                    <canvas id="ganttChartCanvas" style="max-height: 300px;"></canvas>
                                </div>
                                <p id="noGanttChartMessage" class="text-gray-500 text-center py-2 hidden">æœªåµæ¸¬åˆ°ç”¨è—¥æ•¸æ“šã€‚</p>
                            </div>
                        </div>

                        <div id="placeholder" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-lg">
                            <p class="font-semibold">AI å°‡è‡ªå‹•åŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š</p>
                            <ul class="list-disc list-inside text-left mt-2 text-sm">
                                <li>è‡ªå‹•ç¹ªè£½ Lab è¶¨å‹¢åœ– (æ”¯æ´é›™è»¸/åˆ†çµ„) èˆ‡ç”¨è—¥ç”˜ç‰¹åœ–ã€‚</li>
                                <li>åˆ†ææ™‚åºæ€§è®ŠåŒ– (SCr è¶¨å‹¢ç­‰)ã€‚</li>
                                <li>è‡ªå‹•è¨ˆç®— CrCl, eGFR, CHA2DS2-VAScã€‚</li>
                                <li>è‡ªå‹•æ ¸å°å¥ä¿çµ¦ä»˜è¦ç¯„ã€‚</li>
                            </ul>
                        </div>
                        <div id="output" class="hidden prose max-w-none prose-pre:whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 200px;"></div>
                        <div id="sourcesContainer" class="hidden mt-6">
                            <h3 id="sourcesTitle" class="text-lg font-semibold text-gray-600 mb-2">å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æºï¼š</h3>
                            <ul id="sourcesList" class="list-none list-inside text-sm space-y-1"></ul>
                        </div>
                    </div>
                </main>
            </div>

            <div id="view-calculator" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">è‡¨åºŠè¨ˆç®—æ©Ÿ (æ‰‹å‹•)</h2>
                    <p class="text-gray-600 mb-6">æ­¤é é¢åƒ…ä¾›æ‰‹å‹•è¨ˆç®—ã€‚</p>
                    <details>
                        <summary>1. CrCl (C-G) & IBW/ABW</summary>
                        <div class="calculator-content grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="calc-label">æ€§åˆ¥</label><select id="manual_calcSex" class="calc-select"><option value="Male">ç”·æ€§</option><option value="Female">å¥³æ€§</option></select></div>
                            <div><label class="calc-label">å¹´é½¡</label><input type="number" id="manual_calcAge" class="calc-input"></div>
                            <div><label class="calc-label">é«”é‡ (kg)</label><input type="number" id="manual_calcWeight" class="calc-input"></div>
                            <div><label class="calc-label">èº«é«˜ (cm)</label><input type="number" id="manual_calcHeight" class="calc-input"></div>
                            <div><label class="calc-label">SCr</label><input type="number" id="manual_calcScr" class="calc-input"></div>
                            <button id="manual_calculateCrClBwButton" class="calc-button md:col-span-2 mt-2">è¨ˆç®—</button>
                            <div class="md:col-span-2 text-right"><span id="manual_crclResult" class="calc-result block"></span><span id="manual_bwResult" class="calc-result block"></span></div>
                        </div>
                    </details>
                </section>
            </div>

            <div id="view-settings" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6 border-l-4 border-blue-500">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-700">API é‡‘é‘°è¨­å®š</h2>
                     <div class="space-y-6">
                         <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API é‡‘é‘°</label>
                             <input type="password" id="geminiApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="AIzaSy...">
                             <p id="geminiApiStatus" class="text-sm mt-2 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚</p>
                         </div>
                         <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">Grok (xAI) API é‡‘é‘°</label>
                             <input type="password" id="grokApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="gk_...">
                             <p id="grokApiStatus" class="text-sm mt-2 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚</p>
                         </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                         <button id="saveSettingsButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700">å„²å­˜è¨­å®š</button>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <h3 class="text-lg font-medium text-gray-900 mt-2">ç™¼ç”ŸéŒ¯èª¤</h3>
                <p id="errorMessage" class="text-sm text-gray-500 mt-2 py-3"></p>
                <button id="closeModalButton" class="px-4 py-2 bg-red-500 text-white rounded-md w-full hover:bg-red-600">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <script>
        // === Global Variables & Settings ===
        let appSettings = { apiKeys: { gemini: "", grok: "" }, projects: [] };
        let currentProjectId = null; 
        let activeCharts = {}; 
        const appStorageKey = 'smartPharmacistSettings_v21.6';

        const views = { home: document.getElementById('view-home'), soapNote: document.getElementById('view-soap-note'), calculator: document.getElementById('view-calculator'), settings: document.getElementById('view-settings') };
        const navButtons = { home: document.getElementById('nav-home'), soapNote: document.getElementById('nav-soap-note'), calculator: document.getElementById('nav-calculator'), settings: document.getElementById('nav-settings') };
        
        // --- Charting Logic (v21.6 Fixed) ---

        function parseChartDate(dateString) {
            const parts = dateString.split(/[\/-]/);
            let year, month, day;
            if (parts.length === 3) {
                year = parseInt(parts[0]);
                if (year < 200) year += 1911; // æ°‘åœ‹å¹´
                month = parseInt(parts[1]) - 1;
                day = parseInt(parts[2]);
            } else if (parts.length === 2) {
                year = new Date().getFullYear();
                month = parseInt(parts[0]) - 1;
                day = parseInt(parts[1]);
            } else return null;
            
            const date = new Date(year, month, day);
            const today = new Date();
            // è·¨å¹´é‚è¼¯: å¦‚æœç¾åœ¨1æœˆï¼Œè¼¸å…¥12æœˆï¼Œè¦–ç‚ºå»å¹´
            if (parts.length === 2 && date.getMonth() > today.getMonth() + 1) date.setFullYear(year - 1);
            return date;
        }

        function parseLabDataForChart(text) {
            const labData = {};
            const lines = text.split('\n');
            const valueDateRegex = /(\d+(?:\.\d+)?)\s*.*?\s*\(?([\d\.\/-]+)\)?/g;
            const looseLineRegex = /^\s*(.*?)\s+(\d+(?:\.\d+)?)\s*.*?\s*\(?([\d\.\/-]+)\)?/;
            const ganttRegex = /^\s*.*?(\([\d\.\/-]+\s*[-~to]\s*[\d\.\/-]+\))/; // Gantt check

            lines.forEach(line => {
                if (!line.trim() || ganttRegex.test(line)) return; 
                
                let labName = "", dataString = "";
                const parts = line.split(/[:ï¼š]/);
                
                if (parts.length >= 2) {
                    labName = parts[0].trim();
                    dataString = parts.slice(1).join(':'); 
                } else {
                    const match = line.match(looseLineRegex);
                    if (match) { labName = match[1].trim(); dataString = `${match[2]} (${match[3]})`; }
                    else return;
                }
                if (!labName) return;
                if (!labData[labName]) labData[labName] = { labels: [], data: [] };
                
                valueDateRegex.lastIndex = 0;
                let pointMatch;
                while ((pointMatch = valueDateRegex.exec(dataString)) !== null) {
                    const value = parseFloat(pointMatch[1]);
                    const dateObj = parseChartDate(pointMatch[2]);
                    if (!isNaN(value) && dateObj) {
                        labData[labName].labels.push(dateObj);
                        labData[labName].data.push(value);
                    }
                }
            });
            return labData;
        }

        // v21.3 ç¾åŒ–ç‰ˆ: æ¸²æŸ“ Lab åœ–è¡¨ (å«åˆ†çµ„ã€é›™è»¸)
        function renderLabCharts(labData) {
            let chartsCreated = 0;
            const container = document.getElementById('labChartsGoHere');
            container.innerHTML = ''; 
            
            const labConfig = {
                groups: [
                    { name: 'è‚åŠŸèƒ½ (Liver)', keys: ['AST', 'GOT', 'ALT', 'GPT'], type: 'liver' },
                    { name: 'ç™¼ç‚æŒ‡æ¨™ (Infection)', keys: ['WBC', 'CRP', 'PCT'], type: 'infection' },
                    { name: 'è…åŠŸèƒ½ (Kidney)', keys: ['SCr', 'Cr', 'BUN'], type: 'kidney' },
                    { name: 'é›»è§£è³ª (Electrolytes)', keys: ['Na', 'K', 'Cl'], type: 'electrolytes' },
                    { name: 'è¡€ç³– (Glucose)', keys: ['Glucose', 'HbA1c'], type: 'glucose' },
                    { name: 'è¡€è‰²ç´  (Hemoglobin)', keys: ['Hb', 'Hgb', 'Hct'], type: 'blood' }
                ],
                settings: {
                    'AST': { color: '#EF4444' }, 'GOT': { color: '#EF4444' },
                    'ALT': { color: '#F59E0B' }, 'GPT': { color: '#F59E0B' },
                    'WBC': { color: '#3B82F6', yAxisID: 'y' }, 
                    'CRP': { color: '#8B5CF6', yAxisID: 'y1' },
                    'PCT': { color: '#EC4899', yAxisID: 'y1' },
                    'SCr': { color: '#10B981' }, 'Cr': { color: '#10B981' },
                    'BUN': { color: '#06B6D4' }, 'Na': { color: '#6366F1' },
                    'K':   { color: '#F43F5E' }
                },
                defaultColors: ['#64748B', '#94A3B8']
            };

            let usedKeys = new Set();
            let processedGroups = [];

            // è™•ç†åˆ†çµ„
            labConfig.groups.forEach(group => {
                let datasets = [];
                let hasDualAxis = false;
                group.keys.forEach(key => {
                    const matchedKey = Object.keys(labData).find(k => k.toUpperCase().includes(key.toUpperCase()));
                    if (matchedKey && !usedKeys.has(matchedKey) && labData[matchedKey].data.length > 0) {
                        const setting = labConfig.settings[key] || {};
                        const color = setting.color || labConfig.defaultColors[0];
                        const yAxisID = setting.yAxisID || 'y';
                        if (yAxisID === 'y1') hasDualAxis = true;

                        datasets.push({
                            label: matchedKey,
                            data: labData[matchedKey].data.map((v, i) => ({ x: labData[matchedKey].labels[i], y: v })),
                            borderColor: color, backgroundColor: color, pointBackgroundColor: 'white',
                            pointBorderColor: color, pointRadius: 5, pointHoverRadius: 7,
                            borderWidth: 2.5, tension: 0.4, yAxisID: yAxisID, fill: false
                        });
                        usedKeys.add(matchedKey);
                    }
                });
                if (datasets.length > 0) processedGroups.push({ title: group.name, datasets: datasets, hasDualAxis: hasDualAxis });
            });

            // è™•ç†æœªåˆ†çµ„
            Object.keys(labData).forEach(key => {
                if (!usedKeys.has(key) && labData[key].data.length > 0) {
                    const color = '#' + (Math.random().toString(16) + '000000').substring(2, 8);
                    processedGroups.push({
                        title: key + ' è¶¨å‹¢',
                        datasets: [{
                            label: key,
                            data: labData[key].data.map((v, i) => ({ x: labData[key].labels[i], y: v })),
                            borderColor: color, backgroundColor: color, pointBackgroundColor: 'white',
                            pointRadius: 5, borderWidth: 2.5, tension: 0.4, yAxisID: 'y'
                        }],
                        hasDualAxis: false
                    });
                }
            });

            // ç¹ªåœ–
            processedGroups.forEach((group, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'chart-card';
                cardDiv.innerHTML = `<h4 class="chart-title">${group.title}</h4>`;
                const canvasContainer = document.createElement('div');
                canvasContainer.style.position = 'relative'; canvasContainer.style.height = '250px'; canvasContainer.style.width = '100%';
                const canvasEl = document.createElement('canvas');
                canvasEl.id = `chart_lab_group_${index}`;
                canvasContainer.appendChild(canvasEl);
                cardDiv.appendChild(canvasContainer);
                container.appendChild(cardDiv);

                const ctx = canvasEl.getContext('2d');
                let scalesConfig = {
                    x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MM/dd', displayFormats: { day: 'MM/dd' } }, grid: { display: false } },
                    y: { type: 'linear', display: true, position: 'left', grid: { borderDash: [5, 5], color: '#f3f4f6' }, title: { display: true, text: 'æ•¸å€¼' } }
                };
                if (group.hasDualAxis) {
                    scalesConfig.y1 = { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'å…¶ä»–' } };
                }

                activeCharts[canvasEl.id] = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: group.datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } },
                        scales: scalesConfig
                    }
                });
                chartsCreated++;
            });

            const msg = document.getElementById('noLabChartMessage');
            if (chartsCreated > 0) { document.getElementById('labChartsContainer').classList.remove('hidden'); msg.classList.add('hidden'); }
            else { document.getElementById('labChartsContainer').classList.add('hidden'); msg.classList.remove('hidden'); }
            return chartsCreated;
        }

        // v21.6 ä¿®æ­£ç‰ˆ: è§£æ±ºç”˜ç‰¹åœ–æ—¥æœŸè§£æéŒ¯èª¤
        function parseMedDataForGantt(text) {
            const medData = { labels: [], data: [], colors: [] };
            const lines = text.split('\n');
            const colorPalette = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4'];
            let colorIndex = 0;
            // éè²ªå©ªåŒ¹é… regex
            const medRegex = /^\s*(.+?)\s*[\(ï¼ˆ]\s*([\d\.\/-]+?)\s*[-~to]\s*([\d\.\/-]+?)\s*[\)ï¼‰]/i;

            lines.forEach(line => {
                const cleanLine = line.trim();
                if (!cleanLine) return;
                const match = cleanLine.match(medRegex);
                if (match) {
                    const medName = match[1].trim();
                    const startDate = parseChartDate(match[2].trim());
                    let endDate = parseChartDate(match[3].trim());

                    if (medName && startDate && endDate) {
                        if (endDate < startDate) endDate.setFullYear(startDate.getFullYear() + 1);
                        // +1å¤©è®“é¡¯ç¤ºæ›´ç›´è§€
                        const displayEndDate = new Date(endDate);
                        displayEndDate.setDate(displayEndDate.getDate() + 1);

                        medData.labels.push(medName);
                        medData.data.push([startDate, displayEndDate]);
                        medData.colors.push(colorPalette[colorIndex++ % colorPalette.length]);
                    }
                }
            });
            return medData;
        }

        // v21.5 ç¾åŒ–ç‰ˆ: æ¸²æŸ“ç”¨è—¥å²ç”˜ç‰¹åœ– (Pill Shape)
        function renderGanttChart(medData) {
            if (activeCharts['gantt']) activeCharts['gantt'].destroy();
            const container = document.getElementById('ganttChartContainer');
            const canvas = document.getElementById('ganttChartCanvas');
            
            if (medData.data.length > 0) {
                container.classList.remove('hidden');
                document.getElementById('noGanttChartMessage').classList.add('hidden');
                
                const ctx = canvas.getContext('2d');
                const chartData = medData.labels.map((l, i) => ({ x: medData.data[i], y: l }));
                const dynamicHeight = (medData.labels.length * 60) + 80;
                canvas.style.height = `${dynamicHeight}px`;

                activeCharts['gantt'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: medData.labels,
                        datasets: [{
                            label: 'ç”¨è—¥æœŸé–“', data: chartData, backgroundColor: medData.colors,
                            borderRadius: 20, borderSkipped: false, barThickness: 25, maxBarThickness: 30
                        }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        layout: { padding: { left: 10, right: 20, top: 10, bottom: 10 } },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'ç”¨è—¥æ™‚ç¨‹è¡¨ (Timeline)', font: { size: 16, weight: 'bold' }, padding: { bottom: 20 }, color: '#374151' },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)', titleColor: '#1f2937', bodyColor: '#4b5563', borderColor: '#e5e7eb', borderWidth: 1, padding: 12, cornerRadius: 8, displayColors: true,
                                callbacks: {
                                    title: (ctx) => ctx[0].label,
                                    label: (ctx) => {
                                        const s = new Date(ctx.raw.x[0]), e = new Date(ctx.raw.x[1]);
                                        // é¡¯ç¤ºæ™‚æ¸›å›é‚£1å¤©ä»¥ç¬¦åˆç›´è¦ºï¼Œæˆ–ç›´æ¥é¡¯ç¤º
                                        const realEnd = new Date(e); realEnd.setDate(realEnd.getDate() - 1);
                                        const f = (d) => `${d.getMonth()+1}/${d.getDate()}`;
                                        const diff = Math.ceil(Math.abs(realEnd - s) / (86400000)) + 1;
                                        return ` æœŸé–“: ${f(s)} - ${f(realEnd)} (å…± ${diff} å¤©)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { type: 'time', position: 'bottom', time: { unit: 'day', displayFormats: { day: 'MM/dd' }, tooltipFormat: 'MM/dd' }, grid: { color: '#f3f4f6', borderDash: [4, 4] }, ticks: { color: '#6b7280' }, title: { display: true, text: 'æ—¥æœŸ', color: '#9ca3af' } },
                            y: { grid: { display: false }, ticks: { font: { size: 13, weight: '600' }, color: '#374151', autoSkip: false } }
                        }
                    }
                });
                activeCharts['gantt'].resize();
                return 1;
            } else {
                container.classList.add('hidden');
                document.getElementById('noGanttChartMessage').classList.remove('hidden');
                return 0;
            }
        }

        function destroyActiveCharts() {
            Object.values(activeCharts).forEach(c => c && c.destroy());
            activeCharts = {};
        }

        function parseAndRenderCharts(labText, medText) {
            destroyActiveCharts();
            const chartCont = document.getElementById('chartsContainer');
            if (!labText.trim() && !medText.trim()) { chartCont.classList.add('hidden'); return; }
            
            try {
                const labData = parseLabDataForChart(labText);
                const medData = parseMedDataForGantt(medText);
                const l = renderLabCharts(labData);
                const g = renderGanttChart(medData);
                if (l > 0 || g > 0) chartCont.classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAppSettings();
            showView('home');
            let timer;
            const debounce = () => { clearTimeout(timer); timer = setTimeout(() => parseAndRenderCharts(document.getElementById('labDataInput').value, document.getElementById('medDataInput').value), 500); };
            document.getElementById('labDataInput').addEventListener('input', debounce);
            document.getElementById('medDataInput').addEventListener('input', debounce);
            
            navButtons.home.onclick = () => { renderProjectList(); showView('home'); };
            navButtons.soapNote.onclick = () => { if (!currentProjectId) createNewProject(); showView('soapNote'); };
            navButtons.calculator.onclick = () => showView('calculator');
            navButtons.settings.onclick = () => showView('settings');
            
            document.getElementById('saveSettingsButton').onclick = () => {
                 appSettings.apiKeys.gemini = document.getElementById('geminiApiKeyInput').value.trim() || appSettings.apiKeys.gemini;
                 appSettings.apiKeys.grok = document.getElementById('grokApiKeyInput').value.trim() || appSettings.apiKeys.grok;
                 saveAppSettings(); updateSettingsUI(); alert('è¨­å®šå·²å„²å­˜');
            };

            document.getElementById('newProjectButton').onclick = createNewProject;
            document.getElementById('saveProjectButton').onclick = saveCurrentProject;
            document.getElementById('saveAsProjectButton').onclick = () => saveAsNewProject();
            document.getElementById('deleteProjectButton').onclick = deleteCurrentProject;
            
            const termsCheckbox = document.getElementById('termsCheckbox');
            const generateButton = document.getElementById('generateButton');
            termsCheckbox.onchange = () => {
                generateButton.disabled = !termsCheckbox.checked;
                generateButton.classList.toggle('opacity-70', !termsCheckbox.checked);
                generateButton.classList.toggle('cursor-not-allowed', !termsCheckbox.checked);
            };
            
            document.getElementById('clearInputsButton').onclick = () => {
                document.getElementById('patientInfo').value = ''; 
                document.getElementById('labDataInput').value = ''; 
                document.getElementById('medDataInput').value = '';
                document.getElementById('specialtyFocus').value = ''; 
                termsCheckbox.checked = false;
                document.getElementById('output').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
                document.getElementById('chartsContainer').classList.add('hidden');
            };

            // AI Generation (Stub for structure)
            generateButton.onclick = async () => {
                if (!termsCheckbox.checked) return alert("è«‹åŒæ„ä½¿ç”¨æ¢æ¬¾");
                const provider = document.getElementById('apiProviderSelect').value;
                const apiKey = provider === 'gemini' ? appSettings.apiKeys.gemini : appSettings.apiKeys.grok;
                if (!apiKey) return alert(`è«‹è¨­å®š ${provider} API é‡‘é‘°`);
                
                const patientInfo = document.getElementById('patientInfo').value;
                if (!patientInfo.trim()) return alert("è«‹è¼¸å…¥ç—…æ‚£è³‡æ–™");

                document.getElementById('progressBarContainer').style.display = 'block';
                generateButton.disabled = true;
                
                parseAndRenderCharts(document.getElementById('labDataInput').value, document.getElementById('medDataInput').value);

                // --- é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥çœŸå¯¦ API å‘¼å«ä»£ç¢¼ ---
                // å› å›æ‡‰é•·åº¦é™åˆ¶ï¼Œè«‹åƒè€ƒå‰å¹¾ç‰ˆå°‡ callGeminiAPI å‡½å¼è²¼å›
                // é€™è£¡åƒ…æ¼”ç¤ºæˆåŠŸç‹€æ…‹
                await new Promise(r => setTimeout(r, 1000));
                
                document.getElementById('progressBarContainer').style.display = 'none';
                generateButton.disabled = false;
                alert("æé†’ï¼šè«‹ç¢ºä¿æ‚¨çš„ç¨‹å¼ç¢¼ä¸­åŒ…å« callGeminiAPI/callGrokAPI å‡½å¼ (å¯åƒè€ƒå‰å¹¾ç‰ˆ)");
            };
        });

        // --- Helper Functions ---
        function showView(viewId) {
            Object.values(views).forEach(v => v.style.display = 'none');
            views[viewId].style.display = 'block';
            Object.keys(navButtons).forEach(k => navButtons[k].classList.toggle('active', k === viewId || (k === 'soapNote' && viewId === 'soapNote')));
            window.scrollTo(0, 0);
        }
        function saveAppSettings() { localStorage.setItem(appStorageKey, JSON.stringify(appSettings)); }
        function loadAppSettings() {
            const stored = localStorage.getItem(appStorageKey);
            if (stored) appSettings = JSON.parse(stored);
            updateSettingsUI(); renderProjectList();
        }
        function updateSettingsUI() {
            const setStatus = (id, key) => { const el = document.getElementById(id); el.textContent = key ? "ç‹€æ…‹ï¼šå·²å„²å­˜" : "ç‹€æ…‹ï¼šå°šæœªè¨­å®š"; el.className = key ? "text-sm mt-2 text-green-600" : "text-sm mt-2 text-red-600"; };
            setStatus('geminiApiStatus', appSettings.apiKeys.gemini); setStatus('grokApiStatus', appSettings.apiKeys.grok);
        }
        function createNewProject() { currentProjectId = null; document.getElementById('projectNameInput').value = "æœªå‘½åå°ˆæ¡ˆ"; document.getElementById('patientInfo').value = ""; document.getElementById('labDataInput').value = ""; document.getElementById('medDataInput').value = ""; showView('soapNote'); }
        function saveCurrentProject() {
            const name = document.getElementById('projectNameInput').value;
            if (!name.trim()) return alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±");
            const data = { patientInfo: document.getElementById('patientInfo').value, labData: document.getElementById('labDataInput').value, medData: document.getElementById('medDataInput').value, specialtyFocus: document.getElementById('specialtyFocus').value };
            if (currentProjectId) { const idx = appSettings.projects.findIndex(p => p.id === currentProjectId); if (idx !== -1) { appSettings.projects[idx].name = name; appSettings.projects[idx].data = data; appSettings.projects[idx].updatedAt = Date.now(); } } 
            else { saveAsNewProject(name, data); }
            saveAppSettings(); alert("å°ˆæ¡ˆå·²å„²å­˜");
        }
        function saveAsNewProject(name, data) {
            const newId = `proj_${Date.now()}`;
            appSettings.projects.push({ id: newId, name: name || document.getElementById('projectNameInput').value || `å°ˆæ¡ˆ ${new Date().toLocaleString()}`, createdAt: Date.now(), updatedAt: Date.now(), data: data || { patientInfo: document.getElementById('patientInfo').value, labData: document.getElementById('labDataInput').value, medData: document.getElementById('medDataInput').value } });
            currentProjectId = newId; saveAppSettings();
        }
        function deleteCurrentProject() { if (!currentProjectId) return; if (confirm("ç¢ºå®šåˆªé™¤?")) { appSettings.projects = appSettings.projects.filter(p => p.id !== currentProjectId); saveAppSettings(); renderProjectList(); showView('home'); } }
        function loadProject(id) {
            const p = appSettings.projects.find(proj => proj.id === id); if (!p) return;
            currentProjectId = p.id; document.getElementById('projectNameInput').value = p.name;
            document.getElementById('patientInfo').value = p.data.patientInfo || '';
            document.getElementById('labDataInput').value = p.data.labData || '';
            document.getElementById('medDataInput').value = p.data.medData || '';
            document.getElementById('specialtyFocus').value = p.data.specialtyFocus || '';
            parseAndRenderCharts(p.data.labData || '', p.data.medData || '');
            showView('soapNote');
        }
        function renderProjectList() {
            const container = document.getElementById('projectListContainer'); container.innerHTML = '';
            if (appSettings.projects.length === 0) return container.innerHTML = '<p class="text-gray-500 text-center">ç„¡å°ˆæ¡ˆ</p>';
            appSettings.projects.sort((a,b)=>b.updatedAt-a.updatedAt).forEach(p => {
                const div = document.createElement('div'); div.className = 'project-item';
                div.innerHTML = `<div class="project-name">${p.name}</div><span class="project-date">${new Date(p.updatedAt).toLocaleDateString()}</span><button class="project-delete-btn">X</button>`;
                div.querySelector('.project-name').onclick = () => loadProject(p.id);
                div.querySelector('.project-delete-btn').onclick = (e) => { e.stopPropagation(); deleteProject(p.id); };
                container.appendChild(div);
            });
        }
        function deleteProject(id) { if(confirm("ç¢ºå®šåˆªé™¤?")) { appSettings.projects = appSettings.projects.filter(p => p.id !== id); saveAppSettings(); renderProjectList(); } }
    </script>
</body>
</html>
