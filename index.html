<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v21.3 - Visual Upgrade)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .spinner { border-top-color: transparent; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* è¦–åœ–åˆ‡æ› */
        .view { display: none; }
        
        /* å°è¦½åˆ— */
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
            color: #4b5563;
            cursor: pointer;
        }
        .nav-button:hover { background-color: #f3f4f6; }
        .nav-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* å°ˆæ¡ˆåˆ—è¡¨ */
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: white;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .project-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
        }
        .project-name {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
            flex-grow: 1;
        }
        .project-date { font-size: 0.875rem; color: #6b7280; margin-right: 1rem; }
        .project-delete-btn {
            background-color: #fee2e2; color: #dc2626; border-radius: 9999px; width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center; font-weight: bold; transition: background-color 0.2s, color 0.2s;
        }
        .project-delete-btn:hover { background-color: #dc2626; color: white; }
        
        /* README æ¨£å¼ */
        .prose-readme { font-size: 0.95rem; line-height: 1.6; }
        .prose-readme h1 { font-size: 1.5rem; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 1.5rem; }
        .prose-readme h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; }
        .prose-readme ul, .prose-readme ol { list-style-position: inside; margin-left: 1.5rem; margin-top: 0.5rem; }
        .prose-readme code { background-color: #f3f4f6; color: #c026d3; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        .prose-readme a { color: #2563eb; text-decoration: underline; }
        .prose-readme pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; overflow-x: auto; }

        /* ä¸€èˆ¬å…§å®¹æ¨£å¼ */
        .prose pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; }
        details summary { cursor: pointer; font-weight: 600; color: #1f2937; background-color: #f9fafb; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; transition: background-color 0.2s; }
        details summary:hover { background-color: #f3f4f6; }
        details[open] summary { background-color: #f3f4f6; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .calculator-content { padding: 1rem; border: 1px solid #e5e7eb; border-top: 0; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: #ffffff; }
        #progressBarContainer { display: none; width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 0.75rem; background-color: #3b82f6; border-radius: 9999px; animation: indeterminate-progress 2s linear infinite; }
        @keyframes indeterminate-progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .terms-section { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .calc-button { background-color: #10b981; color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: background-color 0.2s; }
        .calc-button:hover { background-color: #059669; }
        .calc-result { font-weight: 700; color: #1d4ed8; font-size: 1.125rem; text-align: right; min-height: 28px; }
        .calc-result-nodata { font-weight: 500; color: #9ca3af; font-size: 0.9rem; text-align: right; min-height: 28px; }
        .calc-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .calc-input, .calc-select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); outline: none; }
        .calc-input:focus, .calc-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        
        /* === v21.3 åœ–è¡¨ç¾åŒ–å°ˆç”¨ CSS === */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .chart-grid {
                grid-template-columns: repeat(2, 1fr); /* é›»è…¦ç‰ˆé›™æ¬„ */
            }
        }
        .chart-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            border: 1px solid #f3f4f6;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            text-align: center;
            font-size: 1.125rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">æ™ºèƒ½è—¥å¸« SOAPå°å¹«æ‰‹ (v21.3)</h1>
            <p class="mt-2 text-lg text-gray-600">å°ˆæ¡ˆç®¡ç†ãƒ»AI é©…å‹•çš„æŒ‡å¼•æŸ¥æ ¸ãƒ»å‹•æ…‹è£½åœ–</p>
        </header>

        <nav class="bg-white p-2 rounded-lg shadow-md mb-6 flex flex-wrap items-center justify-center gap-2 md:gap-4">
            <button id="nav-home" class="nav-button active">ä¸»é  / å°ˆæ¡ˆ</button>
            <button id="nav-soap-note" class="nav-button">SOAP ç­†è¨˜</button>
            <button id="nav-calculator" class="nav-button">è‡¨åºŠè¨ˆç®—æ©Ÿ</button>
            <button id="nav-settings" class="nav-button">è¨­å®š</button>
        </nav>

        <main>
            <div id="view-home" class="view" style="display: block;">
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">å°ˆæ¡ˆç®¡ç†</h2>
                    <button id="newProjectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 transition-transform duration-200 hover:scale-105 flex items-center justify-center text-lg">
                        æ–°å¢ SOAP ç­†è¨˜å°ˆæ¡ˆ
                    </button>
                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-3">å·²å„²å­˜çš„å°ˆæ¡ˆ</h3>
                    <div id="projectListContainer" class="space-y-3">
                        <p id="noProjectsMessage" class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰å·²å„²å­˜çš„å°ˆæ¡ˆã€‚</p>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">ç‰ˆæœ¬æ›´æ–°èªªæ˜</h2>
                    <div id="readme-version-info-container" class="prose-readme">
                        <p class="text-gray-500">æ­£åœ¨è¼‰å…¥...</p>
                    </div>
                </section>
            </div>

            <div id="view-soap-note" class="view">
                <section class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div class="md:col-span-1">
                            <label for="projectNameInput" class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆåç¨±</label>
                            <input type="text" id="projectNameInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±...">
                        </div>
                        <div class="md:col-span-2 flex flex-wrap gap-2 justify-end items-center">
                            <button id="saveProjectButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">å„²å­˜</button>
                            <button id="saveAsProjectButton" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">å¦å­˜æ–°æª”</button>
                            <button id="deleteProjectButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">åˆªé™¤</button>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                     <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">AI çŸ¥è­˜åº«å³æ™‚ç‹€æ…‹</h2>
                     <button id="queryGuidelinesButton" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 flex items-center justify-center">
                         <div id="guidelineSpinner" class="spinner border-4 border-white rounded-full mr-3 hidden"></div>
                         å³æ™‚æŸ¥è©¢ä¸»è¦æŒ‡å¼•ç‰ˆæœ¬
                     </button>
                     <div id="guidelineListContainer" class="mt-4 hidden">
                         <ul id="guidelineList" class="text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200"></ul>
                     </div>
                </section>
                
                <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">1. è¼¸å…¥ç—…æ‚£è³‡æ–™</h2>
                            <button id="clearInputsButton" class="text-sm text-slate-500 hover:text-red-600 font-medium py-1 px-2 rounded-lg hover:bg-red-50">ä¸€éµæ¸…é™¤</button>
                        </div>
                        
                        <div class="mb-4">
                            <label for="specialtyFocus" class="block text-sm font-medium text-gray-600 mb-2">å°ˆç§‘ç„¦é» (é¸å¡«)</label>
                            <select id="specialtyFocus" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="" selected>ç„¡ç‰¹å®šç§‘åˆ¥ (ç¶œåˆè©•ä¼°)</option>
                                <option value="å¿ƒè‡Ÿå…§ç§‘">å¿ƒè‡Ÿå…§ç§‘ (Cardiology)</option>
                                <option value="èƒ¸è…”å…§ç§‘">èƒ¸è…”å…§ç§‘ (Pulmonology)</option>
                                <option value="è…è‡Ÿå…§ç§‘">è…è‡Ÿå…§ç§‘ (Nephrology)</option>
                                <option value="æ„ŸæŸ“ç§‘">æ„ŸæŸ“ç§‘ (Infectious Disease)</option>
                                <option value="æ–°é™³ä»£è¬ç§‘">æ–°é™³ä»£è¬ç§‘ (Metabolism)</option>
                                <option value="åŠ è­·ç—…æˆ¿">åŠ è­·ç—…æˆ¿ (ICU)</option>
                            </select>
                        </div>

                        <div class="terms-section">
                            <h3>ä½¿ç”¨æ¢æ¬¾ (å¿…è®€)</h3>
                            <ul>
                                <li>ä½¿ç”¨è€…æ‰¿è«¾ï¼Œæ‰€æœ‰è¼¸å…¥è³‡æ–™**å‡å·²å®Œæˆã€Œå»è­˜åˆ¥åŒ–ã€**ã€‚</li>
                                <li>è‹¥ä½¿ç”¨è€…é•åæ‰¿è«¾ï¼Œè¼¸å…¥ã€Œå¯è­˜åˆ¥ã€çš„å€‹äººè³‡æ–™ï¼Œ**æ‰€æœ‰ç›¸é—œæ³•å¾‹è²¬ä»»ç”±è©²ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ“”**ã€‚</li>
                            </ul>
                        </div>
                        <div class="flex items-center mb-4">
                            <input id="termsCheckbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="termsCheckbox" class="ml-2 block text-sm text-gray-900">æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°ã€Œä½¿ç”¨æ¢æ¬¾ã€ã€‚</label>
                        </div>

                        <div class="mb-4">
                            <label for="patientInfo" class="block text-sm font-medium text-gray-600 mb-2">ç—…æ‚£æ ¸å¿ƒè³‡æ–™ (AI åˆ†æç”¨)</label>
                            <textarea id="patientInfo" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è²¼å…¥ã€Œå»è­˜åˆ¥åŒ–ã€å¾Œçš„ç—…æ‚£è³‡è¨Š..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="labDataInput" class="block text-sm font-medium text-gray-600 mb-2">
                                Lab æ•¸æ“š (è£½åœ–ç”¨) <span class="text-xs text-blue-600 font-bold">* v21.3 æ–°åŠŸèƒ½: è‡ªå‹•åˆ†çµ„ç¹ªåœ–</span>
                            </label>
                            <textarea id="labDataInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š
AST: 40 (10/1)
ALT: 50 (10/1)
WBC: 15 (10/1)
CRP: 2.0 (10/1)"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="medDataInput" class="block text-sm font-medium text-gray-600 mb-2">ç”¨è—¥å² (ç”˜ç‰¹åœ–ç”¨)</label>
                            <textarea id="medDataInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šVanco 1g Q12H (10/1-10/5)"></textarea>
                        </div>
                        
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ UpToDate (é¸å¡«)</label><textarea id="uptodateInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ Micromedex (é¸å¡«)</label><textarea id="micromedexInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆ OpenEvidence (é¸å¡«)</label><textarea id="openevidenceInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        <div class="mb-4"><label class="block text-sm font-medium text-gray-600 mb-2">æ•´åˆå¥ä¿çµ¦ä»˜è¦ç¯„ (é¸å¡«)</label><textarea id="nhiGuidelinesInfo" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"></textarea></div>
                        
                        <div class="mb-4">
                            <label for="apiProviderSelect" class="block text-sm font-medium text-gray-600 mb-2">AI æ¨¡å‹é¸æ“‡</label>
                            <select id="apiProviderSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white">
                                <option value="gemini" selected>Google Gemini (gemini-2.5-flash-preview)</option>
                                <option value="grok">Grok (xAI)</option>
                            </select>
                        </div>
                        <div class="mt-auto pt-4">
                            <button id="generateButton" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 opacity-70 cursor-not-allowed" disabled>
                                ğŸš€ å•Ÿå‹• AI åˆ†æ & è£½åœ–
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">2. ç”¢ç”Ÿçš„ç­†è¨˜è‰ç¨¿</h2>
                             <button id="copyButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:opacity-50" disabled>ä¸€éµè¤‡è£½</button>
                        </div>
                        <div id="progressBarContainer"><div class="progress-bar"></div></div>
                        
                        <div id="autoCalcDisplay" class="hidden mb-4 bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">è‡ªå‹•è¨ˆç®—åƒè€ƒï¼š</h4><div id="autoCalcList" class="text-sm space-y-1"></div>
                        </div>
                        
                        <div id="chartsContainer" class="hidden mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            
                            <div id="labChartsContainer">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">Lab æ•¸æ“šè¶¨å‹¢åœ–</h3>
                                <div id="labChartsGoHere" class="chart-grid">
                                    </div>
                                <p id="noLabChartMessage" class="text-gray-500 text-center py-2 hidden">æœªåµæ¸¬åˆ°å¯ç¹ªè£½çš„ Lab æ•¸æ“šã€‚</p>
                            </div>
                            
                            <div id="ganttChartContainer" class="mt-6">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ç”¨è—¥å²ç”˜ç‰¹åœ–</h3>
                                <div id="ganttChartGoHere">
                                    <canvas id="ganttChartCanvas" style="max-height: 300px;"></canvas>
                                </div>
                                <p id="noGanttChartMessage" class="text-gray-500 text-center py-2 hidden">æœªåµæ¸¬åˆ°å¯ç¹ªè£½çš„ç”¨è—¥æ•¸æ“šã€‚</p>
                            </div>
                        </div>

                        <div id="placeholder" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-lg">
                            <p class="font-semibold">AI å°‡è‡ªå‹•åŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š</p>
                            <ul class="list-disc list-inside text-left mt-2 text-sm">
                                <li>è‡ªå‹•ç¹ªè£½ Lab è¶¨å‹¢åœ–èˆ‡ç”¨è—¥ç”˜ç‰¹åœ–ã€‚</li>
                                <li>åˆ†ææ™‚åºæ€§è®ŠåŒ– (SCr è¶¨å‹¢ç­‰)ã€‚</li>
                                <li>è‡ªå‹•è¨ˆç®— CrCl, eGFR, CHA2DS2-VAScã€‚</li>
                                <li>è‡ªå‹•æ ¸å°å¥ä¿çµ¦ä»˜è¦ç¯„ã€‚</li>
                            </ul>
                        </div>
                        <div id="output" class="hidden prose max-w-none prose-pre:whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 200px;"></div>
                        
                        <div id="infoBox" class="hidden mt-4 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm">AI è¼”åŠ©èªªæ˜ï¼š</h4>
                            <ul class="list-disc list-inside text-sm mt-1">
                                <li><strong>åœ–è¡¨å‡ç´šï¼š</strong> Lab åœ–è¡¨å·²æ¡ç”¨åˆ†çµ„é¡¯ç¤ºèˆ‡é›™è»¸è¨­è¨ˆã€‚</li>
                                <li><strong>è‡ªå‹•å›å¡«ï¼š</strong> å·²è§£æä¸¦è¨ˆç®—ç›¸é—œåˆ†æ•¸ã€‚</li>
                            </ul>
                        </div>
                        <div id="sourcesContainer" class="hidden mt-6">
                            <h3 id="sourcesTitle" class="text-lg font-semibold text-gray-600 mb-2">å¼•ç”¨çš„æŒ‡å¼•èˆ‡åƒè€ƒä¾†æºï¼š</h3>
                            <ul id="sourcesList" class="list-none list-inside text-sm space-y-1"></ul>
                        </div>
                    </div>
                </main>
            </div>

            <div id="view-calculator" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">è‡¨åºŠè¨ˆç®—æ©Ÿ (æ‰‹å‹•)</h2>
                    <p class="text-gray-600 mb-6">æ­¤é é¢åƒ…ä¾›æ‰‹å‹•è¨ˆç®—ï¼Œä¸å½±éŸ¿ SOAP ç­†è¨˜çš„è‡ªå‹•è¨ˆç®—ã€‚</p>
                    <div class="space-y-4">
                        <details>
                            <summary class="flex justify-between items-center"><span>1. CrCl (C-G) & IBW/ABW</span></summary>
                            <div class="calculator-content space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="calc-label">æ€§åˆ¥</label><select id="manual_calcSex" class="calc-select"><option value="Male">ç”·æ€§</option><option value="Female">å¥³æ€§</option></select></div>
                                    <div><label class="calc-label">å¹´é½¡</label><input type="number" id="manual_calcAge" class="calc-input"></div>
                                    <div><label class="calc-label">é«”é‡ (kg)</label><input type="number" id="manual_calcWeight" class="calc-input"></div>
                                    <div><label class="calc-label">èº«é«˜ (cm)</label><input type="number" id="manual_calcHeight" class="calc-input"></div>
                                    <div><label class="calc-label">SCr</label><input type="number" id="manual_calcScr" class="calc-input"></div>
                                </div>
                                <button id="manual_calculateCrClBwButton" class="calc-button mt-4">è¨ˆç®—</button>
                                <div class="text-right"><span id="manual_crclResult" class="calc-result block"></span><span id="manual_bwResult" class="calc-result block"></span></div>
                            </div>
                        </details>
                        <div class="text-gray-400 text-sm text-center">æ›´å¤šè¨ˆç®—åŠŸèƒ½è«‹åƒé–±ä¸»ç¨‹å¼ç¢¼</div>
                    </div>
                </section>
            </div>

            <div id="view-settings" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6 border-l-4 border-blue-500">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-700">API é‡‘é‘°è¨­å®š</h2>
                     <div class="space-y-6">
                         <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API é‡‘é‘°</label>
                             <input type="password" id="geminiApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="è²¼ä¸Šæ‚¨çš„ Gemini API é‡‘é‘°">
                             <p id="geminiApiStatus" class="text-sm mt-2 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚</p>
                         </div>
                         <div>
                             <label class="block text-sm font-medium text-gray-700 mb-2">Grok (xAI) API é‡‘é‘°</label>
                             <input type="password" id="grokApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="è²¼ä¸Šæ‚¨çš„ Grok API é‡‘é‘°">
                             <p id="grokApiStatus" class="text-sm mt-2 text-gray-500">ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚</p>
                         </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                         <button id="saveSettingsButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700">å„²å­˜è¨­å®š</button>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">ç™¼ç”ŸéŒ¯èª¤</h3>
                <div class="mt-2 px-7 py-3"><p id="errorMessage" class="text-sm text-gray-500"></p></div>
                <button id="closeModalButton" class="px-4 py-2 bg-red-500 text-white rounded-md w-full shadow-sm hover:bg-red-600">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <script>
        // === Global Variables & Settings ===
        let appSettings = { apiKeys: { gemini: "", grok: "" }, projects: [] };
        let currentProjectId = null; 
        let activeCharts = {}; 

        const geminiModelName = "gemini-2.5-flash-preview-09-2025";
        const geminiApiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
        const grokModelName = "grok-1";
        const grokApiUrlBase = "https://api.x.ai/v1/chat/completions";
        const appStorageKey = 'smartPharmacistSettings_v21.3';
        const githubReadmeUrl = "https://api.github.com/repos/Almightyhao/SOAP-writter/readme";

        // === DOM Elements ===
        const views = { home: document.getElementById('view-home'), soapNote: document.getElementById('view-soap-note'), calculator: document.getElementById('view-calculator'), settings: document.getElementById('view-settings') };
        const navButtons = { home: document.getElementById('nav-home'), soapNote: document.getElementById('nav-soap-note'), calculator: document.getElementById('nav-calculator'), settings: document.getElementById('nav-settings') };
        
        // Inputs
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const grokApiKeyInput = document.getElementById('grokApiKeyInput');
        const projectNameInput = document.getElementById('projectNameInput');
        const patientInfoInput = document.getElementById('patientInfo');
        const labDataInput = document.getElementById('labDataInput');
        const medDataInput = document.getElementById('medDataInput');
        const specialtyFocusSelect = document.getElementById('specialtyFocus');
        const apiProviderSelect = document.getElementById('apiProviderSelect');
        const termsCheckbox = document.getElementById('termsCheckbox');

        // Buttons
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const generateButton = document.getElementById('generateButton');
        const saveProjectButton = document.getElementById('saveProjectButton');
        const saveAsProjectButton = document.getElementById('saveAsProjectButton');
        const deleteProjectButton = document.getElementById('deleteProjectButton');
        const clearInputsButton = document.getElementById('clearInputsButton');
        
        // Outputs
        const outputDiv = document.getElementById('output');
        const chartContainer = document.getElementById('chartsContainer');
        const labChartsContainer = document.getElementById('labChartsContainer');
        const labChartsGoHere = document.getElementById('labChartsGoHere');
        const ganttChartContainer = document.getElementById('ganttChartContainer');
        const ganttChartCanvas = document.getElementById('ganttChartCanvas');

        // === Core Functions ===

        function showView(viewId) {
            Object.values(views).forEach(v => v.style.display = 'none');
            views[viewId].style.display = 'block';
            Object.keys(navButtons).forEach(k => {
                navButtons[k].classList.toggle('active', k === viewId || (k === 'soapNote' && viewId === 'soapNote'));
            });
            window.scrollTo(0, 0);
        }

        function saveAppSettings() {
            localStorage.setItem(appStorageKey, JSON.stringify(appSettings));
        }

        function loadAppSettings() {
            const stored = localStorage.getItem(appStorageKey);
            if (stored) appSettings = JSON.parse(stored);
            updateSettingsUI();
            renderProjectList();
        }

        function updateSettingsUI() {
            const setStatus = (id, key) => {
                const el = document.getElementById(id);
                el.textContent = key ? "ç‹€æ…‹ï¼šå·²å„²å­˜ã€‚" : "ç‹€æ…‹ï¼šå°šæœªè¨­å®šã€‚";
                el.className = key ? "text-sm mt-2 text-green-600" : "text-sm mt-2 text-red-600";
            };
            setStatus('geminiApiStatus', appSettings.apiKeys.gemini);
            setStatus('grokApiStatus', appSettings.apiKeys.grok);
        }

        // === Charting Logic (Updated v21.3) ===

        function parseChartDate(dateString) {
            const parts = dateString.split(/[\/-]/);
            let year, month, day;
            if (parts.length === 3) {
                year = parseInt(parts[0]);
                month = parseInt(parts[1]) - 1;
                day = parseInt(parts[2]);
                if (year < 200) year += 1911; 
            } else if (parts.length === 2) {
                year = new Date().getFullYear();
                month = parseInt(parts[0]) - 1;
                day = parseInt(parts[1]);
            } else return null;
            
            const date = new Date(year, month, day);
            const today = new Date();
            if (parts.length === 2 && date.getMonth() > today.getMonth() + 1) date.setFullYear(year - 1);
            return date;
        }

        function parseLabDataForChart(text) {
            const labData = {};
            const lines = text.split('\n');
            const pointRegex = /(\d+(?:\.\d+)?)\s*.*?\s*\(?([\d\.\/-]+)\)?/g;
            const ganttRegex = /^\s*.*?(\([\d\.\/-]+\s*-\s*[\d\.\/-]+\))/; 

            lines.forEach(line => {
                if (ganttRegex.test(line)) return; 
                const parts = line.split(/[:ï¼š]/);
                if (parts.length < 2) return;
                const labName = parts[0].trim();
                const dataString = parts[1];
                if (!labName) return;

                if (!labData[labName]) labData[labName] = { labels: [], data: [] };
                let pointMatch;
                while ((pointMatch = pointRegex.exec(dataString)) !== null) {
                    const value = parseFloat(pointMatch[1]);
                    const dateObj = parseChartDate(pointMatch[2]);
                    if (!isNaN(value) && dateObj) {
                        labData[labName].labels.push(dateObj);
                        labData[labName].data.push(value);
                    }
                }
            });
            return labData;
        }

        // v21.3 ç¾åŒ–ç‰ˆ: æ¸²æŸ“ Lab åœ–è¡¨ (å«åˆ†çµ„ã€é›™è»¸ã€ç¾åŒ–)
        function renderLabCharts(labData) {
            let chartsCreated = 0;
            labChartsGoHere.innerHTML = ''; 
            
            // å®šç¾©åˆ†çµ„èˆ‡é¡è‰²
            const labConfig = {
                groups: [
                    { name: 'è‚åŠŸèƒ½ (Liver)', keys: ['AST', 'GOT', 'ALT', 'GPT'], type: 'liver' },
                    { name: 'ç™¼ç‚æŒ‡æ¨™ (Infection)', keys: ['WBC', 'CRP', 'PCT'], type: 'infection' },
                    { name: 'è…åŠŸèƒ½ (Kidney)', keys: ['SCr', 'Cr', 'BUN'], type: 'kidney' },
                    { name: 'é›»è§£è³ª (Electrolytes)', keys: ['Na', 'K', 'Cl'], type: 'electrolytes' },
                    { name: 'è¡€ç³– (Glucose)', keys: ['Glucose', 'HbA1c'], type: 'glucose' },
                    { name: 'è¡€è‰²ç´  (Hemoglobin)', keys: ['Hb', 'Hgb', 'Hct'], type: 'blood' }
                ],
                settings: {
                    'AST': { color: '#EF4444' }, 'GOT': { color: '#EF4444' },
                    'ALT': { color: '#F59E0B' }, 'GPT': { color: '#F59E0B' },
                    'WBC': { color: '#3B82F6', yAxisID: 'y' }, 
                    'CRP': { color: '#8B5CF6', yAxisID: 'y1' },
                    'PCT': { color: '#EC4899', yAxisID: 'y1' },
                    'SCr': { color: '#10B981' }, 'Cr': { color: '#10B981' },
                    'BUN': { color: '#06B6D4' }, 'Na': { color: '#6366F1' },
                    'K':   { color: '#F43F5E' }
                },
                defaultColors: ['#64748B', '#94A3B8']
            };

            let usedKeys = new Set();
            let processedGroups = [];

            // è™•ç†é å®šç¾©ç¾¤çµ„
            labConfig.groups.forEach(group => {
                let datasets = [];
                let hasDualAxis = false;
                group.keys.forEach(key => {
                    const matchedKey = Object.keys(labData).find(k => k.toUpperCase().includes(key.toUpperCase()));
                    if (matchedKey && !usedKeys.has(matchedKey) && labData[matchedKey].data.length > 0) {
                        const setting = labConfig.settings[key] || {};
                        const color = setting.color || labConfig.defaultColors[0];
                        const yAxisID = setting.yAxisID || 'y';
                        if (yAxisID === 'y1') hasDualAxis = true;

                        datasets.push({
                            label: matchedKey,
                            data: labData[matchedKey].data.map((v, i) => ({ x: labData[matchedKey].labels[i], y: v })),
                            borderColor: color,
                            backgroundColor: color,
                            pointBackgroundColor: 'white',
                            pointBorderColor: color,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 2.5,
                            tension: 0.4,
                            yAxisID: yAxisID,
                            fill: false
                        });
                        usedKeys.add(matchedKey);
                    }
                });
                if (datasets.length > 0) processedGroups.push({ title: group.name, datasets: datasets, hasDualAxis: hasDualAxis });
            });

            // è™•ç†æœªåˆ†çµ„é …ç›®
            Object.keys(labData).forEach(key => {
                if (!usedKeys.has(key) && labData[key].data.length > 0) {
                    const color = '#' + (Math.random().toString(16) + '000000').substring(2, 8);
                    processedGroups.push({
                        title: key + ' è¶¨å‹¢',
                        datasets: [{
                            label: key,
                            data: labData[key].data.map((v, i) => ({ x: labData[key].labels[i], y: v })),
                            borderColor: color, backgroundColor: color, pointBackgroundColor: 'white',
                            pointRadius: 5, borderWidth: 2.5, tension: 0.4, yAxisID: 'y'
                        }],
                        hasDualAxis: false
                    });
                }
            });

            // ç¹ªè£½å¡ç‰‡
            processedGroups.forEach((group, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'chart-card';
                cardDiv.innerHTML = `<h4 class="chart-title">${group.title}</h4>`;
                const canvasContainer = document.createElement('div');
                canvasContainer.style.position = 'relative';
                canvasContainer.style.height = '250px';
                canvasContainer.style.width = '100%';
                const canvasEl = document.createElement('canvas');
                canvasEl.id = `chart_lab_group_${index}`;
                canvasContainer.appendChild(canvasEl);
                cardDiv.appendChild(canvasContainer);
                labChartsGoHere.appendChild(cardDiv);

                const ctx = canvasEl.getContext('2d');
                let scalesConfig = {
                    x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MM/dd', displayFormats: { day: 'MM/dd' } }, grid: { display: false } },
                    y: { type: 'linear', display: true, position: 'left', grid: { borderDash: [5, 5], color: '#f3f4f6' }, title: { display: true, text: 'æ•¸å€¼' } }
                };
                if (group.hasDualAxis) {
                    scalesConfig.y1 = { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'å…¶ä»–æŒ‡æ¨™' } };
                }

                activeCharts[canvasEl.id] = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: group.datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } },
                        scales: scalesConfig
                    }
                });
                chartsCreated++;
            });

            if (chartsCreated > 0) {
                labChartsContainer.classList.remove('hidden');
                document.getElementById('noLabChartMessage').classList.add('hidden');
            } else {
                labChartsContainer.classList.add('hidden');
                document.getElementById('noLabChartMessage').classList.remove('hidden');
            }
            return chartsCreated;
        }

        function parseMedDataForGantt(text) {
            const medData = { labels: [], data: [], colors: [] };
            const lines = text.split('\n');
            const medRegex = /^\s*(.+?)\s*\(?([\d\.\/-]+)\s*-\s*([\d\.\/-]+)\)?\s*$/i; 
            const colorPalette = ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899'];
            let colorIndex = 0;

            lines.forEach(line => {
                if (!line.trim() || !/\([\d\.\/-]+\s*-\s*[\d\.\/-]+\)/.test(line)) return;
                const match = line.match(medRegex);
                if (match) {
                    const medName = match[1].trim().replace(/[:ï¼š]$/, '');
                    const startDate = parseChartDate(match[2]);
                    let endDate = parseChartDate(match[3]);
                    if (medName && startDate && endDate) {
                        if (endDate < startDate) endDate.setFullYear(endDate.getFullYear() + 1);
                        endDate.setDate(endDate.getDate() + 1);
                        medData.labels.push(medName);
                        medData.data.push([startDate, endDate]);
                        medData.colors.push(colorPalette[colorIndex++ % colorPalette.length]);
                    }
                }
            });
            return medData;
        }

        function renderGanttChart(medData) {
            if (activeCharts['gantt']) activeCharts['gantt'].destroy();
            if (medData.data.length > 0) {
                ganttChartContainer.classList.remove('hidden');
                document.getElementById('noGanttChartMessage').classList.add('hidden');
                const ctx = ganttChartCanvas.getContext('2d');
                const chartData = medData.labels.map((l, i) => ({ x: medData.data[i], y: l }));
                
                activeCharts['gantt'] = new Chart(ctx, {
                    type: 'bar',
                    data: { datasets: [{ label: 'ç”¨è—¥æœŸé–“', data: chartData, backgroundColor: medData.colors, barPercentage: 0.6 }] },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, title: { display: true, text: 'ç”¨è—¥å²ç”˜ç‰¹åœ–', font: { size: 16 } } },
                        scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MM/dd' }, min: new Date(Math.min(...medData.data.map(d=>d[0]))) }, y: { type: 'category', ticks: { autoSkip: false } } }
                    }
                });
                ganttChartCanvas.style.height = `${(medData.labels.length * 30) + 60}px`;
                activeCharts['gantt'].resize();
                return 1;
            } else {
                ganttChartContainer.classList.add('hidden');
                document.getElementById('noGanttChartMessage').classList.remove('hidden');
                return 0;
            }
        }

        function destroyActiveCharts() {
            Object.values(activeCharts).forEach(c => c && c.destroy());
            activeCharts = {};
        }

        function parseAndRenderCharts(labText, medText) {
            destroyActiveCharts();
            if (!labText.trim() && !medText.trim()) {
                chartContainer.classList.add('hidden'); return;
            }
            try {
                const labData = parseLabDataForChart(labText);
                const medData = parseMedDataForGantt(medText);
                const l = renderLabCharts(labData);
                const g = renderGanttChart(medData);
                if (l > 0 || g > 0) chartContainer.classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        // === Event Listeners ===
        document.addEventListener('DOMContentLoaded', () => {
            loadAppSettings();
            showView('home');
            let timer;
            const debounce = () => { clearTimeout(timer); timer = setTimeout(() => parseAndRenderCharts(labDataInput.value, medDataInput.value), 500); };
            labDataInput.addEventListener('input', debounce);
            medDataInput.addEventListener('input', debounce);
            
            navButtons.home.addEventListener('click', () => { renderProjectList(); showView('home'); });
            navButtons.soapNote.addEventListener('click', () => { if (!currentProjectId) createNewProject(); showView('soapNote'); });
            navButtons.calculator.addEventListener('click', () => showView('calculator'));
            navButtons.settings.addEventListener('click', () => showView('settings'));
            
            saveSettingsButton.addEventListener('click', () => {
                 appSettings.apiKeys.gemini = geminiApiKeyInput.value.trim() || appSettings.apiKeys.gemini;
                 appSettings.apiKeys.grok = grokApiKeyInput.value.trim() || appSettings.apiKeys.grok;
                 saveAppSettings(); updateSettingsUI(); alert('è¨­å®šå·²å„²å­˜');
            });

            document.getElementById('newProjectButton').addEventListener('click', createNewProject);
            saveProjectButton.addEventListener('click', saveCurrentProject);
            saveAsProjectButton.addEventListener('click', () => saveAsNewProject());
            deleteProjectButton.addEventListener('click', deleteCurrentProject);
            
            termsCheckbox.addEventListener('change', () => {
                generateButton.disabled = !termsCheckbox.checked;
                generateButton.classList.toggle('opacity-70', !termsCheckbox.checked);
                generateButton.classList.toggle('cursor-not-allowed', !termsCheckbox.checked);
            });
            
            clearInputsButton.addEventListener('click', () => {
                patientInfoInput.value = ''; labDataInput.value = ''; medDataInput.value = '';
                specialtyFocusSelect.value = ''; termsCheckbox.checked = false;
                document.getElementById('output').classList.add('hidden');
                document.getElementById('placeholder').classList.remove('hidden');
                chartContainer.classList.add('hidden');
            });
        });

        // === Project Logic ===
        function createNewProject() {
            currentProjectId = null;
            projectNameInput.value = "æœªå‘½åå°ˆæ¡ˆ";
            patientInfoInput.value = ""; labDataInput.value = ""; medDataInput.value = "";
            showView('soapNote');
        }
        
        function saveCurrentProject() {
            if (!projectNameInput.value.trim()) return alert("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±");
            const data = { 
                patientInfo: patientInfoInput.value, 
                labData: labDataInput.value, 
                medData: medDataInput.value,
                specialtyFocus: specialtyFocusSelect.value 
            };
            if (currentProjectId) {
                const idx = appSettings.projects.findIndex(p => p.id === currentProjectId);
                if (idx !== -1) { appSettings.projects[idx].name = projectNameInput.value; appSettings.projects[idx].data = data; appSettings.projects[idx].updatedAt = Date.now(); }
            } else {
                saveAsNewProject(projectNameInput.value, data);
            }
            saveAppSettings(); alert("å°ˆæ¡ˆå·²å„²å­˜");
        }

        function saveAsNewProject(name, data) {
            const newId = `proj_${Date.now()}`;
            appSettings.projects.push({
                id: newId, name: name || projectNameInput.value || `å°ˆæ¡ˆ ${new Date().toLocaleString()}`,
                createdAt: Date.now(), updatedAt: Date.now(),
                data: data || { patientInfo: patientInfoInput.value, labData: labDataInput.value, medData: medDataInput.value }
            });
            currentProjectId = newId; saveAppSettings();
        }

        function deleteCurrentProject() {
            if (!currentProjectId) return;
            if (confirm("ç¢ºå®šåˆªé™¤?")) {
                appSettings.projects = appSettings.projects.filter(p => p.id !== currentProjectId);
                saveAppSettings(); renderProjectList(); showView('home');
            }
        }

        function loadProject(id) {
            const p = appSettings.projects.find(proj => proj.id === id);
            if (!p) return;
            currentProjectId = p.id;
            projectNameInput.value = p.name;
            patientInfoInput.value = p.data.patientInfo || '';
            labDataInput.value = p.data.labData || '';
            medDataInput.value = p.data.medData || '';
            specialtyFocusSelect.value = p.data.specialtyFocus || '';
            parseAndRenderCharts(labDataInput.value, medDataInput.value);
            showView('soapNote');
        }

        function renderProjectList() {
            const container = document.getElementById('projectListContainer');
            container.innerHTML = '';
            if (appSettings.projects.length === 0) return container.innerHTML = '<p class="text-gray-500 text-center">ç„¡å°ˆæ¡ˆ</p>';
            appSettings.projects.sort((a,b)=>b.updatedAt-a.updatedAt).forEach(p => {
                const div = document.createElement('div');
                div.className = 'project-item';
                div.innerHTML = `<div class="project-name">${p.name}</div><span class="project-date">${new Date(p.updatedAt).toLocaleDateString()}</span><button class="project-delete-btn">X</button>`;
                div.querySelector('.project-name').onclick = () => loadProject(p.id);
                div.querySelector('.project-delete-btn').onclick = (e) => { e.stopPropagation(); deleteProject(p.id); };
                container.appendChild(div);
            });
        }
        
        function deleteProject(id) {
            if(confirm("ç¢ºå®šåˆªé™¤?")) {
                appSettings.projects = appSettings.projects.filter(p => p.id !== id);
                saveAppSettings(); renderProjectList();
            }
        }

    </script>
</body>
</html>
