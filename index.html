<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="S__18006027.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="shortcut icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能藥師 SOAP小幫手 (v21.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .spinner { border-top-color: transparent; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* v18.0: 視圖切換 */
        .view { display: none; }
        
        /* v18.0: 導覽列 */
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
            color: #4b5563; /* text-gray-600 */
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }
        .nav-button.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* v18.1: 專案列表樣式 */
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem;
            background-color: white;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .project-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6; /* border-blue-500 */
        }
        .project-name {
            font-weight: 600;
            color: #1f2937; /* text-gray-800 */
            cursor: pointer;
            flex-grow: 1;
        }
        .project-date {
            font-size: 0.875rem;
            color: #6b7280; /* text-gray-500 */
            margin-right: 1rem;
        }
        .project-delete-btn {
            background-color: #fee2e2; /* bg-red-100 */
            color: #dc2626; /* text-red-600 */
            border-radius: 9999px;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }
        .project-delete-btn:hover {
            background-color: #dc2626; /* hover:bg-red-600 */
            color: white;
        }
        
        /* v18.1: README 內容樣式 */
        .prose-readme {
             font-size: 0.95rem; line-height: 1.6;
        }
        .prose-readme h1 { font-size: 1.5rem; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 1.5rem; }
        .prose-readme h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; }
        .prose-readme ul, .prose-readme ol { list-style-position: inside; margin-left: 1.5rem; margin-top: 0.5rem; }
        .prose-readme code { background-color: #f3f4f6; color: #c026d3; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        .prose-readme a { color: #2563eb; text-decoration: underline; }
        .prose-readme pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; overflow-x: auto; }

        /* --- v17.4 既有樣式 (保留) --- */
        .prose pre { background-color: #f9fafb; color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; white-space: pre-wrap; font-family: inherit; font-size: 0.95rem; }
        #guidelineList li { padding: 4px 0; border-bottom: 1px solid #f3f4f6; }
        #guidelineList li:last-child { border-bottom: none; }
        details summary { cursor: pointer; font-weight: 600; color: #1f2937; background-color: #f9fafb; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; transition: background-color 0.2s; }
        details summary:hover { background-color: #f3f4f6; }
        details[open] summary { background-color: #f3f4f6; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .calculator-content { padding: 1rem; border: 1px solid #e5e7eb; border-top: 0; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; background-color: #ffffff; }
        .instruction-step { margin-top: 1rem; }
        .instruction-step h4 { font-weight: 600; color: #1f2937; }
        .instruction-step p { font-size: 0.95rem; color: #374151; }
        .instruction-step code { background-color: #f3f4f6; color: #c026d3; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; }
        #progressBarContainer { display: none; width: 100%; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar { width: 100%; height: 0.75rem; background-color: #3b82f6; border-radius: 9999px; animation: indeterminate-progress 2s linear infinite; }
        @keyframes indeterminate-progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .terms-section { background-color: #fffbeb; border: 1px solid #fcd34d; color: #92400e; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .terms-section h3 { font-weight: 700; color: #b45309; display: flex; align-items: center; }
        .terms-section ul { list-style-type: decimal; margin-left: 1.5rem; font-size: 0.9rem; margin-top: 0.5rem; line-height: 1.6; }
        .calc-button { background-color: #10b981; color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: background-color 0.2s; }
        .calc-button:hover { background-color: #059669; }
        .calc-result { font-weight: 700; color: #1d4ed8; font-size: 1.125rem; text-align: right; min-height: 28px; }
        .calc-result-nodata { font-weight: 500; color: #9ca3af; font-size: 0.9rem; text-align: right; min-height: 28px; }
        .calc-label { display: block; font-size: 0.875rem; font-medium; color: #374151; margin-bottom: 0.5rem; }
        .calc-input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); outline: none; }
        .calc-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        .calc-select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); background-color: white; outline: none; }
        .calc-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        .calc-radio-group { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .calc-radio-label { display: flex; align-items: center; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; }
        .calc-radio-label input { margin-right: 0.5rem; color: #3b82f6; }
        .calc-radio-label:has(input:checked) { background-color: #eff6ff; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">智能藥師 SOAP小幫手 (v21.1)</h1>
            <p class="mt-2 text-lg text-gray-600">專案管理・AI 驅動的指引查核・動態製圖</p>
        </header>

        <nav class="bg-white p-2 rounded-lg shadow-md mb-6 flex flex-wrap items-center justify-center gap-2 md:gap-4">
            <button id="nav-home" class="nav-button active">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                主頁 / 專案
            </button>
            <button id="nav-soap-note" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                SOAP 筆記
            </button>
            <button id="nav-calculator" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M16 4h-2a2 2 0 1 0-4 0H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2M8 2v4M16 2v4M12 10h4M12 14h4M12 18h4M8 10h.01M8 14h.01M8 18h.01"></path></svg>
                臨床計算機
            </button>
            <button id="nav-settings" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                設定
            </button>
        </nav>

        <main>
            <div id="view-home" class="view" style="display: block;">
                
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">專案管理</h2>
                    <button id="newProjectButton" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 flex items-center justify-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        新增 SOAP 筆記專案
                    </button>
                    
                    <h3 class="text-xl font-semibold text-gray-600 mt-6 mb-3">已儲存的專案</h3>
                    <div id="projectListContainer" class="space-y-3">
                        <p id="noProjectsMessage" class="text-gray-500 text-center py-4">目前沒有已儲存的專案。</p>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">版本更新說明 (來自 GitHub)</h2>
                    <div id="readme-version-info-container" class="prose-readme">
                        <p class="text-gray-500">正在從 GitHub 載入 README.md...</p>
                        </div>
                    
                    <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700 border-b pb-2">開始使用</h2>
                    <div class="prose max-w-none prose-lg">
                        <ol class="list-decimal list-inside space-y-2">
                            <li>
                                請先前往 <button id="nav-settings-shortcut" class="text-blue-600 font-medium hover:underline inline-block p-0 border-0 bg-transparent cursor-pointer">「設定」</button> 頁面，輸入並儲存您的 API 金鑰。
                            </li>
                            <li>
                                然後前往 <button id="nav-soap-note-shortcut" class="text-blue-600 font-medium hover:underline inline-block p-0 border-0 bg-transparent cursor-pointer">「SOAP 筆記」</button> 頁面，開始您的工作。
                            </li>
                        </ol>
                    </div>
                </section>
            </div>
            <div id="view-soap-note" class="view">
                
                <section class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div class="md:col-span-1">
                            <label for="projectNameInput" class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                            <input type="text" id="projectNameInput" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入專案名稱...">
                        </div>
                        <div class="md:col-span-2 flex flex-wrap gap-2 justify-end items-center">
                            <button id="saveProjectButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 flex-grow md:flex-grow-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 w-5 h-5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                儲存
                            </button>
                            <button id="saveAsProjectButton" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 flex-grow md:flex-grow-0">
                                另存新檔
                            </button>
                            <button id="deleteProjectButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-all duration-200 flex-grow md:flex-grow-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 w-5 h-5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                刪除
                            </button>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-xl shadow-xl mb-6">
                     <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>
                         AI 知識庫即時狀態
                     </h2>
                     <button id="queryGuidelinesButton" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 flex items-center justify-center">
                         <div id="guidelineSpinner" class="spinner border-4 border-white rounded-full mr-3 hidden"></div>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                         即時查詢主要指引版本
                     </button>
                     <div id="guidelineListContainer" class="mt-4 hidden">
                         <h3 class="text-lg font-semibold text-gray-800 mb-2">即時查詢結果：</h3>
                         <ul id="guidelineList" class="text-gray-700 bg-gray-50 p-4 rounded-lg border border-gray-200"></ul>
                     </div>
                </section>
                
                <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                                1. 輸入病患資料
                            </h2>
                            <button id="clearInputsButton" class="text-sm text-slate-500 hover:text-red-600 font-medium py-1 px-2 rounded-lg hover:bg-red-50 transition-all duration-200 hover:scale-105 hover:shadow-md flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                一鍵清除
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <label for="specialtyFocus" class="block text-sm font-medium text-gray-600 mb-2">專科焦點 (選填)</label>
                            <select id="specialtyFocus" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="" selected>無特定科別 (綜合評估)</option>
                                <option value="心臟內科">心臟內科 (Cardiology)</option>
                                <option value="胸腔內科">胸腔內科 (Pulmonology)</option>
                                <option value="腎臟內科">腎臟內科 (Nephrology)</option>
                                <option value="感染科">感染科 (Infectious Disease)</option>
                                <option value="新陳代謝科">新陳代謝科 (Metabolism)</option>
                                <option value="風濕免疫科">風濕免疫科 (Rheumatology)</option>
                                <option value="血液腫瘤科">血液腫瘤科 (Hemato-Oncology)</option>
                                <option value="腸胃肝膽科">腸胃肝膽科 (Gastroenterology)</option>
                                <option value="神經內科">神經內科 (Neurology)</option>
                                <option value="加護病房">加護病房 (ICU)</option>
                            </select>
                        </div>

                        <div class="terms-section">
                            <h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-yellow-600"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>使用條款 (必讀)</h3>
                            <ul>
                                <li>使用者承諾，所有輸入資料**均已完成「去識別化」**。</li>
                                <li>若使用者違反承諾，輸入「可識別」的個人資料，**所有相關法律責任由該使用者自行承擔**。</li>
                                <li>**請再次確認資料不含任何可識別個人的資訊後，再按下「啟動 AI 分析」按鈕。**</li>
                            </ul>
                        </div>
                        <div class="flex items-center mb-4">
                            <input id="termsCheckbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="termsCheckbox" class="ml-2 block text-sm text-gray-900">我已閱讀並同意上述「使用條款」。</label>
                        </div>
                        <div class="mb-4">
                            <label for="patientInfo" class="block text-sm font-medium text-gray-600 mb-2">病患核心資料 (AI 分析用)<span class="text-xs text-gray-500">(例如：Age: 70, Sex: M, SCr: 1.2 (10/1) -> 1.5 (10/2)...)</span></label>
                            <textarea id="patientInfo" rows="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請貼入「去識別化」後的病患資訊..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="labDataInput" class="block text-sm font-medium text-gray-600 mb-2">
                                Lab 數據 (製圖用)
                                <span class="text-xs text-gray-500">(例如：SCr: 1.2(10/1), 1.5(10/2))</span>
                            </label>
                            <textarea id="labDataInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="一行一個 Lab (SCr, WBC, Glucose...)"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="medDataInput" class="block text-sm font-medium text-gray-600 mb-2">
                                用藥史 (甘特圖用)
                                <span class="text-xs text-gray-500">(例如：Vanco 1g Q12H (10/1-10/5))</span>
                            </label>
                            <textarea id="medDataInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="一行一個藥物 (Vanco, Mero...)..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="uptodateInfo" class="block text-sm font-medium text-gray-600 mb-2">整合 UpToDate (選填)</label>
                            <textarea id="uptodateInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="貼上 UpToDate 的重點..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="micromedexInfo" class="block text-sm font-medium text-gray-600 mb-2">整合 Micromedex (選填)</label>
                            <textarea id="micromedexInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="貼上 Micromedex 的重點..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="openevidenceInfo" class="block text-sm font-medium text-gray-600 mb-2">整合 OpenEvidence (選填)</label>
                            <textarea id="openevidenceInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="貼上 OpenEvidence 的重點..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="nhiGuidelinesInfo" class="block text-sm font-medium text-gray-600 mb-2">整合健保給付規範 (選填)</label>
                            <textarea id="nhiGuidelinesInfo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="貼上相關藥品的健保給付規範..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="apiProviderSelect" class="block text-sm font-medium text-gray-600 mb-2">AI 模型選擇</label>
                            <select id="apiProviderSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="gemini" selected>Google Gemini (gemini-2.5-flash-preview)</option>
                                <option value="grok">Grok (xAI)</option>
                            </select>
                        </div>
                        <div class="mt-auto pt-4">
                            <button id="generateButton" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 ease-in-out hover:scale-105 flex items-center justify-center opacity-70 cursor-not-allowed" disabled>
                                🚀 啟動 AI 分析 & 製圖
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>2. 產生的筆記草稿</h2>
                             <button id="copyButton" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>一鍵複製</button>
                        </div>
                        <div id="progressBarContainer"><div class="progress-bar"></div></div>
                        
                        <div id="autoCalcDisplay" class="hidden mb-4 bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm mb-2">自動計算參考 (僅供藥師查核，未傳送给 AI)：</h4>
                            <div id="autoCalcList" class="text-sm space-y-1"></div>
                        </div>
                        
                        <div id="chartsContainer" class="hidden mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <div id="labChartsContainer">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">Lab 數據趨勢圖</h3>
                                <div id="labChartsGoHere">
                                    </div>
                                <p id="noLabChartMessage" class="text-gray-500 text-center py-2 hidden">未在「Lab 數據 (製圖用)」欄位中偵測到可繪製的數據。</p>
                            </div>
                            
                            <div id="ganttChartContainer" class="mt-6">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">用藥史甘特圖</h3>
                                <div id="ganttChartGoHere">
                                    <canvas id="ganttChartCanvas" style="max-height: 300px;"></canvas>
                                </div>
                                <p id="noGanttChartMessage" class="text-gray-500 text-center py-2 hidden">未在「用藥史 (甘特圖用)」欄位中偵測到可繪製的數據。</p>
                            </div>
                        </div>


                        <div id="placeholder" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-300 rounded-lg transition-opacity duration-300">
                            <p class="font-semibold">AI 將自動執行以下任務：</p>
                            <ul class="list-disc list-inside text-left mt-2 text-sm">
                                <li>(v21.0) **自動繪製**「Lab 數據」和「用藥史」欄位中的圖表。</li>
                                <li>(v18.2) 分析「病患核心資料」中的時序性資料 (例如 SCr 趨勢)。</li>
                                <li>(v18.0) 自動解析「病患核心資料」並在「自動計算參考區」顯示結果。</li>
                                <li>(v16.2) **自動核對您提供的「健保給付規範」**，評估核刪風險。</li>
                            </ul>
                            <p class="text-sm mt-4">所有內容均需由專業藥師最終審核。</p>
                        </div>
                        <div id="output" class="hidden prose max-w-none prose-pre:whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 200px;"></div>
                        
                        <div id="infoBox" class="hidden mt-4 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg">
                            <h4 class="font-bold text-sm">AI 輔助說明 (v21.0)：</h4>
                            <ul class="list-disc list-inside text-sm mt-1">
                                <li><strong>自動製圖 (新)：</strong> 系統已自動解析**獨立的製圖欄位**並繪製 Lab 圖與甘特圖。</li>
                                <li><strong>時序分析：</strong> AI 已被指示**必須**分析「病患核心資料」中的 Lab data 動態趨勢。</li>
                                <li><strong>自動回填：</strong> 系統已自動解析「病患核心資料」並在「自動計算參考區」顯示結果。</li>
                                <li><strong>健保核對：</strong> AI 已被指示**必須**核對您提供的健保規範。</li>
                            </ul>
                        </div>
                        <div id="sourcesContainer" class="hidden mt-6">
                            <h3 id="sourcesTitle" class="text-lg font-semibold text-gray-600 mb-2">引用的指引與參考來源：</h3>
                            <ul id="sourcesList" class="list-none list-inside text-sm space-y-1"></ul>
                        </div>
                    </div>
                </main>
            </div>
            <div id="view-calculator" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">臨床計算機 (手動)</h2>
                    <p class="text-gray-600 mb-6">此頁面僅供您手動計算。SOAP 筆記頁面會自動解析病患資料並在背景計算，不受此處數值影響。</p>
                    <div class="space-y-4">
                        <details>
                            <summary class="flex justify-between items-center"><span>1. CrCl (C-G) & IBW/ABW 計算</span><span class="text-sm font-normal text-blue-600">點擊展開</span></summary>
                            <div class="calculator-content space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label for="manual_calcSex" class="calc-label">性別</label><select id="manual_calcSex" class="calc-select"><option value="Male">男性</option><option value="Female">女性</option></select></div>
                                    <div><label for="manual_calcAge" class="calc-label">年齡 (years)</label><input type="number" id="manual_calcAge" class="calc-input" placeholder="例如: 70"></div>
                                    <div><label for="manual_calcWeight" class="calc-label">體重 (kg)</label><input type="number" id="manual_calcWeight" class="calc-input" placeholder="例如: 65"></div>
                                    <div><label for="manual_calcHeight" class="calc-label">身高 (cm)</label><input type="number" id="manual_calcHeight" class="calc-input" placeholder="例如: 170"></div>
                                    <div><label for="manual_calcScr" class="calc-label">血清肌酸酐 (SCr, mg/dL)</label><input type="number" id="manual_calcScr" class="calc-input" placeholder="例如: 1.2"></div>
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateCrClBwButton" class="calc-button">計算 CrCl & IBW/ABW</button>
                                    <div class="text-right"><span id="manual_crclResult" class="calc-result block"></span><span id="manual_bwResult" class="calc-result block"></span></div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>2. CHA₂DS₂-VASc 風險計算</span><span class="text-sm font-normal text-blue-600">點擊展開</span></summary>
                            <div class="calculator-content space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <fieldset><legend class="calc-label">年齡 (Age)</legend><div class="space-y-2">
                                        <div class="flex items-center"><input id="manual_c2vAge<65" name="manual_c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="0" checked><label for="manual_c2vAge<65" class="ml-2 block text-sm text-gray-900">&lt; 65 歲 (0 分)</label></div>
                                        <div class="flex items-center"><input id="manual_c2vAge65-74" name="manual_c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="1"><label for="manual_c2vAge65-74" class="ml-2 block text-sm text-gray-900">65-74 歲 (+1 分)</label></div>
                                        <div class="flex items-center"><input id="manual_c2vAge>=75" name="manual_c2vAge" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="2"><label for="manual_c2vAge>=75" class="ml-2 block text-sm text-gray-900">≥ 75 歲 (+2 分)</label></div>
                                    </div></fieldset>
                                    <fieldset><legend class="calc-label">性別 (Sex)</legend><div class="space-y-2">
                                        <div class="flex items-center"><input id="manual_c2vSexMale" name="manual_c2vSex" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="0" checked><label for="manual_c2vSexMale" class="ml-2 block text-sm text-gray-900">男性 (0 分)</label></div>
                                        <div class="flex items-center"><input id="manual_c2vSexFemale" name="manual_c2vSex" type="radio" class="h-4 w-4 text-blue-600 border-gray-300" value="1"><label for="manual_c2vSexFemale" class="ml-2 block text-sm text-gray-900">女性 (+1 分)</label></div>
                                    </div></fieldset>
                                </div>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                                    <div class="flex items-center"><input id="manual_c2vChf" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vChf" class="ml-2 block text-sm text-gray-900">心臟衰竭 (CHF) (+1)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vHt" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vHt" class="ml-2 block text-sm text-gray-900">高血壓 (Hypertension) (+1)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vDm" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vDm" class="ml-2 block text-sm text-gray-900">糖尿病 (Diabetes) (+1)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vStroke" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vStroke" class="ml-2 block text-sm text-gray-900">中風/TIA/TE (+2)</label></div>
                                    <div class="flex items-center"><input id="manual_c2vVd" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded"><label for="manual_c2vVd" class="ml-2 block text-sm text-gray-900">血管疾病 (Vascular) (+1)</label></div>
                                </div>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateCha2ds2vascButton" class="calc-button">計算分數</button>
                                    <span id="manual_cha2ds2vascResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>3. BSA (Mosteller) 計算</span><span class="text-sm font-normal text-blue-600">點擊展開</span></summary>
                            <div class="calculator-content space-y-4">
                                <p class="text-sm text-gray-500">請在 (1) 中輸入身高與體重。</p>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateBsaButton" class="calc-button">計算 BSA</button>
                                    <span id="manual_calcBsaResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>4. eGFR (CKD-EPI 2021) 計算</span><span class="text-sm font-normal text-blue-600">點擊展開</span></summary>
                            <div class="calculator-content space-y-4">
                                <p class="text-sm text-gray-500">請在 (1) 中輸入性別、年齡、SCr。</p>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateCkdEpiButton" class="calc-button">計算 eGFR (CKD-EPI)</button>
                                    <span id="manual_calcCkdEpiResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary class="flex justify-between items-center"><span>5. Child-Pugh Score (肝功能) 計算</span><span class="text-sm font-normal text-blue-600">點擊展開</span></summary>
                            <div class="calculator-content space-y-4">
                                <fieldset><legend class="calc-label">腹水 (Ascites)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpAscites" value="1" checked> 無 (1 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAscites" value="2"> 輕微 (2 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAscites" value="3"> 中/重度 (3 分)</label></div></fieldset>
                                <fieldset><legend class="calc-label">肝腦病變 (Encephalopathy)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpEnceph" value="1" checked> 無 (1 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpEnceph" value="2"> 第 1-2 級 (2 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpEnceph" value="3"> 第 3-4 級 (3 分)</label></div></fieldset>
                                <fieldset><legend class="calc-label">黃疸指數 (Bilirubin, mg/dL)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpBili" value="1" checked> &lt; 2 (1 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpBili" value="2"> 2 - 3 (2 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpBili" value="3"> &gt; 3 (3 分)</label></div></fieldset>
                                <fieldset><legend class="calc-label">白蛋白 (Albumin, g/dL)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpAlb" value="1" checked> &gt; 3.5 (1 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAlb" value="2"> 2.8 - 3.5 (2 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpAlb" value="3"> &lt; 2.8 (3 分)</label></div></fieldset>
                                <fieldset><legend class="calc-label">凝血時間 (INR)</legend><div class="calc-radio-group"><label class="calc-radio-label"><input type="radio" name="manual_cpInr" value="1" checked> &lt; 1.7 (1 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpInr" value="2"> 1.7 - 2.3 (2 分)</label><label class="calc-radio-label"><input type="radio" name="manual_cpInr" value="3"> &gt; 2.3 (3 分)</label></div></fieldset>
                                <div class="flex justify-between items-center mt-4">
                                    <button id="manual_calculateChildPughButton" class="calc-button">計算 Child-Pugh Score</button>
                                    <span id="manual_calcChildPughResult" class="calc-result"></span>
                                </div>
                            </div>
                        </details>
                    </div>
                </section>
            </div>

            <div id="view-settings" class="view">
                <section class="bg-white p-6 rounded-xl shadow-xl mb-6 border-l-4 border-blue-500">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>API 金鑰設定</h2>
                     <p class="text-gray-600 mb-6">金鑰將安全地儲存在您本機瀏覽器的 `localStorage` 中，不會上傳至任何伺服器。</p>
                     <div class="space-y-6">
                         <div>
                             <label for="geminiApiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API 金鑰</label>
                             <input type="password" id="geminiApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="貼上您的 Google Gemini API 金鑰 (AIzaSy...)">
                             <p id="geminiApiStatus" class="text-sm mt-2 text-gray-500">狀態：尚未設定。</p>
                             <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline">如何取得 Gemini 金鑰？</a>
                         </div>
                         <div>
                             <label for="grokApiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Grok (xAI) API 金鑰</label>
                             <input type="password" id="grokApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="貼上您的 Grok API 金鑰 (gk_...)">
                             <p id="grokApiStatus" class="text-sm mt-2 text-gray-500">狀態：尚未設定。</p>
                             <a href="https://x.ai/docs/api/get-started" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline">如何取得 Grok 金鑰？</a>
                         </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                         <button id="saveSettingsButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-105">儲存設定</button>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white"><div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">發生錯誤</h3>
            <div class="mt-2 px-7 py-3"><p id="errorMessage" class="text-sm text-gray-500">無法產生筆記，請稍後再試。</p></div>
            <div class="items-center px-4 py-3"><button id="closeModalButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">關閉</button></div>
        </div></div>
    </div>
    
    <footer class="text-center py-6 mt-8 border-t border-gray-200">
        <p class="text-sm text-gray-500">
            本工具原始碼與更新版可於 
            <a href="https://github.com/Almightyhao/Google-SOAP-writter" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                https://github.com/Almightyhao/Google-SOAP-writter
            </a>
             查找 (v21.0)
        </p>
    </footer>

    <div id="hidden-calc-storage" style="display: none;">
        <input id="calcSex"> <input id="calcAge"> <input id="calcWeight">
        <input id="calcHeight"> <input id="calcScr">
        <span id="crclResult"></span> <span id="bwResult"></span>
        <input id="c2vAge<65"> <input id="c2vAge65-74"> <input id_c2vAge>=75">
        <input id="c2vSexFemale"> <input id="c2vChf"> <input id="c2vHt">
        <input id="c2vDm"> <input id="c2vStroke"> <input id="c2vVd">
        <span id="cha2ds2vascResult"></span> <span id="calcBsaResult"></span>
        <span id="calcCkdEpiResult"></span> <span id="calcChildPughResult"></span>
        <input name="cpAscites" value="1"> <input name="cpEnceph" value="1">
        <input name="cpBili" value="1"> <input name="cpAlb" value="1">
        <input name="cpInr" value="1">
    </div>
 <script>
        // === v21.2: 全域變數與設定 ===
        let appSettings = {
            apiKeys: {
                gemini: "",
                grok: ""
            },
            projects: [] 
        };
        let currentProjectId = null; 
        let activeCharts = {}; // v21.0: 改為物件，方便管理 Lab 和 Gantt

        // v17.2: 模型名稱
        const geminiModelName = "gemini-2.5-flash-preview-09-2025";
        const geminiApiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
        
        // v18.0: Grok 模型名稱
        const grokModelName = "grok-1"; // 範例
        const grokApiUrlBase = "https://api.x.ai/v1/chat/completions"; // 範例

        const appStorageKey = 'smartPharmacistSettings_v21.2'; // v21.2: 更新金鑰
        // v18.1: GitHub README 設定
        const githubReadmeUrl = "https://api.github.com/repos/Almightyhao/SOAP-writter/readme";

        // === v18.1: 視圖 (View) DOM 元素 ===
        const views = {
            home: document.getElementById('view-home'),
            soapNote: document.getElementById('view-soap-note'),
            calculator: document.getElementById('view-calculator'),
            settings: document.getElementById('view-settings'),
        };
        
        // === v18.1: 導覽列 (Nav) DOM 元素 ===
        const navButtons = {
            home: document.getElementById('nav-home'),
            soapNote: document.getElementById('nav-soap-note'),
            calculator: document.getElementById('nav-calculator'),
            settings: document.getElementById('nav-settings'),
        };
        const navSettingsShortcut = document.getElementById('nav-settings-shortcut');
        const navSoapNoteShortcut = document.getElementById('nav-soap-note-shortcut');

        // === v18.1: 主頁 (Home) DOM 元素 ===
        const newProjectButton = document.getElementById('newProjectButton');
        const projectListContainer = document.getElementById('projectListContainer');
        const noProjectsMessage = document.getElementById('noProjectsMessage');
        const readmeContainer = document.getElementById('readme-version-info-container');

        // === v18.1: 設定 (Settings) DOM 元素 ===
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const grokApiKeyInput = document.getElementById('grokApiKeyInput');
        const geminiApiStatus = document.getElementById('geminiApiStatus');
        const grokApiStatus = document.getElementById('grokApiStatus');
        const saveSettingsButton = document.getElementById('saveSettingsButton');

        // === v18.1 & v21.0: SOAP 筆記 (Dashboard) DOM 元素 ===
        const projectNameInput = document.getElementById('projectNameInput');
        const saveProjectButton = document.getElementById('saveProjectButton');
        const saveAsProjectButton = document.getElementById('saveAsProjectButton');
        const deleteProjectButton = document.getElementById('deleteProjectButton');

        const generateButton = document.getElementById('generateButton');
        const patientInfoInput = document.getElementById('patientInfo');
        const specialtyFocusSelect = document.getElementById('specialtyFocus');
        const uptodateInfoInput = document.getElementById('uptodateInfo');
        const micromedexInfoInput = document.getElementById('micromedexInfo');
        const openevidenceInfoInput = document.getElementById('openevidenceInfo');
        const termsCheckbox = document.getElementById('termsCheckbox');
        const nhiGuidelinesInfoInput = document.getElementById('nhiGuidelinesInfo');
        const apiProviderSelect = document.getElementById('apiProviderSelect');
        const labDataInput = document.getElementById('labDataInput'); // v21.0
        const medDataInput = document.getElementById('medDataInput'); // v21.0

        const outputDiv = document.getElementById('output');
        const placeholderDiv = document.getElementById('placeholder');
        const infoBox = document.getElementById('infoBox');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');
        const sourcesTitle = document.getElementById('sourcesTitle');
        const clearInputsButton = document.getElementById('clearInputsButton');
        const copyButton = document.getElementById('copyButton');
        const progressBarContainer = document.getElementById('progressBarContainer');

        const queryGuidelinesButton = document.getElementById('queryGuidelinesButton');
        const guidelineSpinner = document.getElementById('guidelineSpinner');
        const guidelineListContainer = document.getElementById('guidelineListContainer');
        const guidelineList = document.getElementById('guidelineList');
        
        const autoCalcDisplay = document.getElementById('autoCalcDisplay');
        const autoCalcList = document.getElementById('autoCalcList');
        
        // === v20.0: 圖表 DOM 元素 ===
        const chartsContainer = document.getElementById('chartsContainer');
        const labChartsContainer = document.getElementById('labChartsContainer');
        const labChartsGoHere = document.getElementById('labChartsGoHere');
        const noLabChartMessage = document.getElementById('noLabChartMessage');
        const ganttChartContainer = document.getElementById('ganttChartContainer');
        const ganttChartGoHere = document.getElementById('ganttChartGoHere');
        const ganttChartCanvas = document.getElementById('ganttChartCanvas');
        const noGanttChartMessage = document.getElementById('noGanttChartMessage');

        // === v18.0: 錯誤處理 (Error Modal) DOM 元素 ===
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // === v18.0: 臨床計算機 (Calculator) DOM 元素 ===
        const manual_calcSex = document.getElementById('manual_calcSex');
        const manual_calcAge = document.getElementById('manual_calcAge');
        const manual_calcWeight = document.getElementById('manual_calcWeight');
        const manual_calcHeight = document.getElementById('manual_calcHeight');
        const manual_calcScr = document.getElementById('manual_calcScr');
        const manual_calculateCrClBwButton = document.getElementById('manual_calculateCrClBwButton');
        const manual_crclResult = document.getElementById('manual_crclResult');
        const manual_bwResult = document.getElementById('manual_bwResult');
        
        const manual_c2vAgeLess65 = document.getElementById('manual_c2vAge<65');
        const manual_c2vAge65_74 = document.getElementById('manual_c2vAge65-74');
        const manual_c2vAgeGreater75 = document.getElementById('manual_c2vAge>=75');
        const manual_c2vSexFemale = document.getElementById('manual_c2vSexFemale');
        const manual_c2vChf = document.getElementById('manual_c2vChf');
        const manual_c2vHt = document.getElementById('manual_c2vHt');
        const manual_c2vDm = document.getElementById('manual_c2vDm');
        const manual_c2vStroke = document.getElementById('manual_c2vStroke');
        const manual_c2vVd = document.getElementById('manual_c2vVd');
        const manual_calculateCha2ds2vascButton = document.getElementById('manual_calculateCha2ds2vascButton');
        const manual_cha2ds2vascResult = document.getElementById('manual_cha2ds2vascResult');
        
        const manual_calculateBsaButton = document.getElementById('manual_calculateBsaButton');
        const manual_calcBsaResult = document.getElementById('manual_calcBsaResult');
        const manual_calculateCkdEpiButton = document.getElementById('manual_calculateCkdEpiButton');
        const manual_calcCkdEpiResult = document.getElementById('manual_calcCkdEpiResult');
        const manual_calculateChildPughButton = document.getElementById('manual_calculateChildPughButton');
        const manual_calcChildPughResult = document.getElementById('manual_calcChildPughResult');

        // === v18.0: 核心 - 視圖切換 (Routing) ===
        function showView(viewId) {
            Object.values(views).forEach(view => view.style.display = 'none');
            if (views[viewId]) {
                views[viewId].style.display = 'block';
            } else {
                views.home.style.display = 'block'; // 預設
            }
            Object.keys(navButtons).forEach(key => {
                // v18.1: 更新 ID 映射
                const buttonId = (key === 'soapNote') ? 'nav-soap-note' : `nav-${key}`;
                if (navButtons[key]) {
                    if (key === viewId) {
                        navButtons[key].classList.add('active');
                    } else {
                        navButtons[key].classList.remove('active');
                    }
                }
            });
            window.scrollTo(0, 0); // 切換視圖時滾動到頂部
        }
        
        // === v18.1: 核心 - 資料庫 (LocalStorage) ===
        function saveAppSettings() {
            try {
                localStorage.setItem(appStorageKey, JSON.stringify(appSettings));
            } catch (e) {
                console.error("儲存 AppSettings 時發生錯誤:", e);
                showError("無法儲存設定 (瀏覽器可能不支援 localStorage)。");
            }
        }
        
        function loadAppSettings() {
            try {
                const storedSettings = localStorage.getItem(appStorageKey);
                if (storedSettings) {
                    appSettings = JSON.parse(storedSettings);
                    if (!appSettings.apiKeys) appSettings.apiKeys = { gemini: "", grok: "" }; // 保持相容
                    if (!appSettings.projects) appSettings.projects = [];
                }
            } catch (e) {
                console.error("載入 AppSettings 時發生錯誤:", e);
                // 如果解析失敗，重設為預設值
                appSettings = { apiKeys: { gemini: "", grok: "" }, projects: [] };
            }
        }
        
        // === v18.1: 核心 - 設定 (Settings) 頁面邏輯 ===
        function saveApiKeysToStorage() {
            const newGeminiKey = geminiApiKeyInput.value.trim();
            const newGrokKey = grokApiKeyInput.value.trim();
            
            if (newGeminiKey) appSettings.apiKeys.gemini = newGeminiKey;
            if (newGrokKey) appSettings.apiKeys.grok = newGrokKey;
            
            saveAppSettings(); // 儲存整個 appSettings
            
            if (!newGeminiKey && !newGrokKey) {
                alert("未輸入新金鑰。");
            } else {
                alert("設定已儲存！");
            }
            // 重新整理 UI 狀態
            updateSettingsUI();
        }

        function updateSettingsUI() {
            // 載入 Gemini 狀態
            if (appSettings.apiKeys.gemini) {
                geminiApiStatus.textContent = "狀態：已從瀏覽器載入金鑰。";
                geminiApiStatus.className = "text-sm mt-2 text-green-600";
                geminiApiKeyInput.value = "";
                geminiApiKeyInput.placeholder = "金鑰已儲存";
            } else {
                geminiApiStatus.textContent = "狀態：尚未設定金鑰。";
                geminiApiStatus.className = "text-sm mt-2 text-red-600";
                geminiApiKeyInput.placeholder = "貼上您的 Google Gemini API 金鑰 (AIzaSy...)";
            }
            // 載入 Grok 狀態
            if (appSettings.apiKeys.grok) {
                grokApiStatus.textContent = "狀態：已從瀏覽器載入金鑰。";
                grokApiStatus.className = "text-sm mt-2 text-green-600";
                grokApiKeyInput.value = "";
                grokApiKeyInput.placeholder = "金鑰已儲存";
            } else {
                grokApiStatus.textContent = "狀態：尚未設定金鑰。";
                grokApiStatus.className = "text-sm mt-2 text-red-600";
                grokApiKeyInput.placeholder = "貼上您的 Grok API 金鑰 (gk_...)";
            }
        }

        // === v18.1: 核心 - 專案管理 (Project Management) ===
        
        // 渲染專案列表到主頁
        function renderProjectList() {
            projectListContainer.innerHTML = ''; // 清空
            
            if (appSettings.projects.length === 0) {
                noProjectsMessage.style.display = 'block';
                return;
            }
            
            noProjectsMessage.style.display = 'none';
            
            // 排序：最新的在最前面
            const sortedProjects = [...appSettings.projects].sort((a, b) => b.updatedAt - a.updatedAt);
            
            sortedProjects.forEach(project => {
                const projectEl = document.createElement('div');
                projectEl.className = 'project-item';
                
                const lastUpdated = new Date(project.updatedAt).toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                projectEl.innerHTML = `
                    <div class="project-name" data-id="${project.id}">${project.name}</div>
                    <span class="project-date">${lastUpdated}</span>
                    <button class="project-delete-btn" data-id="${project.id}" title="刪除專案">X</button>
                `;
                
                // 綁定事件：點擊名稱 = 載入
                projectEl.querySelector('.project-name').addEventListener('click', () => {
                    loadProject(project.id);
                });
                
                // 綁定事件：點擊 X = 刪除
                projectEl.querySelector('.project-delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // 避免觸發載入
                    deleteProject(project.id);
                });
                
                projectListContainer.appendChild(projectEl);
            });
        }
        
        // 從主頁點擊 "新增"
        function createNewProject() {
            currentProjectId = null; // 標記為新專案
            clearSoapInputs(); // 清空所有欄位
            projectNameInput.value = "未命名專案";
            showView('soapNote');
            projectNameInput.focus();
        }
        
        // *** v21.0: 載入邏輯 (已更新) ***
        function loadProject(projectId) {
            const project = appSettings.projects.find(p => p.id === projectId);
            if (!project) {
                showError("找不到該專案。");
                return;
            }
            
            currentProjectId = project.id;
            
            // --- Load Inputs ---
            projectNameInput.value = project.name;
            patientInfoInput.value = project.data.patientInfo || '';
            labDataInput.value = project.data.labData || ''; // v21.0: 新增
            medDataInput.value = project.data.medData || ''; // v21.0: 新增
            specialtyFocusSelect.value = project.data.specialtyFocus || '';
            uptodateInfoInput.value = project.data.uptodateInfo || '';
            micromedexInfoInput.value = project.data.micromedexInfo || '';
            openevidenceInfoInput.value = project.data.openevidenceInfo || '';
            nhiGuidelinesInfoInput.value = project.data.nhiGuidelinesInfo || '';

            // --- Load Outputs (v18.3) ---
            const soapNoteHtml = project.data.soapNoteOutput || '';
            const sourcesHtml = project.data.sourcesOutput || '';
            const autoCalcHtml = project.data.autoCalcOutput || '';

            if (soapNoteHtml) {
                outputDiv.innerHTML = soapNoteHtml;
                outputDiv.classList.remove('hidden');
                placeholderDiv.classList.add('hidden');
                infoBox.classList.remove('hidden'); 
                copyButton.disabled = false;
            } else {
                clearSoapOutputs(); // 會自動清空圖表
            }

            if (sourcesHtml) {
                sourcesList.innerHTML = sourcesHtml;
                sourcesTitle.textContent = '引用的指引與參考來源 (已儲存)：'; 
                sourcesContainer.classList.remove('hidden');
            } else {
                sourcesContainer.classList.add('hidden');
                sourcesList.innerHTML = '';
            }

            if (autoCalcHtml) {
                autoCalcList.innerHTML = autoCalcHtml;
                autoCalcDisplay.classList.remove('hidden');
            } else {
                autoCalcDisplay.classList.add('hidden');
                autoCalcList.innerHTML = '';
            }
            
            // v21.0: 載入專案時，自動從「製圖欄位」重新繪製圖表
            parseAndRenderCharts(labDataInput.value, medDataInput.value);

            termsCheckbox.checked = false; // 載入後仍需重新同意
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');

            showView('soapNote');
        }
        
        // *** v21.0: 儲存邏輯 (已更新) ***
        function getProjectDataFromUI() {
            return {
                // --- Inputs ---
                patientInfo: patientInfoInput.value,
                labData: labDataInput.value, // v21.0: 新增
                medData: medDataInput.value, // v21.0: 新增
                specialtyFocus: specialtyFocusSelect.value,
                uptodateInfo: uptodateInfoInput.value,
                micromedexInfo: micromedexInfoInput.value,
                openevidenceInfo: openevidenceInfoInput.value,
                nhiGuidelinesInfo: nhiGuidelinesInfoInput.value,
                
                // --- Outputs (v18.3) ---
                soapNoteOutput: outputDiv.innerHTML,
                sourcesOutput: sourcesList.innerHTML,
                autoCalcOutput: autoCalcList.innerHTML
                // v19.0: 我們不儲存圖表本身，只儲存 chartingData，載入時重繪
            };
        }

        // 在 SOAP 頁面按下 "儲存"
        function saveCurrentProject() {
            const projectName = projectNameInput.value.trim();
            if (!projectName) {
                showError("專案名稱不可為空。");
                return;
            }
            
            const projectData = getProjectDataFromUI();
            
            if (currentProjectId) {
                // 更新現有專案
                const index = appSettings.projects.findIndex(p => p.id === currentProjectId);
                if (index !== -1) {
                    appSettings.projects[index].name = projectName;
                    appSettings.projects[index].data = projectData;
                    appSettings.projects[index].updatedAt = Date.now();
                    
                    saveAppSettings();
                    alert(`專案 "${projectName}" 已更新。`);
                }
            } else {
                // 儲存為新專案
                saveAsNewProject(projectName, projectData);
            }
        }
        
        // 在 SOAP 頁面按下 "另存新檔"
        function saveAsNewProject(name = null, data = null) {
            let projectName = name || projectNameInput.value.trim();
            if (!projectName || projectName === "未命名專案") {
                projectName = `專案 ${new Date().toLocaleString('zh-TW')}`;
            }
            
            const projectData = data || getProjectDataFromUI();
            const newId = `project_${Date.now()}`;
            
            const newProject = {
                id: newId,
                name: projectName,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                data: projectData
            };
            
            appSettings.projects.push(newProject);
            saveAppSettings();
            
            currentProjectId = newId; // 更新目前 ID
            projectNameInput.value = projectName; // 更新輸入框
            
            if (!name) { // 只有當使用者主動點擊 "另存新檔" 時才跳通知
                alert(`已另存新檔為 "${projectName}"。`);
            }
        }
        
        // 在 SOAP 頁面按下 "刪除"
        function deleteCurrentProject() {
             if (!currentProjectId) {
                showError("這是一個尚未儲存的新專案，無法刪除。");
                return;
            }
            
            if (confirm(`您確定要刪除專案 "${projectNameInput.value}" 嗎？此操作無法復原。`)) {
                appSettings.projects = appSettings.projects.filter(p => p.id !== currentProjectId);
                saveAppSettings();
                
                alert("專案已刪除。");
                
                // 返回主頁並刷新列表
                renderProjectList();
                showView('home');
            }
        }
        
        // 在 主頁 列表按下 "X"
        function deleteProject(projectId) {
            const project = appSettings.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm(`您確定要刪除專案 "${project.name}" 嗎？此操作無法復原。`)) {
                appSettings.projects = appSettings.projects.filter(p => p.id !== projectId);
                saveAppSettings();
                renderProjectList(); // 重新渲染列表
            }
        }
        
        // === v18.2.1: 主頁 - README 抓取 (修正 UTF-8 亂碼) ===
        async function fetchReadme() {
            try {
                const response = await fetch(githubReadmeUrl, {
                    headers: { 'Accept': 'application/vnd.github.v3.json' }
                });
                if (!response.ok) throw new Error(`GitHub API 錯誤: ${response.status}`);
                
                const data = await response.json();
                
                // *** 亂碼修正開始 ***
                const binaryString = atob(data.content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decoder = new TextDecoder('utf-8');
                const readmeContent = decoder.decode(bytes);
                // *** 亂碼修正結束 ***

                readmeContainer.innerHTML = marked.parse(readmeContent);
                
            } catch (error) {
                console.error("抓取 README 失敗:", error);
                readmeContainer.innerHTML = `<p class="text-red-600">無法載入版本說明：${error.message}</p>`;
            }
        }

        // === 錯誤處理 (v21.1 修正) ===
        function showError(message) {
            let activeKey = "";
            let provider = "Gemini";
            try {
                if (apiProviderSelect) {
                    provider = apiProviderSelect.value;
                }
            } catch(e) {/* ignore if element not visible */}
            
            // v21.1 修正: 統一使用 activeKey 變數
            if (provider === 'gemini') {
                activeKey = appSettings.apiKeys.gemini;
            } else if (provider === 'grok') {
                activeKey = appSettings.apiKeys.grok;
            }

            if (activeKey === "" && (message.includes("API") || message.includes("金鑰"))) {
                errorMessage.textContent = `API 金鑰尚未設定或無效。請前往「設定」頁面輸入並儲存 ${provider} 金鑰。`;
            } else {
                errorMessage.textContent = message || "發生未知的錯誤。";
            }
            errorModal.classList.remove('hidden');
        }
        closeModalButton.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });
        
        // === v18.0: 純計算邏輯 (Pure Functions) ===
        function setCalcResult(element, text, isNoData = false) {
            element.textContent = text;
            if (isNoData) {
                element.className = 'calc-result-nodata block';
            } else if (text) {
                element.className = 'calc-result block';
            }
        }

        function getCrClBwString(age, weight, height, scr, sex) {
            let crclVal = "CrCl (C-G): 無資料";
            let bwVal = "IBW/ABW: 無資料";

            try {
                const n_age = parseFloat(age);
                const n_weight = parseFloat(weight);
                const n_height = parseFloat(height);
                const n_scr = parseFloat(scr);

                if (!isNaN(n_height) && !isNaN(n_weight) && n_height > 0 && n_weight > 0) {
                    let ibw = (sex === 'Male') ? (50 + 2.3 * (n_height * 0.393701 - 60)) : (45.5 + 2.3 * (n_height * 0.393701 - 60));
                    if (ibw < 0) ibw = (sex === 'Male') ? 50 : 45.5;
                    const upperLimit = ibw * 1.2;
                    let assessment = (n_weight > upperLimit) ? "位於ABW範圍內 (TBW/IBW > 1.2)" : "未進入ABW範圍 (TBW/IBW ≤ 1.2)";
                    bwVal = `IBW: ${ibw.toFixed(1)} kg. (${assessment})`;

                    if (!isNaN(n_age) && !isNaN(n_scr) && n_scr > 0) {
                        let weightForCrCl = n_weight;
                        if (n_weight < ibw) weightForCrCl = n_weight;
                        else if (n_weight >= ibw && n_weight <= upperLimit) weightForCrCl = ibw;
                        else weightForCrCl = ibw + 0.4 * (n_weight - ibw); // AdjBW
                        let crcl = ((140 - n_age) * weightForCrCl) / (72 * n_scr);
                        if (sex === 'Female') crcl *= 0.85;
                        crclVal = `CrCl (C-G): ${crcl.toFixed(1)} mL/min`;
                    }
                }
            } catch (e) { console.error("CrCl calculation error:", e) }
            return { crcl: crclVal, bw: bwVal };
        }

        function getCha2ds2vascString(age, sex, chf, ht, dm, stroke, vd) {
            try {
                let score = 0;
                const n_age = parseFloat(age);
                if (isNaN(n_age)) return "CHA₂DS₂-VASc: 無資料 (缺年齡)";
                if (n_age >= 75) score += 2;
                else if (n_age >= 65) score += 1;
                if (sex === 'Female') score += 1;
                if (chf) score += 1;
                if (ht) score += 1;
                if (dm) score += 1;
                if (stroke) score += 2;
                if (vd) score += 1;
                return `CHA₂DS₂-VASc: ${score} 分`;
            } catch (e) { return "CHA₂DS₂-VASc: 無資料"; }
        }

        function getBsaString(weight, height) {
            try {
                const n_weight = parseFloat(weight);
                const n_height = parseFloat(height);
                if (!isNaN(n_weight) && !isNaN(n_height) && n_weight > 0 && n_height > 0) {
                    const bsa = Math.sqrt((n_height * n_weight) / 3600);
                    return `BSA (Mosteller): ${bsa.toFixed(2)} m²`;
                }
            } catch (e) { /* */ }
            return "BSA (Mosteller): 無資料 (缺Ht/BW)";
        }

        function getCkdEpiString(age, scr, sex) {
            try {
                const n_age = parseFloat(age);
                const n_scr = parseFloat(scr);
                if (isNaN(n_age) || isNaN(n_scr) || n_scr <= 0) return "eGFR (CKD-EPI): 無資料 (缺Age/SCr)";
                let kappa = (sex === 'Female') ? 0.7 : 0.9;
                let alpha = (sex === 'Female') ? -0.241 : -0.302;
                let sexFactor = (sex === 'Female') ? 1.012 : 1;
                let eGFR = 142 * Math.pow(Math.min(n_scr / kappa, 1), alpha) * Math.pow(Math.max(n_scr / kappa, 1), -1.200) * Math.pow(0.9938, n_age) * sexFactor;
                return `eGFR (CKD-EPI): ${eGFR.toFixed(1)} mL/min/1.73m²`;
            } catch (e) { return "eGFR (CKD-EPI): 無資料"; }
        }

        function getChildPughString(ascites, enceph, bili, alb, inr) {
            try {
                let score = parseInt(ascites) + parseInt(enceph) + parseInt(bili) + parseInt(alb) + parseInt(inr);
                if (isNaN(score)) return "Child-Pugh: 無資料";
                let grade = "";
                if (score >= 5 && score <= 6) grade = "A (5-6 分)";
                else if (score >= 7 && score <= 9) grade = "B (7-9 分)";
                else if (score >= 10 && score <= 15) grade = "C (10-15 分)";
                return `Child-Pugh: ${grade}`;
            } catch (e) { return "Child-Pugh: 無資料"; }
        }

        // === v18.0: 儀表板 - 自動解析與計算 ===
        function parseAndAutoCalculate(text) {
            const findVal = (regex) => { const match = text.match(regex); return match ? parseFloat(match[1]) : null; };
            const findStr = (regex) => { const match = text.match(regex); return match ? match[1].toUpperCase() : null; }
            const regex = {
                sex: /(?:sex|性別)\s*[:：=\s]\s*(M|F|Male|Female|男|女)/i,
                sexStandalone: /\b(female|male|F|M|男|女)\b/i,
                age: /(?:age|年齡)\s*[:：=\s]\s*(\d{1,3})/i,
                ageYo: /(\d{1,3})\s*y\s*\/?\s*o/i,
                weight: /(?:weight|BW|體重)\s*[:：=\s]\s*(\d{1,3}(?:\.\d{1,2})?)\s*k?g/i,
                weightKg: /\b(\d{1,3}(?:\.\d{1,2})?)\s*k?g\b/i,
                height: /(?:height|身高)\s*[:：=\s]\s*(\d{1,3}(?:\.\d{1,2})?)\s*c?m/i,
                heightCm: /\b(\d{1,3}(?:\.\d{1,2})?)\s*c?m\b/i,
                scr: /(?:SCr|Crea|Creatinine|Cr)\s*[:：=\s]\s*(?!.*\([\d\/-]+\))(\d{1,2}(?:\.\d{1,3})?)/i, // v19.2: 排除有日期的 (?!...)
                chf: /\b(CHF|心衰|Heart Failure)\b/i,
                ht: /\b(HTN|HT|高血壓|Hypertension)\b/i,
                dm: /\b(DM|Diabetes|糖尿病)\b/i,
                stroke: /\b(Stroke|TIA|CVA)\b/i,
                vd: /\b(Vascular Disease|PVD|MI|CAD)\b/i,
                egfr: /(?:eGFR|CKD-EPI)\s*[:：=\s]\s*(\d{1,3}(?:\.\d{1,2})?)/i,
                crcl: /(?:CrCl|C-G)\s*[:：=\s]\s*(\d{1,3}(?:\.\d{1,2})?)/i,
                bsa: /BSA\s*[:：=\s]\s*(\d{1,2}(?:\.\d{1,2})?)/i,
                cha2ds2vasc: /(?:CHA₂DS₂-VASc|CHADS-VASc)\s*(?:score)?\s*[:：=\s]\s*(\d{1,2})\s*(?:分|point|points)?/i,
                childPugh: /(?:Child-Pugh|Child's)\s*(?:score|grade)?\s*[:：=\s]\s*([ABC])\b/i
            };
            let parsed = {
                sexStr: findStr(regex.sex) || findStr(regex.sexStandalone),
                age: findVal(regex.age) || findVal(regex.ageYo),
                weight: findVal(regex.weight) || findVal(regex.weightKg),
                height: findVal(regex.height) || findVal(regex.heightCm),
                scr: findVal(regex.scr),
                chf: text.match(regex.chf),
                ht: text.match(regex.ht),
                dm: text.match(regex.dm),
                stroke: text.match(regex.stroke),
                vd: text.match(regex.vd),
            };
            let sex = 'Male';
            if (parsed.sexStr) { if (parsed.sexStr.startsWith('F') || parsed.sexStr === '女') sex = 'Female'; }
            let preCalculated = {
                egfr: findVal(regex.egfr),
                crcl: findVal(regex.crcl),
                bsa: findVal(regex.bsa),
                cha2ds2vasc: findVal(regex.cha2ds2vasc),
                childPugh: findStr(regex.childPugh)
            };
            let results = [];
            if (preCalculated.crcl) {
                results.push(`CrCl (C-G): ${preCalculated.crcl.toFixed(1)} mL/min (來自原文)`);
            } else {
                const { crcl } = getCrClBwString(parsed.age, parsed.weight, parsed.height, parsed.scr, sex);
                results.push(crcl);
            }
            const { bw } = getCrClBwString(parsed.age, parsed.weight, parsed.height, parsed.scr, sex);
            results.push(bw);
            if (preCalculated.egfr) {
                results.push(`eGFR (CKD-EPI): ${preCalculated.egfr.toFixed(1)} mL/min/1.73m² (來自原文)`);
            } else {
                results.push(getCkdEpiString(parsed.age, parsed.scr, sex));
            }
            if (preCalculated.bsa) {
                results.push(`BSA (Mosteller): ${preCalculated.bsa.toFixed(2)} m² (來自原文)`);
            } else {
                results.push(getBsaString(parsed.weight, parsed.height));
            }
            if (preCalculated.cha2ds2vasc) {
                results.push(`CHA₂DS₂-VASc: ${preCalculated.cha2ds2vasc} 分 (來自原文)`);
            } else {
                results.push(getCha2ds2vascString(parsed.age, sex, parsed.chf, parsed.ht, parsed.dm, parsed.stroke, parsed.vd));
            }
            if (preCalculated.childPugh) {
                results.push(`Child-Pugh: ${preCalculated.childPugh} 級 (來自原文)`);
            } else {
                results.push("Child-Pugh: 無資料 (請手動計算)");
            }
            return results;
        }
        
        // === v21.2: NEW Charting Functions (Dynamic Keywords + Full Gantt Label) ===
        
        // 銷毀所有現存的圖表
        function destroyActiveCharts() {
            Object.values(activeCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            activeCharts = {};
            labChartsGoHere.innerHTML = ''; // 清空 Lab 容器
        }

        // v20.0: 輔助函式 - 將 '10/1' 或 '114/10/1' 轉換為 JS Date 物件
        function parseChartDate(dateString) {
            const parts = dateString.split(/[\/-]/);
            let year, month, day;

            if (parts.length === 3) { // 格式為 Y/M/D (例如 114/10/1 或 2025/10/1)
                year = parseInt(parts[0]);
                month = parseInt(parts[1]) - 1; // JS 月份從 0 開始
                day = parseInt(parts[2]);
                if (year < 200) { // 假設是民國年
                    year += 1911;
                }
            } else if (parts.length === 2) { // 格式為 M/D (例如 10/1)
                year = new Date().getFullYear(); // 預設為今年
                month = parseInt(parts[0]) - 1;
                day = parseInt(parts[1]);
            } else {
                return null; // 無法解析的格式
            }
            
            const date = new Date(year, month, day);
            
            // 處理跨年份問題 (例如：現在 1 月，但日期是 12/25，應視為去年)
            const today = new Date();
            if (parts.length === 2 && (date.getMonth() > today.getMonth() + 1) ) { // 如果日期月份遠大於今天 (例如 1月 vs 12月)
                date.setFullYear(year - 1); // 視為去年
            }
            return date;
        }

        // v21.2: Lab 解析器 (動態關鍵字)
        function parseLabDataForChart(text) {
            const labData = {};
            const lines = text.split('\n');
            const pointRegex = /(\d+(?:\.\d+)?)\s*.*?\s*\(?([\d\.\/-]+)\)?/g; // 彈性數值 + 日期
            // v21.2: 修正: 排除甘特圖的 Regex 應該更精確
            const ganttRegex = /^\s*.*?(\([\d\.\/-]+\s*-\s*[\d\.\/-]+\))/; // 只要看到 (日期-日期) 就排除

            lines.forEach(line => {
                if (ganttRegex.test(line)) return; // 這是甘特圖資料，跳過

                const parts = line.split(/[:：]/);
                if (parts.length < 2) return; 

                const labName = parts[0].trim(); // v21.1: 接受任何關鍵字，例如 "Glucose (AC)"
                const dataString = parts[1];

                if (!labName) return; // 如果關鍵字為空 (例如空行)，跳過

                if (!labData[labName]) {
                    labData[labName] = { labels: [], data: [] };
                }

                let pointMatch;
                while ((pointMatch = pointRegex.exec(dataString)) !== null) {
                    const value = parseFloat(pointMatch[1]);
                    const dateStr = pointMatch[2];
                    const dateObj = parseChartDate(dateStr);
                    
                    if (!isNaN(value) && dateObj) {
                        labData[labName].labels.push(dateObj); // 儲存 Date 物件
                        labData[labName].data.push(value);
                    }
                }
            });
            return labData;
        }
        
        // v21.2: Gantt 解析器 (真正修正版)
        function parseMedDataForGantt(text) {
            const medData = { labels: [], data: [], colors: [] };
            const lines = text.split('\n');
            
            // v21.2 *** BUG FIX ***
            // 1: 藥物名稱 (含劑量) - 貪婪模式
            // 2: 起始日 
            // 3: 結束日
            // \s* 允許行首有空格
            // \s* 允許括號前 "沒有" 或 "有" 空格
            // 修正了 (.*?) 和 \s* 貪婪/非貪婪衝突的 BUG
            const medRegex = /^\s*(.+?)\s*\(?([\d\.\/-]+)\s*-\s*([\d\.\/-]+)\)?\s*$/i; 
            
            const colorPalette = ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899', '#F97316', '#06B6D4', '#D946EF'];
            let colorIndex = 0;

            lines.forEach(line => {
                if (!line.trim()) return; // 跳過空行
                
                // v21.2 BUG FIX: 檢查是否 *不像* Lab 數據
                // 如果它 *沒有* : 分隔符號， *且* 它 *有* (日期-日期) 格式，它才是 Gantt
                const ganttFormatRegex = /\([\d\.\/-]+\s*-\s*[\d\.\/-]+\)/;
                if (!ganttFormatRegex.test(line)) {
                    return; // 如果沒有 (日期-日期) 格式，就跳過
                }

                const match = line.match(medRegex);
                
                if (match) {
                    const medName = match[1].trim().replace(/[:：]$/, ''); // 抓取括號前的所有文字
                    const startDate = parseChartDate(match[2]);
                    let endDate = parseChartDate(match[3]);
                    
                    if (medName && startDate && endDate) {
                        if (endDate < startDate) {
                            endDate.setFullYear(endDate.getFullYear() + 1);
                        }
                        endDate.setDate(endDate.getDate() + 1); 

                        medData.labels.push(medName);
                        medData.data.push([startDate, endDate]);
                        medData.colors.push(colorPalette[colorIndex % colorPalette.length]);
                        colorIndex++;
                    }
                }
            });
            return medData;
        }


        // 渲染 Lab 圖表
        function renderLabCharts(labData) {
            let chartsCreated = 0;
            labChartsGoHere.innerHTML = ''; // 清空 Lab 容器

            Object.keys(labData).forEach(labName => {
                const chartData = labData[labName];
                if (chartData.data.length > 1) { // 至少 2 個點
                    const canvasId = `chart_lab_${labName.replace(/[\s\(\)+]/g, '_')}`; // v21.0: 移除名稱中的特殊字元
                    const canvasEl = document.createElement('canvas');
                    canvasEl.id = canvasId;
                    canvasEl.style.maxHeight = '250px'; 
                    canvasEl.style.marginTop = '1rem';
                    labChartsGoHere.appendChild(canvasEl);
                    
                    const ctx = canvasEl.getContext('2d');
                    const newChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: labName,
                                data: chartData.data.map((value, index) => ({ x: chartData.labels[index], y: value })),
                                fill: false,
                                borderColor: '#' + (Math.random().toString(16) + '000000').substring(2,8),
                                tension: 0.1,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointBackgroundColor: 'white'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${labName} 趨勢圖`,
                                    font: { size: 16 }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time', 
                                    time: {
                                        unit: 'day',
                                        tooltipFormat: 'MM/dd',
                                        displayFormats: { day: 'MM/dd' }
                                    },
                                    title: { display: true, text: '日期' }
                                },
                                y: { beginAtZero: false }
                            }
                        }
                    });
                    activeCharts[canvasId] = newChart; // v21.0: 存入物件
                    chartsCreated++;
                }
            });

            if (chartsCreated > 0) {
                labChartsContainer.classList.remove('hidden');
                noLabChartMessage.classList.add('hidden');
            } else {
                labChartsContainer.classList.add('hidden');
                noLabChartMessage.classList.remove('hidden');
            }
            return chartsCreated;
        }
        
        // v21.2: 渲染用藥史甘特圖 (*** 修正 autoSkip ***)
        function renderGanttChart(medData) {
            if (activeCharts['gantt']) {
                activeCharts['gantt'].destroy(); // v21.0: 銷毀舊的甘特圖
            }

            if (medData.data.length > 0) {
                ganttChartContainer.classList.remove('hidden');
                noGanttChartMessage.classList.add('hidden');
                
                const ctx = ganttChartCanvas.getContext('2d');
                
                // v21.1: 數據結構
                const chartData = medData.labels.map((label, index) => ({
                    x: medData.data[index],
                    y: label
                }));

                const newChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        // labels: medData.labels, // <-- v21.1: 移除
                        datasets: [{
                            label: '用藥期間',
                            data: chartData, // <-- v21.1: 使用新的物件陣列
                            backgroundColor: medData.colors,
                            barPercentage: 0.6,
                        }]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false, 
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: '用藥史甘特圖',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'MM/dd',
                                    displayFormats: { day: 'MM/dd' }
                                },
                                min: new Date(Math.min(...medData.data.map(d => d[0]))),
                                title: { display: true, text: '日期' }
                            },
                            // v21.2 *** BUG FIX ***: 
                            // 解決 2 筆資料時標籤消失的問題
                            y: {
                                type: 'category',
                                // labels: medData.labels, // Chart.js v4 已不需要
                                ticks: {
                                    autoSkip: false // ✅ 關閉自動略過
                                }
                            }
                        }
                    }
                });
                
                const barHeight = 30;
                ganttChartCanvas.style.height = `${(medData.labels.length * barHeight) + 60}px`;
                newChart.resize();
                
                activeCharts['gantt'] = newChart; // v21.0: 存入物件
                return 1;
            } else {
                ganttChartContainer.classList.add('hidden');
                noGanttChartMessage.classList.remove('hidden');
                return 0;
            }
        }
        
        // v21.0: 總包裝函式 (讀取兩個欄位)
        function parseAndRenderCharts(labText, medText) {
            destroyActiveCharts(); // 永遠先清空
            if ((!labText || labText.trim() === "") && (!medText || medText.trim() === "")) {
                chartsContainer.classList.add('hidden'); // 如果兩個欄位都空的，隱藏圖表區
                return;
            }
            
            try {
                const labData = parseLabDataForChart(labText);
                const medData = parseMedDataForGantt(medText);
                
                const labChartsCreated = renderLabCharts(labData);
                const ganttChartsCreated = renderGanttChart(medData);
                
                if (labChartsCreated > 0 || ganttChartsCreated > 0) {
                    chartsContainer.classList.remove('hidden');
                    if (labChartsCreated === 0) {
                        labChartsContainer.classList.add('hidden');
                        noLabChartMessage.classList.remove('hidden');
                    }
                    if (ganttChartsCreated === 0) {
                        ganttChartContainer.classList.add('hidden');
                        noGanttChartMessage.classList.remove('hidden');
                    }
                } else {
                    // 如果兩個欄位都有字，但都沒解析出數據
                    chartsContainer.classList.remove('hidden');
                    labChartsContainer.classList.add('hidden');
                    ganttChartContainer.classList.add('hidden');
                    noLabChartMessage.classList.remove('hidden');
                    noGanttChartMessage.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error("製圖時發生錯誤:", error);
                chartsContainer.classList.remove('hidden');
                labChartsContainer.classList.add('hidden');
                ganttChartContainer.classList.add('hidden');
                noLabChartMessage.textContent = `製圖時發生錯誤: ${error.message}`;
                noLabChartMessage.classList.remove('hidden');
                noGanttChartMessage.classList.add('hidden');
            }
        }

        // === v18.1: 清空函式 (v21.0 更新) ===
        function clearSoapInputs() {
            patientInfoInput.value = '';
            labDataInput.value = ''; // v21.0
            medDataInput.value = ''; // v21.0
            specialtyFocusSelect.value = '';
            uptodateInfoInput.value = '';
            micromedexInfoInput.value = '';
            openevidenceInfoInput.value = '';
            nhiGuidelinesInfoInput.value = '';
            termsCheckbox.checked = false;
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearSoapOutputs();
        }
        
        function clearSoapOutputs() {
            outputDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            infoBox.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';
            copyButton.disabled = true;
            autoCalcDisplay.classList.add('hidden');
            autoCalcList.innerHTML = '';
            
            // v19.0: 清除圖表
            destroyActiveCharts();
            chartsContainer.classList.add('hidden');
            noLabChartMessage.classList.add('hidden');
            noGanttChartMessage.classList.add('hidden');
        }

        // === v18.1: 核心 API 呼叫 (不變) ===
        
        // 呼叫 Gemini
        async function callGeminiAPI(systemPrompt, userPrompt, useSearch = true) {
            const apiKey = appSettings.apiKeys.gemini;
            if (apiKey === "") {
                throw new Error("Gemini API 金鑰尚未設定。");
            }
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: useSearch ? [{ "googleSearch": {} }] : []
            };
            
            const apiUrl = `${geminiApiUrlBase}${geminiModelName}:generateContent?key=${apiKey}`;

            let retries = 3;
            let delay = 1000;
            
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorBody = "無法讀取錯誤詳情";
                        try {
                            const errJson = await response.json();
                            errorBody = errJson.error?.message || JSON.stringify(errJson);
                            if (errorBody.includes("API key not valid")) errorBody = "Gemini API 金鑰無效。";
                            if (response.status === 404) errorBody = `Gemini 模型 "${geminiModelName}" 未找到。`;
                        } catch (e) { /* 忽略 */ }
                        throw new Error(`Gemini HTTP 錯誤! 狀態: ${response.status}. 詳情: ${errorBody}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        if (useSearch && candidate.groundingMetadata?.groundingAttributions) {
                            sources = candidate.groundingMetadata.groundingAttributions
                                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources }; 
                    } else {
                        console.error("Gemini API 回應格式錯誤:", result);
                        let errorMsg = "Gemini API 回應格式不正確。";
                        if (candidate?.finishReason === "SAFETY") errorMsg = "內容可能違反安全政策而被阻擋。";
                        else if (result.promptFeedback?.blockReason) errorMsg = `請求被阻擋：${result.promptFeedback.blockReason}`;
                        else if (!candidate) errorMsg = "API 未返回有效的候選答案 (可能已過載)。";
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error(`API 呼叫失敗 (剩下 ${retries - 1} 次重試):`, error);
                    retries--;
                    if (retries === 0) {
                        throw new Error(error.message === "Failed to fetch" ? "Load failed (網路連線失敗)" : error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // 呼叫 Grok (v18.1)
        async function callGrokAPI(systemPrompt, userPrompt) {
            const apiKey = appSettings.apiKeys.grok;
            if (apiKey === "") {
                throw new Error("Grok API 金鑰尚未設定。");
            }
            
            const payload = {
                model: grokModelName,
                messages: [
                    { "role": "system", "content": systemPrompt },
                    { "role": "user", "content": userPrompt }
                ],
            };
            
            const apiUrl = grokApiUrlBase;
            
            let retries = 3;
            let delay = 1000;
            
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorBody = "無法讀取錯誤詳情";
                        try {
                            const errJson = await response.json();
                            errorBody = errJson.error?.message || JSON.stringify(errJson);
                            if (response.status === 401) errorBody = "Grok API 金鑰無效或未授權。";
                        } catch (e) { /* 忽略 */ }
                        throw new Error(`Grok HTTP 錯誤! 狀態: ${response.status}. 詳情: ${errorBody}`);
                    }

                    const result = await response.json();
                    const text = result.choices?.[0]?.message?.content;

                    if (text) {
                        return { text, sources: [] };
                    } else {
                        console.error("Grok API 回應格式錯誤:", result);
                        let errorMsg = "Grok API 回應格式不正確。";
                        if (result.choices?.[0]?.finish_reason === "safety") errorMsg = "內容可能違反安全政策而被阻擋。";
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error(`API 呼叫失敗 (剩下 ${retries - 1} 次重試):`, error);
                    retries--;
                    if (retries === 0) {
                        throw new Error(error.message === "Failed to fetch" ? "Load failed (網路連線失敗)" : error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // === v18.1: 事件監聽器 (Event Listeners) ===

        // 頁面載入時
        document.addEventListener('DOMContentLoaded', () => {
            loadAppSettings();      // 載入 localStorage
            updateSettingsUI();     // 更新「設定」頁面的 UI 狀態
            renderProjectList();    // 渲染「主頁」的專案列表
            fetchReadme();          // 抓取 GitHub README
            showView('home');       // 預設顯示主頁
            
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');

            // v21.1: 即時繪圖
            let chartTimer;
            const debounceRender = () => {
                clearTimeout(chartTimer);
                chartTimer = setTimeout(() => {
                    parseAndRenderCharts(labDataInput.value, medDataInput.value);
                }, 500); // 停止輸入 500ms 後才繪圖
            };
            labDataInput.addEventListener('input', debounceRender);
            medDataInput.addEventListener('input', debounceRender);
        });

        // v18.1: 導覽列
        navButtons.home.addEventListener('click', () => {
            renderProjectList(); // 每次返回主頁時，都重新整理專案列表
            showView('home');
        });
        navButtons.soapNote.addEventListener('click', () => {
            if (!currentProjectId) {
                createNewProject(); // 如果是點擊頂部 Nav，一律視為開新專案
            }
            showView('soapNote');
        });
        navButtons.calculator.addEventListener('click', () => showView('calculator'));
        navButtons.settings.addEventListener('click', () => showView('settings'));
        
        // v18.1: 主頁上的捷徑
        navSettingsShortcut.addEventListener('click', () => showView('settings'));
        navSoapNoteShortcut.addEventListener('click', () => {
            createNewProject(); // 主頁上的「開始工作」= 開新專案
        });
        newProjectButton.addEventListener('click', createNewProject);

        // v18.1: 設定頁面
        saveSettingsButton.addEventListener('click', saveApiKeysToStorage);
        
        // v18.1: SOAP 筆記頁面 - 專案管理
        saveProjectButton.addEventListener('click', saveCurrentProject);
        saveAsProjectButton.addEventListener('click', saveAsNewProject);
        deleteProjectButton.addEventListener('click', deleteCurrentProject);

        // v18.1: SOAP 筆記頁面 - AI 核心
        termsCheckbox.addEventListener('change', () => {
            generateButton.disabled = !termsCheckbox.checked;
            if (termsCheckbox.checked) {
                generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
            } else {
                generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            }
        });
        
        // v18.0: 手動計算機頁面
        manual_calculateCrClBwButton.addEventListener('click', () => {
            const age = manual_calcAge.value;
            const weight = manual_calcWeight.value;
            const height = manual_calcHeight.value;
            const scr = manual_calcScr.value;
            const sex = manual_calcSex.value;
            const { crcl, bw } = getCrClBwString(age, weight, height, scr, sex);
            setCalcResult(manual_crclResult, crcl);
            setCalcResult(manual_bwResult, bw);
        });
        manual_calculateCha2ds2vascButton.addEventListener('click', () => {
            const age = manual_c2vAgeGreater75.checked ? 75 : (manual_c2vAge65_74.checked ? 65 : 64);
            const sex = manual_c2vSexFemale.checked ? 'Female' : 'Male';
            const result = getCha2ds2vascString(
                age, sex,
                manual_c2vChf.checked, manual_c2vHt.checked, manual_c2vDm.checked,
                manual_c2vStroke.checked, manual_c2vVd.checked
            );
            setCalcResult(manual_cha2ds2vascResult, result);
        });
        manual_calculateBsaButton.addEventListener('click', () => {
             const result = getBsaString(manual_calcWeight.value, manual_calcHeight.value);
             setCalcResult(manual_calcBsaResult, result);
        });
        manual_calculateCkdEpiButton.addEventListener('click', () => {
            const result = getCkdEpiString(manual_calcAge.value, manual_calcScr.value, manual_calcSex.value);
            setCalcResult(manual_calcCkdEpiResult, result);
        });
        manual_calculateChildPughButton.addEventListener('click', () => {
            const result = getChildPughString(
                document.querySelector('input[name="manual_cpAscites"]:checked').value,
                document.querySelector('input[name="manual_cpEnceph"]:checked').value,
                document.querySelector('input[name="manual_cpBili"]:checked').value,
                document.querySelector('input[name="manual_cpAlb"]:checked').value,
                document.querySelector('input[name="manual_cpInr"]:checked').value
            );
            setCalcResult(manual_calcChildPughResult, result);
        });

        // v17.4: 指引查詢 (不變)
        queryGuidelinesButton.addEventListener('click', async () => {
            if (appSettings.apiKeys.gemini === "") { // 此功能強制使用 Gemini (因其 Google Search)
                showError("此功能需設定 Google Gemini API 金鑰。");
                return;
            }
            guidelineSpinner.classList.remove('hidden');
            queryGuidelinesButton.disabled = true;
            queryGuidelinesButton.classList.add('opacity-70', 'cursor-not-allowed');
            guidelineList.innerHTML = ''; 
            guidelineListContainer.classList.add('hidden');
            const guidelineQueryPrompt = `您是一位 AI 助手，任務是使用 Google 搜尋來**即時查核**以下常見臨床指引的「最新發布年份」。\n您的回覆必須嚴格遵守以下格式，僅回傳列表，不要有任何前言或結語：\n* [指引名稱] (例如：GINA - Asthma) - [最新年份]\n* [指引名稱] (例如：GOLD - COPD) - [最新年份]\n* [指引名稱] (例如：AHA/ACC - Hypertension) - [最新年份]\n* [指引名稱] (例如：Surviving Sepsis Campaign) - [最新年份]\n* [指引名稱] (例如：IDSA - Skin and Soft Tissue Infections) - [最新年份]\n* [指引名稱] (例如：KDIGO - CKD) - [最新年份]`;
            const userPrompt = "請立即使用 Google 搜尋，幫我查詢 GINA (Asthma), GOLD (COPD), AHA/ACC (Hypertension), Surviving Sepsis Campaign, IDSA (Skin and Soft Tissue Infections), 以及 KDIGO (CKD) 的最新指引發布年份。";
            try {
                const { text } = await callGeminiAPI(guidelineQueryPrompt, userPrompt, true);
                const lines = text.split('\n').filter(line => line.trim().length > 0);
                if (lines.length > 0) {
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        guidelineList.appendChild(li);
                    });
                    guidelineListContainer.classList.remove('hidden');
                } else { throw new Error("AI 未返回有效的列表。"); }
            } catch (error) {
                console.error("查詢指引時發生錯誤:", error);
                guidelineList.innerHTML = `<li class="text-red-600">查詢失敗：${error.message}</li>`;
                guidelineListContainer.classList.remove('hidden');
            } finally {
                guidelineSpinner.classList.add('hidden');
                queryGuidelinesButton.disabled = false;
                queryGuidelinesButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // v21.0: 產生筆記 (*** 核心 ***)
        generateButton.addEventListener('click', async () => {
            if (!termsCheckbox.checked) {
                showError("請先閱讀並勾選同意「使用條款」。");
                return;
            }
            
            const provider = apiProviderSelect.value;
            let activeApiKey = "";
            if (provider === 'gemini') {
                activeApiKey = appSettings.apiKeys.gemini;
            } else if (provider === 'grok') {
                activeApiKey = appSettings.apiKeys.grok;
            }
            
            if (activeApiKey === "") {
                showError(`請先在「設定」頁面設定 ${provider} の API 金鑰。`);
                return;
            }
            
            const patientInfo = patientInfoInput.value;
            if (!patientInfo.trim()) {
                showError("請輸入「病患核心資料」。");
                return;
            }

            // --- UI 狀態更新 (開始) ---
            progressBarContainer.style.display = 'block';
            placeholderDiv.classList.add('animate-pulse');
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearInputsButton.disabled = true;
            
            // v21.0: 清空舊輸出 (保留圖表)
            outputDiv.classList.add('hidden');
            placeholderDiv.classList.remove('hidden');
            infoBox.classList.add('hidden');
            sourcesContainer.classList.add('hidden');
            sourcesList.innerHTML = '';
            copyButton.disabled = true;
            autoCalcDisplay.classList.add('hidden');
            autoCalcList.innerHTML = '';
            
            // *** v21.1: 啟動自動製圖 (從新欄位讀取) ***
            parseAndRenderCharts(labDataInput.value, medDataInput.value);

            // *** v18.0: 啟動自動計算 (從舊欄位讀取) ***
            const autoCalculatedResults = parseAndAutoCalculate(patientInfo);
            autoCalcList.innerHTML = autoCalculatedResults
                .map(res => `<li>${res.includes("無資料") ? `<span class="text-gray-400">${res}</span>` : `<strong>${res}</strong>`}</li>`)
                .join('');
            autoCalcDisplay.classList.remove('hidden');


            // v20.1: 建立 Prompt (強化時序分析 + 嚴格輸出格式)
            const systemPrompt = `您是一位頂尖的臨床藥師，擁有豐富的經驗，並且隨時掌握最新的國際醫療指引。

您的任務是 (v20.1)：
1.  仔細分析使用者在 [病患核心資料] 中提供的資訊 (病史、Lab、用藥等)。

// --- 🚨 第 1.1 點 (v18.2 新增：時序分析) ---
1.1 (極重要) 您必須**特別注意** Lab data (例如 SCr, K+, WBC) 或 Vital Signs 的**「時序性變化」**。
    * 範例：如果資料顯示 \`SCr: 1.2 (10/1) -> 1.5 (10/2) -> 1.3 (10/3)\`。
    * 您**不應**只抓取第一個值 (1.2) 或最後一個值 (1.3)。
    * 您必須在 (A) 中評估這個「先上升再下降」的**趨勢**，例如："病患腎功能於 10/2 出現急性惡化 (SCr 1.5)，目前已改善 (1.3)，但仍需監測..."。
    * 這對於評估 AKI、電解질變化、感染指標 (WBC, CRP) 的治療反應至關重要。
// --- 🚨 結束 ---

2.  自動識別出最相關的主要病症。
3.  (最重要) **使用 Google 搜尋來查找並確認**該病症**「實際的最新指引版本和年份」**。(Grok 模型請使用內建搜尋)
    * 您必須理解，指引**並非每年更新**。

    // --- 🚨 第 3.1 點 (強制優先級) ---
    3.1 在搜尋指引時，您**必須**優先查找並引用以下全球公認的權威來源：
        * **心血管:** ACC/AHA, ESC
        * **腫瘤:** NCCN, ASCO, ESMO
        * **糖尿病/內分泌:** ADA, AACE
        * **胸腔 (COPD/Asthma):** GOLD, GINA
        * **感染:** IDSA
        * **腎臟:** KDIGO
        * **風濕免疫:** ACR, EULAR
        如果**確實無法**在這些來源中找到直接相關的最新指引，才能參考其他信譽良好的來源，但**必須在 (A) 中明確說明**。
    // --- 🚨 結束 ---

4.  (重要) **請分析**病患目前用藥清單中的**潛在藥物交互作用 (DDI)** 或**重複用藥 (Duplicate Therapy)**。
5.  (v14.1) 如果使用者提供了 [專科焦點] (例如 "心臟內科")，您的評估應更側重於該領域。

6.  (v18.0 邏輯) 您**必須**自行從 [病患核心資料] 欄位中抓取 eGFR, Lab, Age, Child-Pugh Grade (如果有提供) 等資訊來進行評估。

7.  (v16.2 新增任務) 如果使用者在 [健保給付規範] 欄位提供了資訊，您**必須**將其作為**最高優先級**的評估項目之一。
    * 您的任務是：**根據病患的診斷、Lab、和計算出的分數 (如 Child-Pugh, CrCl)，嚴格判斷**目前的處方是否符合這些健保規範。
    * 必須在 (A) 或 (P) 中提出您的**明確評估** (例如："符合 OOO 藥物的健保給付條件" 或 "目前 Child-Pugh B，不符合 OOO 給付標準，恐遭核刪")。

8.  (v15.2) 使用者可能會在 [UpToDate 資料], [Micromedex 資料], [OpenEvidence 資料] 欄位提供補充資訊。
9.  (v15.2) 如果第 8 點的欄位「有內容」，您**必須**將這些重點整合到您的 (A) 或 (P) 中，並且**「明确註明來源」**。

10. 根據「SOAP」格式，撰寫一份專業、精確、格式化的藥師筆記草稿 (保留粗體和換行)。

11. 在您的「Assessment (A)」部分：
    * **(v18.2 強制)** **必須包含**您對 Lab data **時序性趨勢**的分析 (參見第 1.1 點)。
    * **(v14.1 強制)** **必須明確提及**您參考的指引名稱與**「實際年份」**。
    * **(v14.1 強制)** **必須引用**該指引中的**「精確原文句子」**來支持您的臨床決策。
    * **必須包含**您對 DDI 或重複用藥的評估。
    * **必須包含**對腎功能 (eGFR 或 CrCl) 的考量與劑量評估 (並結合時序性趨勢)。
    * **(v16.1)** **必須包含**對肝功能 (Child-Pugh Score) 的考量與劑量評估。
    * **(v16.2)** **必須包含**您對健保規範的核對結果 (如果使用者有提供規範)。

12. 在您的「Plan (P)」部分：
    * 您的所有建議都必須**符合**您在 (A) 中提到的最新指引，並且**不得違反** (A) 中提到的健保給付規範。

13. (v18.0 體重邏輯更新) 您**必須**自行從 [病患核心資料] 抓取 Height/Weight，自行評估 IBW/ABW。如果病患體重過胖 (例如 TBW/IBW > 1.2)，您應**建議**使用「調整體重 (Adjusted Body Weight, ABW)」來計算水溶性藥物劑量。

14. (*** v16.2 格式要求 ***)
    * 您的回覆**必須**嚴格遵守此格式：
    [完整的 SOAP 筆記 (S, O, A, P)]
    ---GUIDELINES_USED---
    * [指引 1 名稱] - [年份]
    * [指引 2 名稱] - [年份]
    * [其他參考的 DDI 資料庫或文獻]
    * (v15.2) [若有使用 UpToDate, 請註明]
    * (v15.2) [若有使用 Micromedex, 請註明]
    * (v15.2) [若有使用 OpenEvidence, 請註明]
    * (v16.2) [若有使用 健保給付規範, 請註明]

15. (*** v20.1 格式修正 ***)
    * 您的回覆**必須**直接以 "S:" 或 "Subjective:" 開頭。
    * **嚴格禁止**在 "S:" 之前加入任何前言、註解、思考過程、自我修正 (例如 "Self-correction:...") 或任何非 SOAP 筆記的文字。

16. (*** v21.0 特別指示 ***)
    * AI **不需要**讀取或分析 \`[Lab 數據 (製圖用)]\` 或 \`[用藥史 (甘特圖用)]\` 欄位，那些僅供前端製圖使用。AI 只需要專注於 \`[病患核心資料]\`。

17. (*** v14.4 格式禁止 ***)
    * **禁止**在您的回覆中使用任何 LaTeX 語法。必須直接使用 Unicode 字元 (例如：β, α, °, ≈, mmHg)。`;
            
            const specialtyFocus = specialtyFocusSelect.value;
            const uptodateInfo = uptodateInfoInput.value.trim();
            const micromedexInfo = micromedexInfoInput.value.trim();
            const openevidenceInfo = openevidenceInfoInput.value.trim();
            const nhiGuidelinesInfo = nhiGuidelinesInfoInput.value.trim();

            let userPrompt = `--- 病患核心資料 (必填) START ---\n${patientInfo}\n--- 病患核心資料 END ---\n`;
            // v21.0: 不再傳送 chartingData 給 AI
            if (specialtyFocus) { userPrompt += `\n--- 專科焦點 (選填) ---\n${specialtyFocus}\n`; }
            if (uptodateInfo) { userPrompt += `\n--- UpToDate 資料 (選填) START ---\n${uptodateInfo}\n--- UpToDate 資料 END ---\n`; }
            if (micromedexInfo) { userPrompt += `\n--- Micromedex 資料 (選填) START ---\n${micromedexInfo}\n--- Micromedex 資料 END ---\n`; }
            if (openevidenceInfo) { userPrompt += `\n--- OpenEvidence 資料 (選填) START ---\n${openevidenceInfo}\n--- OpenEvidence 資料 END ---\n`; }
            if (nhiGuidelinesInfo) { userPrompt += `\n--- 健保給付規範 (選填) START ---\n${nhiGuidelinesInfo}\n--- 健保給付規範 END ---\n`; }
            userPrompt += `\n請根據上述所有資訊，使用最新的國際指引產生一份藥師 SOAP 筆記。`;

            try {
                let text = "";
                let sources = [];
                
                if (provider === 'gemini') {
                    const result = await callGeminiAPI(systemPrompt, userPrompt, true);
                    text = result.text;
                    sources = result.sources;
                } else if (provider === 'grok') {
                    const result = await callGrokAPI(systemPrompt, userPrompt);
                    text = result.text;
                    sources = result.sources; // Grok API 標準回傳不含 sources
                }
                
                // --- 處理回傳結果 (同 v17.4) ---
                const delimiter = '---GUIDELINES_USED---';
                let soapNote = text;
                let guidelinesText = '';
                let hasContent = false; 

                if (text.includes(delimiter)) {
                    const parts = text.split(delimiter);
                    soapNote = parts[0].trim();
                    guidelinesText = parts[1].trim();
                }
                
                // LaTeX 清理
                soapNote = soapNote.replace(/\$\$(.*?)\$\$/g, '$1').replace(/\$(.*?)\$/g, '$1')
                                 .replace(/\\text\{(.*?)\}/g, '$1').replace(/\\beta/g, 'β')
                                 .replace(/\\alpha/g, 'α').replace(/\\gamma/g, 'γ')
                                 .replace(/\\delta/g, 'δ').replace(/\\approx/g, '≈')
                                 .replace(/\\circ/g, '°').replace(/\\textdegree/g, '°')
                                 .replace(/\\mmHg/g, 'mmHg').replace(/\\/g, '')
                                 .replace(/\{/g, '').replace(/\}/g, '');
                
                let safeHtml = soapNote.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                safeHtml = safeHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                outputDiv.innerHTML = `<pre>${safeHtml}</pre>`;
                outputDiv.classList.remove('hidden');
                placeholderDiv.classList.add('hidden');
                infoBox.classList.remove('hidden');

                if (guidelinesText) {
                    const lines = guidelinesText.split('\n').filter(line => line.trim().length > 0);
                    lines.forEach(line => {
                        const li = document.createElement('li');
                        li.textContent = line.replace(/^\s*\*\s*/, ''); 
                        li.className = 'text-gray-800 font-semibold'; 
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }

                if (sources && sources.length > 0) { // 主要來自 Gemini
                    if (hasContent) {
                        const separator = document.createElement('li');
                        separator.innerHTML = '<hr class="my-2 border-gray-300">';
                        sourcesList.appendChild(separator);
                    }
                    sourcesTitle.textContent = '引用的指引與參考來源 (來自 Google Search)：';
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = source.uri; a.target = '_blank'; a.rel = 'noopener noreferrer';
                        a.className = 'text-blue-600 hover:underline';
                        a.textContent = source.title || '相關參考文件';
                        li.appendChild(a);
                        sourcesList.appendChild(li);
                    });
                    hasContent = true;
                }
                
                if (hasContent) {
                    sourcesContainer.classList.remove('hidden');
                }
                
                copyButton.disabled = false;

            } catch (error) {
                console.error(`產生 SOAP 筆記時發生錯誤 (${provider}):`, error);
                showError(`無法產生筆記 (${provider})：${error.message}`);
                copyButton.disabled = true;
            } finally {
                progressBarContainer.style.display = 'none';
                placeholderDiv.classList.remove('animate-pulse');
                generateButton.disabled = !termsCheckbox.checked; 
                if (termsCheckbox.checked) {
                    generateButton.classList.remove('opacity-70', 'cursor-not-allowed');
                }
                clearInputsButton.disabled = false;
            }
        });

        // v18.1: 清除按鈕 (Dashboard)
        clearInputsButton.addEventListener('click', () => {
            // 這個按鈕現在只清除輸入，不影響 "專案" 本身
            patientInfoInput.value = '';
            labDataInput.value = ''; // v21.0
            medDataInput.value = ''; // v21.0
            specialtyFocusSelect.value = '';
            uptodateInfoInput.value = '';
            micromedexInfoInput.value = '';
            openevidenceInfoInput.value = '';
            nhiGuidelinesInfoInput.value = '';
            termsCheckbox.checked = false;
            generateButton.disabled = true;
            generateButton.classList.add('opacity-70', 'cursor-not-allowed');
            clearSoapOutputs();
        });

        // v17.4: 複製按鈕 (不變)
        copyButton.addEventListener('click', () => {
            const preElement = outputDiv.querySelector('pre');
            const textToCopy = preElement ? (preElement.textContent || preElement.innerText) : '';
            if (!textToCopy) { showError("沒有內容可以複製。"); return; }
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.textContent = "已複製!";
                    setTimeout(() => { copyButton.textContent = "一鍵複製"; }, 2000);
                } else { showError("複製失敗。"); }
            } catch (err) { showError(`複製失敗：${err.message}`); }
            document.body.removeChild(textArea);
        });

    </script>
    </body>

</html>

lab data製圖部分可以向圖片一樣好看嗎
